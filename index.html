<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>My Wallet V6.0</title>
    <style>
        /* --- æ¨£å¼å€ --- */
        :root { --bg-color: #F8F9FD; --card-bg: #FFFFFF; --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%); --text-main: #2D3748; --text-sub: #718096; --input-bg: #EDF2F7; }
        body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; background-color: var(--bg-color); color: var(--text-main); margin: 0; padding-bottom: 150px; }
        
        /* ç™»å…¥é®ç½© */
        #loginOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #f8f9fd; z-index: 99999; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 30px; box-sizing: border-box; transition: opacity 0.3s; }
        .login-box { width: 100%; max-width: 320px; text-align: center; background: white; padding: 30px; border-radius: 24px; box-shadow: 0 10px 40px rgba(0,0,0,0.1); }
        .login-title { font-size: 22px; font-weight: 800; margin-bottom: 10px; color: #333; }
        .login-input { width: 100%; padding: 15px; background: #edf2f7; border: none; border-radius: 12px; font-size: 24px; text-align: center; outline: none; margin: 20px 0; letter-spacing: 4px; font-weight: bold; }
        .login-btn { width: 100%; padding: 15px; background: var(--primary-gradient); color: white; border: none; border-radius: 12px; font-size: 16px; font-weight: bold; cursor: pointer; transition: 0.2s; }
        .login-btn:active { transform: scale(0.95); }
        .login-btn:disabled { opacity: 0.7; cursor: not-allowed; }
        .error-msg { color: #ff4757; font-size: 13px; margin-top: 15px; min-height: 20px; }

        /* ä¸»ä»‹é¢æ¨£å¼ */
        .hero { padding: 20px 24px; }
        .header-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        
        /* App æ¨™é¡Œå’Œç‰ˆæœ¬è™Ÿç¾¤çµ„ */
        .app-title-group { display: flex; align-items: flex-end; gap: 8px; }
        .app-title { font-size: 24px; font-weight: 800; }
        .app-version {
            font-size: 14px;
            font-weight: 600;
            color: #764ba2; 
            margin-bottom: 2px;
            cursor: pointer; 
        }

        .header-actions { display: flex; align-items: center; gap: 8px; }
        
        /* æœˆä»½é¸æ“‡å™¨èª¿æ•´: ç§»åˆ°æ˜ç´°åˆ—è¡¨å€ */
        select#monthSelector { 
            border: none; 
            background: transparent; 
            font-size: 18px; 
            font-weight: 700; 
            color: var(--text-main); 
            outline: none; 
            margin-left: 10px;
            flex-grow: 1; 
            text-align: right;
        }

        .btn-logout { background: #fff; color: #FF3B30; border: 1px solid #FF3B30; padding: 6px 14px; border-radius: 20px; font-size: 13px; font-weight: 600; cursor: pointer; }
        
        .btn-setting { 
            background: #fff; 
            color: var(--text-main); 
            border: 1px solid #ddd; 
            padding: 6px 14px; 
            border-radius: 20px; 
            font-size: 13px; 
            font-weight: 600; 
            cursor: pointer;
        }

        .total-card { background: var(--primary-gradient); border-radius: 24px; padding: 30px 25px; color: white; box-shadow: 0 20px 25px -5px rgba(102, 126, 234, 0.4); position: relative; overflow: hidden; }
        .card-label { font-size: 13px; opacity: 0.8; letter-spacing: 1px; margin-bottom: 8px; }
        .total-amount { font-size: 42px; font-weight: 700; letter-spacing: -1px; }
        .input-section { padding: 0 24px; margin-top: 10px; }
        .input-group { background: var(--card-bg); border-radius: 20px; padding: 20px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.05); display: flex; flex-direction: column; gap: 15px; }
        .bill-month-row { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; padding-bottom: 12px; margin-bottom: 5px; }
        .bill-month-label { font-size: 14px; color: var(--text-sub); font-weight: 600; }
        select#billMonthInput { border: none; background: #EDF2F7; padding: 6px 12px; border-radius: 8px; font-size: 15px; font-weight: 600; color: var(--text-main); outline: none; }
        .form-row { display: flex; gap: 12px; }
        .form-col { flex: 1; display: flex; flex-direction: column; gap: 5px; position: relative; }
        label { font-size: 12px; color: var(--text-sub); font-weight: 600; margin-left: 4px; }
        input, select.form-select { width: 100%; background: var(--input-bg); border: none; padding: 14px; border-radius: 12px; font-size: 16px; color: var(--text-main); box-sizing: border-box; outline: none; appearance: none; }
        
        .btn-submit { width: 100%; background: var(--text-main); color: white; border: none; padding: 16px; border-radius: 16px; font-size: 16px; font-weight: 600; cursor: pointer; margin-top: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); transition: transform 0.1s; }
        .btn-submit:disabled { opacity: 0.6; }
        
        /* æ˜ç´°åˆ—è¡¨å€ */
        .list-section { padding: 30px 24px; }
        .section-title { 
            font-size: 18px; 
            font-weight: 700; 
            margin-bottom: 15px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center;
        }
        
        .section-title span:first-child { 
            font-size: 18px; 
            font-weight: 700; 
            line-height: 1.2;
        }

        /* åˆ—è¡¨é …ç›® */
        .transaction-item { 
            background: var(--card-bg); border-radius: 16px; padding: 18px; 
            margin-bottom: 12px; 
            display: grid; 
            grid-template-columns: 2fr 1fr auto; 
            gap: 10px;
            align-items: center; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.02); 
        }

        /* éŠ€è¡Œè³‡è¨Šå€ (å·¦å´) */
        .t-info { 
            display: flex; flex-direction: column; 
            gap: 4px; 
            min-width: 150px;
        }
        .t-bank { font-size: 16px; font-weight: 700; color: var(--text-main); }
        
        /* æ¨™ç±¤å€ (æ—¥æœŸ) */
        .tags-row { 
            display: flex; 
            gap: 8px; 
            align-items: center; 
            flex-wrap: wrap; 
        }
        .tag-date { 
            font-size: 11px; 
            padding: 3px 6px; 
            border-radius: 4px; 
            font-weight: 600; 
            display: inline-flex; 
            align-items: center; 
        }
        .tag-bill { color: #5a67d8; background: #ebf8ff; } 
        .tag-payment { color: #38a169; background: #e6fffa; } 
        .t-note { font-size: 13px; color: var(--text-sub); }

        /* é‡‘é¡å€ (å³å´) */
        .t-amount-group { 
            display: flex; 
            align-items: center; 
            justify-content: flex-end; 
            gap: 15px; 
        } 
        .t-amount { font-size: 18px; font-weight: 700; white-space: nowrap; }
        .btn-delete { color: #FF3B30; background: none; border: none; font-size: 1.2rem; cursor: pointer; opacity: 0.7; padding: 0 5px; margin-left: auto; } 
        
        .unlogged { color: #E53E3E; font-weight: 600; font-size: 16px;} 
        .unlogged-bg { background: #fffafa; } 
        .list-message { color: var(--text-sub); text-align: center; padding: 20px; font-size: 15px; }


        /* â”€â”€â”€ Custom Modal Styles (ä¸è®Š) â”€â”€â”€ */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.5); z-index: 999999;
            display: none; justify-content: center; align-items: center;
        }
        .modal-overlay.show { display: flex; }
        .modal-overlay .modal-box {
            background: white; border-radius: 12px;
            padding: 25px; width: 80%; max-width: 400px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            transform: scale(0.9); opacity: 0; transition: all 0.2s ease-in-out;
            max-height: 80vh; overflow-y: auto;
        }
        .modal-overlay.show .modal-box { transform: scale(1); opacity: 1; }
        .modal-title { font-size: 18px; font-weight: 700; color: var(--text-main); margin-bottom: 10px; }
        .modal-message { font-size: 15px; color: #555; margin-bottom: 20px; line-height: 1.5; }
        .modal-actions { display: flex; justify-content: flex-end; gap: 10px; }
        .modal-btn { padding: 10px 18px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: 0.1s; }
        .modal-btn.primary { background: var(--text-main); color: white; }
        .modal-btn.secondary { background: #E2E8F0; color: var(--text-main); }
        .modal-btn.danger { background: #FF3B30; color: white; }
        
        /* è¨­ç½®é¢æ¿å°ˆç”¨ */
        #templateList { margin-top: 15px; }
        .template-item { 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 12px 0; border-bottom: 1px solid #eee;
        }
        .template-name { font-weight: 600; flex-grow: 1; }
        .template-dates { font-size: 12px; color: var(--text-sub); text-align: right; margin-right: 10px; }
        .template-item .btn-delete { font-size: 1rem; padding: 4px 8px; }
    </style>
</head>
<body>

    <div id="loginOverlay">
        <div class="login-box">
            <div class="login-title">å®‰å…¨é–å®š ğŸ”’</div>
            <div style="color:#888; font-size:14px; margin-bottom:10px;">è«‹è¼¸å…¥å¯†ç¢¼ä»¥å­˜å–è³‡æ–™</div>
            <input type="tel" id="passwordInput" class="login-input" placeholder="â€¢â€¢â€¢â€¢" maxlength="8">
            <button id="loginBtn" class="login-btn" onclick="verifyLogin()">è§£é–</button>
            <div id="loginError" class="error-msg"></div>
        </div>
    </div>
    
    <div id="customModal" class="modal-overlay">
        <div class="modal-box">
            <div id="modalTitle" class="modal-title"></div>
            <div id="modalMessage" class="modal-message"></div>
            <div class="modal-actions" id="modalActions">
                </div>
        </div>
    </div>
    
    <div id="settingsModal" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-title">å¸³å–®è³‡æ–™è¨­å®š</div>
            
            <div class="input-group" style="padding: 15px; margin-bottom: 20px;">
                <div class="form-col">
                    <label>éŠ€è¡Œ/å¡åˆ¥åç¨±</label>
                    <input type="text" id="newTemplateBank" placeholder="ä¾‹å¦‚ï¼šä¸­ä¿¡ LinePay">
                </div>
                <div class="form-row">
                    <div class="form-col">
                        <label>çµå¸³æ—¥ (å¹¾è™Ÿ)</label>
                        <input type="number" id="newTemplateBillDate" placeholder="ä¾‹å¦‚ï¼š5">
                    </div>
                    <div class="form-col">
                        <label>æ‰£æ¬¾æ—¥ (å¹¾è™Ÿ)</label>
                        <input type="number" id="newTemplatePaymentDate" placeholder="ä¾‹å¦‚ï¼š20">
                    </div>
                </div>
                <button class="btn-submit" style="margin-top: 5px;" onclick="addTemplate()">ï¼‹ æ–°å¢éŠ€è¡Œ</button>
            </div>
            
            <div class="modal-title" style="margin-top: 30px; border-top: 1px solid #eee; padding-top: 20px;">å·²å„²å­˜çš„éŠ€è¡Œ</div>
            <div id="templateList">
                <div class="list-message" id="templateListLoading">è¼‰å…¥ä¸­...</div>
            </div>

            <div class="modal-actions" style="margin-top: 20px;">
                <button class="modal-btn secondary" onclick="closeSettingsModal()">é—œé–‰</button>
            </div>
        </div>
    </div>

    <div class="hero">
        <div class="header-row">
            <div class="app-title-group">
                <div class="app-title">å¸³å–®ç®¡å®¶</div>
                <span class="app-version" onclick="forceCacheClear()">v6.0.4</span>
            </div>
            <div class="header-actions">
                <button class="btn-setting" onclick="openSettingsModal()">è¨­å®š</button>
                <button class="btn-logout" onclick="logout()">ç™»å‡º</button>
            </div>
        </div>
        <div class="total-card">
            <div class="card-label">æœ¬æœˆç¸½æ”¯å‡º (å·²ç™»éŒ„)</div>
            <div class="total-amount" id="totalAmount">$0</div>
        </div>
    </div>

    <div class="input-section">
        <div class="input-group">
            <div class="bill-month-row">
                <span class="bill-month-label">è¨˜å¸³æœˆä»½</span>
                <select id="billMonthInput"></select>
            </div>
            <div class="form-row">
                <div class="form-col" style="flex: 3;">
                    <label>éŠ€è¡Œ / å¡åˆ¥</label>
                    <select id="bankSelector" class="form-select">
                        <option value="" disabled selected>è«‹é¸æ“‡éŠ€è¡Œ/å¡åˆ¥</option>
                    </select>
                </div>
                <div class="form-col" style="flex: 2;">
                    <label>é‡‘é¡</label>
                    <input type="number" id="amount" inputmode="decimal" placeholder="$0">
                </div>
            </div>
            <div class="form-row">
                <div class="form-col" style="flex: 2;">
                    <label>æ‰£æ¬¾æ—¥ (è‡ªå‹•)</label>
                    <input type="text" id="paymentDateDisplay" value="N/A" disabled style="color:var(--text-sub); background: #eee;">
                </div>
                <div class="form-col" style="flex: 3;">
                    <label>å‚™è¨» (é¸å¡«)</label>
                    <input type="text" id="note" placeholder="æ¶ˆè²»é …ç›®...">
                </div>
            </div>
            <button class="btn-submit" id="submitBtn" onclick="submitData()">ï¼‹ ç¢ºèªè¨˜å¸³</button>
        </div>
    </div>

    <div class="list-section">
        <div class="section-title">
            <span>æ˜ç´°åˆ—è¡¨</span>
            <select id="monthSelector" onchange="filterData()"></select>
            <span style="font-size:12px; font-weight:normal; background:#eee; padding:4px 8px; border-radius:10px;" id="count">0 ç­†éŠ€è¡Œ</span>
        </div>
        <div id="listContainer"></div>
    </div>

<script>
    // ==========================================
    // ğŸ”´ ä½ çš„å°ˆå±¬ç¶²å€ 
    const API_URL = "https://script.google.com/macros/s/AKfycby60jdswu4PguQ0YNMpYdfdOewU-YscwRvOpcVxZhV7KNpwhVzSO7tJ8vNx1fPmw_tjGw/exec";
    // ==========================================

    let allData = []; 
    let allTemplates = []; 
    let USER_PASSWORD = "";

    document.addEventListener('DOMContentLoaded', () => {
        const savedPass = localStorage.getItem('myBillAppPassword');
        
        initMonthDropdown('monthSelector'); 
        initMonthDropdown('billMonthInput');
        setDefaultInputMonth();
        
        if(savedPass) {
            document.getElementById('passwordInput').value = savedPass;
            verifyLogin(true); 
        }
        
        document.getElementById('bankSelector').addEventListener('change', autoFillPaymentDate);
    });
    
    // ----------------------------------------------------------------------
    // æ ¸å¿ƒï¼šè‡ªè¨‚å½ˆçª—ç³»çµ± (ä¸è®Š)
    // ----------------------------------------------------------------------
    function showCustomDialog(title, message, buttons) {
        const modal = document.getElementById('customModal');
        document.getElementById('modalTitle').innerText = title;
        document.getElementById('modalMessage').innerHTML = message;
        const actions = document.getElementById('modalActions');
        actions.innerHTML = ''; 

        buttons.forEach(btn => {
            const button = document.createElement('button');
            button.className = 'modal-btn ' + (btn.class || 'primary');
            button.innerText = btn.text;
            button.onclick = () => {
                modal.classList.remove('show');
                if (btn.action) {
                    btn.action();
                }
            };
            actions.appendChild(button);
        });

        modal.classList.add('show');
    }

    function showCustomAlert(message, title = 'ç³»çµ±æç¤º') {
        showCustomDialog(title, message, [{ text: 'ç¢ºå®š', class: 'primary' }]);
    }

    function showCustomConfirmation(message, title, onConfirm) {
        showCustomDialog(title, message, [
            { text: 'å–æ¶ˆ', class: 'secondary' },
            { text: 'ç¢ºå®š', class: 'primary', action: onConfirm }
        ]);
    }

    // ----------------------------------------------------------------------
    // è¼‰å…¥èˆ‡ç™»å…¥
    // ----------------------------------------------------------------------
    function forceCacheClear() {
        showCustomConfirmation('ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰ App å¿«å–ä¸¦å¼·åˆ¶æ›´æ–°ç‰ˆæœ¬å—ï¼Ÿ (éœ€è¦é‡æ–°ç™»å…¥)', 'å¼·åˆ¶æ›´æ–°', () => {
            localStorage.removeItem('myBillAppPassword');
            location.reload(true); 
        });
    }

    function logout() {
        showCustomConfirmation('ç¢ºå®šè¦ç™»å‡ºå—ï¼Ÿä¸‹æ¬¡éœ€è¦é‡æ–°è¼¸å…¥å¯†ç¢¼ã€‚', 'ç™»å‡ºç¢ºèª', () => {
            localStorage.removeItem('myBillAppPassword');
            USER_PASSWORD = "";
            const overlay = document.getElementById('loginOverlay');
            overlay.style.display = 'flex';
            setTimeout(() => overlay.style.opacity = '1', 50);
            document.getElementById('passwordInput').value = '';
            document.getElementById('loginBtn').disabled = false;
            document.getElementById('loginBtn').innerText = 'è§£é–';
            document.getElementById('listContainer').innerHTML = '';
            document.getElementById('totalAmount').textContent = '$0';
            allData = [];
            allTemplates = [];
        });
    }

    function verifyLogin(isAutoLogin = false) {
        const pass = document.getElementById('passwordInput').value;
        const errorMsg = document.getElementById('loginError');
        const btn = document.getElementById('loginBtn');

        if(!pass) { errorMsg.textContent = 'è«‹è¼¸å…¥å¯†ç¢¼'; return; }

        btn.disabled = true;
        btn.innerText = isAutoLogin ? 'è‡ªå‹•ç™»å…¥ä¸­...' : 'é©—è­‰ä¸­...';
        errorMsg.textContent = '';

        USER_PASSWORD = pass;
        loadData(true); 
    }

    async function loadData(isInitialLogin = false) {
        const container = document.getElementById('listContainer');
        const loginBtn = document.getElementById('loginBtn');

        if (!isInitialLogin) {
            container.innerHTML = '<div class="loading-state">â˜ï¸ æ­£åœ¨é‡æ–°è¼‰å…¥è³‡æ–™...</div>';
        }
        
        const url = `${API_URL}?password=${encodeURIComponent(USER_PASSWORD)}`;

        try {
            const res = await fetch(url);
            const data = await res.json();
            
            if(data.error) { throw new Error(data.error); }
            
            localStorage.setItem('myBillAppPassword', USER_PASSWORD);
            
            if (isInitialLogin) {
                const overlay = document.getElementById('loginOverlay');
                overlay.style.opacity = '0';
                setTimeout(() => { overlay.style.display = 'none'; }, 300);
            }

            allData = data.data.reverse(); 
            allTemplates = data.templates; 
            
            if (data.template_error) {
                showCustomAlert(data.template_error, 'è­¦å‘Š');
            }

            updateTemplateSelector(); 
            filterData(); 
            
            loginBtn.disabled = false;
            loginBtn.innerText = 'è§£é–';

        } catch(err) {
             console.error(err);
             if (isInitialLogin) {
                loginBtn.disabled = false;
                loginBtn.innerText = 'è§£é–';
                const errorMsg = document.getElementById('loginError');
                
                if (err.message && err.message.includes("å¯†ç¢¼")) {
                    errorMsg.textContent = 'âŒ å¯†ç¢¼éŒ¯èª¤';
                    localStorage.removeItem('myBillAppPassword');
                } else if (err.message) {
                    errorMsg.innerHTML = `âš ï¸ é€£ç·šæˆ–å·¥ä½œè¡¨éŒ¯èª¤ï¼š${err.message}`;
                } else {
                    errorMsg.innerHTML = 'âš ï¸ ä¼ºæœå™¨é€£ç·šå¤±æ•—æˆ– GAS å°šæœªéƒ¨ç½²';
                }
             } else {
                container.innerHTML = '<div class="loading-state">âš ï¸ è¼‰å…¥å¤±æ•—</div>';
             }
        }
    }

    // ----------------------------------------------------------------------
    // æ¨¡æ¿ç®¡ç†é‚è¼¯
    // ----------------------------------------------------------------------
    function openSettingsModal() {
        document.getElementById('settingsModal').classList.add('show');
        renderTemplateList();
    }
    
    function closeSettingsModal() {
        document.getElementById('settingsModal').classList.remove('show');
    }

    function renderTemplateList() {
        const container = document.getElementById('templateList');
        container.innerHTML = '';
        
        if (allTemplates.length === 0) {
             container.innerHTML = '<div class="list-message">å°šæœªæ–°å¢ä»»ä½•éŠ€è¡Œ</div>';
             return;
        }

        allTemplates.forEach(t => {
            // ä¿®æ­£ï¼šé–å®šä¸­æ–‡æ¨™é¡Œ
            const bankName = t['éŠ€è¡Œåç¨±'] || t['BankName'] || 'Error: éŠ€è¡Œåç¨± missing';
            const billDate = t['çµå¸³æ—¥'] || t['BillDate'] || 'Error';
            const paymentDate = t['æ‰£æ¬¾æ—¥'] || t['PaymentDate'] || 'Error';

            const div = document.createElement('div');
            div.className = 'template-item';
            div.innerHTML = `
                <span class="template-name">${bankName}</span>
                <span class="template-dates">çµå¸³æ—¥: ${billDate}æ—¥ / æ‰£æ¬¾æ—¥: ${paymentDate}æ—¥</span>
                <button class="btn-delete" onclick="deleteTemplate(${t.templateIndex})">Ã—</button>
            `;
            container.appendChild(div);
        });
    }

    async function addTemplate() {
        const bank = document.getElementById('newTemplateBank').value.trim();
        const billDate = document.getElementById('newTemplateBillDate').value.trim();
        const paymentDate = document.getElementById('newTemplatePaymentDate').value.trim();
        
        if (!bank || !billDate || !paymentDate) {
            showCustomAlert('è«‹å¡«å¯«æ‰€æœ‰æ¬„ä½', 'è¼¸å…¥éŒ¯èª¤');
            return;
        }

        if (isNaN(billDate) || isNaN(paymentDate) || billDate < 1 || billDate > 31 || paymentDate < 1 || paymentDate > 31) {
            showCustomAlert('çµå¸³æ—¥å’Œæ‰£æ¬¾æ—¥å¿…é ˆæ˜¯ 1 åˆ° 31 ä¹‹é–“çš„æ•¸å­—ã€‚', 'è¼¸å…¥éŒ¯èª¤');
            return;
        }


        const btn = document.querySelector('#settingsModal .btn-submit');
        const originalText = btn.innerText;
        btn.disabled = true;
        btn.innerText = 'æ–°å¢ä¸­...';

        // æ³¨æ„ï¼šGAS ç¨‹å¼ç¢¼ V6.0 ä»ç„¶ä»¥è‹±æ–‡ Key å‚³é€ï¼Œä½†æœƒåœ¨ GAS å…§éƒ¨è½‰æ›ã€‚é€™è£¡ç¹¼çºŒæ²¿ç”¨ã€‚
        const templateObj = { 
            password: USER_PASSWORD,
            action: 'template_create',
            BankName: bank, BillDate: billDate, PaymentDate: paymentDate
        };
        
        try {
            await fetch(API_URL, {
                method: 'POST', mode: 'no-cors',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(templateObj)
            });
            
            setTimeout(() => {
                document.getElementById('newTemplateBank').value = '';
                document.getElementById('newTemplateBillDate').value = '';
                document.getElementById('newTemplatePaymentDate').value = '';
                loadData(); 
                btn.disabled = false;
                btn.innerText = originalText;
            }, 500); 

        } catch(e) {
            showCustomAlert('æ–°å¢è«‹æ±‚å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯ã€‚', 'éŒ¯èª¤');
            btn.disabled = false;
            btn.innerText = originalText;
        }
    }

    function deleteTemplate(templateIndex) {
        showCustomConfirmation('ç¢ºå®šè¦åˆªé™¤é€™å€‹éŠ€è¡Œæ¨¡æ¿å—ï¼Ÿ', 'åˆªé™¤ç¢ºèª', async () => {
            const deleteObj = { 
                password: USER_PASSWORD, 
                action: 'template_delete',
                templateIndex: templateIndex
            };
            
            try {
                await fetch(API_URL, {
                    method: 'POST', mode: 'no-cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(deleteObj)
                });
                
                setTimeout(() => {
                    loadData(); 
                }, 500); 

            } catch(e) {
                showCustomAlert('åˆªé™¤è«‹æ±‚å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯ã€‚', 'éŒ¯èª¤');
            }
        });
    }

    // ----------------------------------------------------------------------
    // äº¤æ˜“ç™»éŒ„èˆ‡åˆªé™¤
    // ----------------------------------------------------------------------
    function autoFillPaymentDate() {
        const selectedBankName = document.getElementById('bankSelector').value;
        const paymentDateInput = document.getElementById('paymentDateDisplay');
        
        // ä¿®æ­£ï¼šä½¿ç”¨æ›´ç©©å®šçš„ key è®€å–
        const template = allTemplates.find(t => t['éŠ€è¡Œåç¨±'] === selectedBankName || t.BankName === selectedBankName);

        if (template) {
            const paymentDate = template['æ‰£æ¬¾æ—¥'] || template.PaymentDate;
            paymentDateInput.value = `${paymentDate}æ—¥`;
        } else {
            paymentDateInput.value = 'N/A';
        }
    }
    
    function updateTemplateSelector() {
        const select = document.getElementById('bankSelector');
        select.innerHTML = '<option value="" disabled selected>è«‹é¸æ“‡éŠ€è¡Œ/å¡åˆ¥</option>';

        if (allTemplates.length === 0) {
             select.innerHTML = '<option value="" disabled selected>è«‹å…ˆåœ¨ã€Œè¨­å®šã€ä¸­æ–°å¢éŠ€è¡Œ</option>';
             document.getElementById('paymentDateDisplay').value = 'N/A';
             return;
        }

        allTemplates.forEach(t => {
            // ä¿®æ­£ï¼šä½¿ç”¨æ›´ç©©å®šçš„ key è®€å–
            const bankName = t['éŠ€è¡Œåç¨±'] || t.BankName || 'Error: éŠ€è¡Œåç¨± missing';

            const option = document.createElement('option');
            option.value = bankName;
            option.text = bankName;
            select.appendChild(option);
        });
        
        select.selectedIndex = 0;
        autoFillPaymentDate();
    }

    function submitData() {
        const bank = document.getElementById('bankSelector').value;
        const amount = document.getElementById('amount').value;
        const note = document.getElementById('note').value;
        const targetMonth = document.getElementById('billMonthInput').value; 
        
        const paymentDateDisplay = document.getElementById('paymentDateDisplay').value;
        const paymentDate = paymentDateDisplay.replace('æ—¥', ''); 

        if(!bank || !amount) { showCustomAlert('è«‹é¸æ“‡éŠ€è¡Œä¸¦è¼¸å…¥é‡‘é¡', 'è¼¸å…¥éŒ¯èª¤'); return; } 

        const btn = document.getElementById('submitBtn');
        const originalText = btn.innerText;
        btn.disabled = true;
        btn.innerText = 'åŠ å¯†ä¸Šå‚³ä¸­...';

        document.getElementById('monthSelector').value = targetMonth;

        const tempObj = { 
            password: USER_PASSWORD,
            action: 'post',
            bank, amount: Number(amount), note, paymentDate, month: targetMonth
        };
        
        fetch(API_URL, {
            method: 'POST',
            mode: 'no-cors',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(tempObj)
        }).then(() => {
            
            setTimeout(() => {
                loadData(); 
                btn.disabled = false;
                btn.innerText = originalText;
                document.getElementById('amount').value = '';
                document.getElementById('note').value = '';
                document.getElementById('bankSelector').selectedIndex = 0; 
                autoFillPaymentDate();
            }, 1000); 

        }).catch(() => {
            showCustomAlert('ä¸Šå‚³è«‹æ±‚å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯ã€‚', 'éŒ¯èª¤');
            btn.disabled = false;
            btn.innerText = originalText;
        });
    }

    async function deleteRecord(rowIndex) {
        showCustomConfirmation('ç¢ºå®šè¦åˆªé™¤é€™ç­†äº¤æ˜“ç´€éŒ„å—ï¼Ÿ', 'ç¢ºèªåˆªé™¤', async () => {
            
            const deleteObj = { 
                password: USER_PASSWORD, 
                action: 'delete',
                rowIndex: rowIndex
            };

            const btn = document.getElementById('submitBtn');
            const originalText = btn.innerText;
            btn.disabled = true;
            btn.innerText = 'åˆªé™¤ä¸­...';

            try {
                await fetch(API_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(deleteObj)
                });
                
                setTimeout(() => {
                    loadData(); 
                    btn.disabled = false;
                    btn.innerText = originalText;
                }, 1000); 

            } catch(error) {
                showCustomAlert('åˆªé™¤è«‹æ±‚å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯ã€‚', 'éŒ¯èª¤');
                btn.disabled = false;
                btn.innerText = originalText;
                loadData();
            }
        });
    }


    // ----------------------------------------------------------------------
    // æ˜ç´°åˆ—è¡¨é¡¯ç¤º (Template Driven)
    // ----------------------------------------------------------------------
    function filterData() {
        const selectedMonth = document.getElementById('monthSelector').value;
        const listContainer = document.getElementById('listContainer');
        
        if (allTemplates.length === 0) {
            listContainer.innerHTML = '<div class="list-message">è«‹å…ˆé»æ“Šã€Œè¨­å®šã€æ–°å¢éŠ€è¡Œã€‚</div>';
            document.getElementById('totalAmount').textContent = `$0`;
            document.getElementById('count').textContent = `${allTemplates.length} ç­†éŠ€è¡Œ`;
            return;
        }

        // ç¯©é¸å‡ºç•¶å‰æœˆä»½çš„äº¤æ˜“ç´€éŒ„
        const currentMonthData = allData.filter(item => String(item.month).trim() === selectedMonth);
        
        let totalLoggedAmount = 0;
        let html = '';
        
        allTemplates.forEach(template => {
            // ä¿®æ­£ï¼šé–å®šä¸­æ–‡æ¨™é¡Œ
            const templateBankName = template['éŠ€è¡Œåç¨±'] || template.BankName || 'Error: éŠ€è¡Œåç¨± missing';
            const templateBillDate = template['çµå¸³æ—¥'] || template.BillDate || 'Error';
            const templatePaymentDate = template['æ‰£æ¬¾æ—¥'] || template.PaymentDate || 'Error';
            
            // å°‹æ‰¾æ¨¡æ¿éŠ€è¡Œåœ¨ç•¶æœˆæ˜¯å¦å·²æœ‰ç™»éŒ„ç´€éŒ„
            const matchingRecord = currentMonthData.find(record => record.bank === templateBankName);

            let amountDisplay;
            let infoTags;
            let deleteButton = '';
            
            const billTag = `<span class="tag-date tag-bill">çµå¸³æ—¥: ${templateBillDate}æ—¥</span>`;
            const paymentTag = `<span class="tag-date tag-payment">é è¨ˆæ‰£æ¬¾: ${templatePaymentDate}æ—¥</span>`; 
            
            if (matchingRecord) {
                // å·²ç™»éŒ„ï¼šé¡¯ç¤ºé‡‘é¡ï¼Œå…è¨±åˆªé™¤ï¼Œé¡¯ç¤ºäº¤æ˜“å‚™è¨»
                const loggedAmount = Number(matchingRecord.amount);
                totalLoggedAmount += loggedAmount;
                
                amountDisplay = `<div class="t-amount">$${loggedAmount.toLocaleString()}</div>`;
                deleteButton = `<button class="btn-delete" onclick="deleteRecord(${matchingRecord.rowIndex})">Ã—</button>`;
                
                // é¡¯ç¤ºå¯¦éš›æ‰£æ¬¾æ—¥å’Œå‚™è¨»
                infoTags = `${billTag} <span class="tag-date tag-payment">å¯¦éš›æ‰£æ¬¾: ${matchingRecord.paymentDate}æ—¥</span>`;
                if (matchingRecord.note) {
                    infoTags += `<span class="t-note">å‚™è¨»: ${matchingRecord.note}</span>`;
                }

            } else {
                // æœªç™»éŒ„ï¼šé¡¯ç¤º `-`
                amountDisplay = `<div class="unlogged">-</div>`;
                // åƒ…é¡¯ç¤ºçµå¸³æ—¥å’Œé è¨ˆæ‰£æ¬¾æ—¥
                infoTags = `${billTag} ${paymentTag}`;
            }

            html += `
                <div class="transaction-item">
                    <div class="t-info">
                        <div class="t-bank">${templateBankName}</div>
                        <div class="tags-row">${infoTags}</div>
                    </div>
                    <div class="t-amount-group">
                        ${amountDisplay}
                    </div>
                    ${deleteButton}
                </div>`;
        });
        
        document.getElementById('totalAmount').textContent = `$${totalLoggedAmount.toLocaleString()}`;
        document.getElementById('count').textContent = `${allTemplates.length} ç­†éŠ€è¡Œ`;
        listContainer.innerHTML = html;
    }
    
    // ----------------------------------------------------------------------
    // è¼”åŠ©å‡½å¼ (æ ¼å¼åŒ–ä¿®æ­£ YYYYMM)
    // ----------------------------------------------------------------------
    function setDefaultInputMonth() {
        const inputSelect = document.getElementById('billMonthInput');
        const viewSelect = document.getElementById('monthSelector');
        const date = new Date();
        const val = `${date.getFullYear()}${String(date.getMonth()+1).padStart(2,'0')}`;
        inputSelect.value = val; viewSelect.value = val;
    }
    
    function initMonthDropdown(id) {
        const select = document.getElementById(id);
        const date = new Date();
        date.setMonth(date.getMonth()+1);
        for(let i=0; i<20; i++) {
            const currentMonth = date.getMonth();
            const currentYear = date.getFullYear();
            const val = `${currentYear}${String(currentMonth+1).padStart(2,'0')}`;
            const opt = document.createElement('option'); 
            opt.value = val; 
            opt.text = `${currentYear}å¹´ ${String(currentMonth+1).padStart(2,'0')}æœˆ`;
            select.appendChild(opt); 
            date.setMonth(date.getMonth()-1);
        }
    }
</script>
</body>
</html>
