<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>App Hub V10.0</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* --- V10.0 System Styles --- */
        :root { 
            --bg-body: #F9FAFB; 
            --primary: #4F46E5; 
            --primary-gradient: linear-gradient(135deg, #4F46E5 0%, #7C3AED 100%);
            --text-main: #1F2937; 
            --text-sub: #6B7280; 
            --danger: #EF4444;
            --success: #10B981;
            --warning-bg: #FFF7ED;
            --warning-border: #FED7AA;
            --warning-text: #9A3412;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
        }
        
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; background: var(--bg-body); color: var(--text-main); margin: 0; padding-bottom: 140px; user-select: none; -webkit-user-select: none; }

        /* ğŸŸ¡ å…¨å±€å…ƒä»¶ (Global) */
        .hidden-layer { display: none !important; } /* ç”¨æ–¼åˆ‡æ›é é¢ */
        
        #cloudStatus {
            position: fixed; top: 20px; left: 50%; 
            transform: translateX(-50%) translateY(-200%); opacity: 0;
            background: white; padding: 8px 16px; border-radius: 30px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
            display: flex; align-items: center; gap: 8px;
            font-size: 13px; font-weight: 600; color: var(--text-main);
            z-index: 100000; transition: all 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
            pointer-events: none;
        }
        #cloudStatus.show { transform: translateX(-50%) translateY(0); opacity: 1; }
        #cloudStatus.syncing { color: var(--primary); border: 1px solid #E0E7FF; }
        #cloudStatus.success { color: var(--success); border: 1px solid #D1FAE5; }
        #cloudStatus.error { color: var(--danger); border: 1px solid #FEE2E2; pointer-events: auto; cursor: pointer; }

        .status-icon { width: 16px; height: 16px; display: flex; justify-content: center; align-items: center; }
        .spin-circle { width: 14px; height: 14px; border: 2px solid #E0E7FF; border-top-color: var(--primary); border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-6px); } }

        #loginOverlay { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(249,250,251,0.98); backdrop-filter: blur(5px); z-index: 99999; display: flex; flex-direction: column; justify-content: center; align-items: center; transition: opacity 0.3s; }
        .login-input { width:240px; padding:15px; border:1px solid #E5E7EB; border-radius:16px; font-size:24px; text-align:center; outline:none; margin:20px 0; letter-spacing:8px; background:white; box-shadow: var(--shadow); }
        .login-input:focus { border-color: var(--primary); }

        .btn-icon { background:white; border:1px solid #E5E7EB; padding:8px 12px; border-radius:12px; font-size:13px; font-weight:600; color:#555; box-shadow:0 1px 2px rgba(0,0,0,0.05); transition:0.1s; cursor: pointer; }
        .btn-icon:active { transform:scale(0.95); background: #f3f4f6; }

        .modal-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.5); backdrop-filter: blur(2px); z-index: 10000; display: flex; justify-content: center; align-items: center; opacity: 0; pointer-events: none; transition: opacity 0.2s; }
        .modal-overlay.show { opacity: 1; pointer-events: auto; }
        .modal-box { background: white; width: 85%; max-width: 380px; border-radius: 24px; padding: 0; transform: scale(0.95); transition: 0.2s; max-height: 80vh; display: flex; flex-direction: column; overflow: hidden; }
        .modal-overlay.show .modal-box { transform: scale(1); }
        .modal-header { padding: 24px 24px 15px 24px; flex-shrink: 0; background: white; z-index: 10; }
        .modal-content-scroll { padding: 0 24px; overflow-y: auto; flex: 1; -webkit-overflow-scrolling: touch; }
        .modal-footer { padding: 15px 24px 24px 24px; flex-shrink: 0; background: white; border-top: 1px solid #F3F4F6; }
        .action-btn { display: block; width: 100%; padding: 14px; margin-bottom: 10px; border: none; border-radius: 12px; font-size: 16px; font-weight: 600; cursor: pointer; }
        .btn-edit { background: #F3F4F6; color: var(--text-main); }
        .btn-delete { background: #FEF2F2; color: var(--danger); }
        .setup-row { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid #F3F4F6; }
        .btn-setup-action { border: none; background: none; cursor: pointer; font-size: 14px; padding: 5px; transition: opacity 0.1s, transform 0.1s;}
        .btn-setup-action:active { opacity: 0.6; transform: scale(0.95); }
        #toast { visibility: hidden; background: #333; color: #fff; padding: 12px 24px; border-radius: 50px; position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); z-index: 99999; opacity:0; transition:0.3s; }
        #toast.show { visibility: visible; opacity: 1; bottom: 40px; }

        /* ğŸŸ¡ V10.0 Hub (ä¸»é¸å–®) æ¨£å¼ */
        #app-hub { padding: 20px 24px; animation: fadeIn 0.4s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .hub-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .hub-title { font-size: 28px; font-weight: 800; color: var(--text-main); }
        
        .app-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        
        /* APP å¡ç‰‡ */
        .app-card {
            background: white; border-radius: 24px; padding: 20px;
            box-shadow: var(--shadow); border: 1px solid transparent;
            display: flex; flex-direction: column; justify-content: space-between;
            height: 140px; cursor: pointer; position: relative;
            transition: transform 0.1s, box-shadow 0.1s;
        }
        .app-card:active { transform: scale(0.96); background: #F3F4F6; }
        
        .app-icon { font-size: 32px; margin-bottom: 10px; }
        .app-name { font-size: 16px; font-weight: 700; color: var(--text-main); }
        .app-ver { 
            position: absolute; bottom: 15px; right: 15px; 
            font-size: 11px; color: #9CA3AF; font-weight: 500; 
            background: #F3F4F6; padding: 2px 6px; border-radius: 6px;
        }

        /* ğŸŸ¡ V9.0 Wallet å…§éƒ¨æ¨£å¼ (ç¶­æŒä¸è®Š) */
        #app-wallet { animation: fadeIn 0.3s ease; }
        .hero { padding: 20px 24px 10px 24px; }
        .header-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
        .app-title { font-size: 24px; font-weight: 800; color: #111; }
        
        .total-card { background: var(--primary-gradient); border-radius: 28px; padding: 25px; color: white; box-shadow: 0 20px 25px -5px rgba(79, 70, 229, 0.4); position: relative; overflow: hidden; transition: all 0.3s ease; }
        .total-card::after { content:''; position:absolute; top:-50%; right:-20%; width:250px; height:250px; background:radial-gradient(circle, rgba(255,255,255,0.15), transparent 70%); border-radius:50%; pointer-events:none; }
        .card-content { position: relative; z-index: 2; }
        .total-amount { font-size: 42px; font-weight: 800; margin: 5px 0; letter-spacing: -1px; }
        .status-emoji { position:absolute; top:30px; right:25px; font-size:48px; animation: float 3s ease-in-out infinite; pointer-events: none; z-index: 1; }
        .card-footer { display: flex; justify-content: space-between; align-items: center; margin-top: 5px; }
        .card-sub { font-size: 13px; opacity: 0.8; background: rgba(255,255,255,0.2); padding: 2px 8px; border-radius: 10px; }
        .btn-chart-toggle { background: rgba(255, 255, 255, 0.2); border: 1px solid rgba(255, 255, 255, 0.3); color: white; padding: 6px 12px; border-radius: 20px; font-size: 13px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 5px; backdrop-filter: blur(5px); transition: background 0.2s, transform 0.1s; }
        .btn-chart-toggle:active { background: rgba(255, 255, 255, 0.4); transform: scale(0.95); }
        .chart-drawer { max-height: 0; opacity: 0; overflow: hidden; transition: max-height 0.4s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.3s ease; margin-top: 0; position: relative; z-index: 2; }
        .chart-drawer.open { max-height: 280px; opacity: 1; margin-top: 20px; border-top: 1px solid rgba(255,255,255,0.2); padding-top: 15px; }
        .chart-wrapper { position: relative; height: 200px; width: 100%; display: flex; justify-content: center; }

        .input-panel { margin: 20px 24px 0; padding: 24px; background: white; border-radius: 24px; box-shadow: var(--shadow); border: 1px solid #F3F4F6; }
        .grid-2 { display: grid; grid-template-columns: 1.8fr 1.2fr; gap: 12px; margin-bottom: 12px; }
        .form-label { font-size: 12px; font-weight: 600; color: var(--text-sub); margin-bottom: 6px; display: block; }
        .styled-input { width: 100%; padding: 12px 14px; border-radius: 12px; border: 1px solid #E5E7EB; background: #F9FAFB; font-size: 16px; color: #333; outline: none; -webkit-appearance: none; }
        .styled-input:disabled { background: #E5E7EB; color: #9CA3AF; cursor: not-allowed; }
        .btn-submit { width: 100%; background: #1F2937; color: white; border: none; padding: 15px; border-radius: 14px; font-size: 16px; font-weight: 600; margin-top: 10px; display: flex; justify-content: center; align-items: center; cursor: pointer; transition: transform 0.1s cubic-bezier(0.4, 0, 0.2, 1), background-color 0.2s, box-shadow 0.2s; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .btn-submit:active { transform: scale(0.96); background-color: #000; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .btn-submit:disabled { background: #6B7280; opacity: 0.8; cursor: not-allowed; transform: none; }
        .spinner { width: 18px; height: 18px; margin-right: 8px; border: 2px solid rgba(255,255,255,0.3); border-radius: 50%; border-top-color: #fff; animation: spin 0.8s linear infinite; display: none; }
        .btn-loading .spinner { display: inline-block; }

        .list-section { padding: 30px 24px; }
        .t-card { background: white; border-radius: 18px; padding: 16px; margin-bottom: 12px; display: flex; align-items: center; gap: 14px; box-shadow: var(--shadow); border: 1px solid transparent; position: relative; overflow: hidden; cursor: pointer; transition: transform 0.1s; }
        .t-card:active { transform: scale(0.98); background: #f9fafb; }
        .t-card.logged { border: 1px solid #E5E7EB; }
        .t-card.logged::before { content:''; position:absolute; left:0; top:0; bottom:0; width:5px; background: var(--success); }
        .t-card.unlogged { background: #F9FAFB; border: 1px dashed #D1D5DB; opacity: 0.95; }
        .t-card.unlogged .t-icon { background: #E5E7EB; color: #9CA3AF; }
        .t-icon { width: 42px; height: 42px; border-radius: 12px; background: #F3F4F6; color: #374151; font-size: 18px; font-weight: 700; display: flex; justify-content: center; align-items: center; flex-shrink: 0; }
        .t-content { flex: 1; min-width: 0; }
        .t-bank { font-size: 16px; font-weight: 700; color: var(--text-main); margin-bottom: 4px; }
        .t-amount { font-size: 18px; font-weight: 800; color: var(--text-main); text-align: right; }
        .badge-todo { font-size: 12px; font-weight: 600; color: #6B7280; background: #E5E7EB; padding: 4px 10px; border-radius: 20px; }
        .alert-box { background: var(--warning-bg); border: 1px solid var(--warning-border); color: var(--warning-text); padding: 16px; border-radius: 16px; margin-bottom: 20px; font-size: 14px; line-height: 1.6; display: flex; align-items: flex-start; gap: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.02); }
        .alert-icon { font-size: 20px; margin-top: -2px; }
        .alert-title { font-weight: 700; margin-bottom: 2px; display: block; color: #7C2D12; }
    </style>
</head>
<body>

    <!-- å…¨å±€å…ƒä»¶ -->
    <div id="cloudStatus"><div class="status-icon"><div class="spin-circle"></div></div><span id="cloudText">é›²ç«¯åŒæ­¥ä¸­...</span></div>
    <div id="toast"></div>

    <!-- 1. ç™»å…¥å±¤ -->
    <div id="loginOverlay">
        <div style="font-size:50px; margin-bottom:10px;">ğŸ”’</div>
        <div style="font-weight:800; font-size:22px;">App Hub</div>
        <input type="password" id="passwordInput" class="login-input" placeholder="â€¢â€¢â€¢â€¢" maxlength="8" inputmode="numeric">
        <button id="loginBtn" class="btn-submit" onclick="verifyLogin()" style="width:240px;"><div class="spinner"></div> <span class="btn-text">è§£é–</span></button>
        <div id="loginError" style="color:var(--danger); margin-top:20px; min-height:20px;"></div>
    </div>

    <!-- 2. ä¸»é¸å–® (Hub) -->
    <div id="app-hub" class="hidden-layer">
        <div class="hub-header">
            <div class="hub-title">Apps</div>
            <button class="btn-icon" onclick="logout()" style="color:var(--danger);">ç™»å‡º</button>
        </div>
        
        <div class="app-grid">
            <!-- My Wallet å¡ç‰‡ -->
            <div class="app-card" onclick="openWallet()">
                <div>
                    <div class="app-icon">ğŸ’°</div>
                    <div class="app-name">My Wallet</div>
                </div>
                <div class="app-ver">v9.0</div>
            </div>
            
            <!-- é ç•™çµ¦æœªä¾†çš„ App -->
            <!-- <div class="app-card" style="opacity:0.5; cursor:default;">
                <div><div class="app-icon">ğŸ“</div><div class="app-name">Notes</div></div>
                <div class="app-ver">Coming Soon</div>
            </div> -->
        </div>
    </div>

    <!-- 3. è¨˜å¸³ App å®¹å™¨ (Wallet V9.0) -->
    <div id="app-wallet" class="hidden-layer">
        
        <!-- Modals (Wallet Scoped) -->
        <div id="actionModal" class="modal-overlay">
            <div class="modal-box" style="display:block; padding:24px;">
                <div style="text-align:center; margin-bottom:20px;">
                    <div id="actionTitle" style="font-size:18px; font-weight:800;"></div>
                    <div id="actionSubtitle" style="font-size:14px; color:#6B7280; margin-top:5px;"></div>
                </div>
                <button class="action-btn btn-edit" id="btnActionEdit">âœï¸ ä¿®æ”¹ / å¡«å…¥</button>
                <button class="action-btn btn-delete" id="btnActionDelete">ğŸ—‘ï¸ åˆªé™¤ç´€éŒ„</button>
                <button class="action-btn" style="background:white; color:#888; margin-bottom:0;" onclick="closeModal('actionModal')">å–æ¶ˆ</button>
            </div>
        </div>

        <div id="settingsModal" class="modal-overlay">
            <div class="modal-box">
                <div class="modal-header">
                    <div style="font-size:18px; font-weight:800; margin-bottom:15px;">éŠ€è¡Œè¨­å®š</div>
                    <div style="background:#F9FAFB; padding:15px; border-radius:16px;">
                        <input type="text" id="newBank" class="styled-input" placeholder="éŠ€è¡Œåç¨± (ä¾‹: ä¸­ä¿¡)" style="margin-bottom:10px; background:white;">
                        <div class="grid-2">
                            <input type="number" id="newBill" class="styled-input" placeholder="çµå¸³æ—¥" style="background:white;">
                            <input type="number" id="newPay" class="styled-input" placeholder="æ‰£æ¬¾æ—¥" style="background:white;">
                        </div>
                        <button id="btnAddTemp" class="btn-submit" onclick="addTemplate()" style="padding:10px; font-size:14px;"><div class="spinner"></div><span class="btn-text">ï¼‹ æ–°å¢</span></button>
                    </div>
                    <div style="font-size:12px; color:#999; margin-top:15px; font-weight:700;">å·²å„²å­˜çš„éŠ€è¡Œ</div>
                </div>
                <div class="modal-content-scroll"><div id="templateList"></div></div>
                <div class="modal-footer"><button class="btn-submit" onclick="closeModal('settingsModal')" style="background:#F3F4F6; color:#333; margin-top:0;">é—œé–‰</button></div>
            </div>
        </div>

        <div id="editTemplateModal" class="modal-overlay">
            <div class="modal-box" style="display:block; padding:24px;">
                <div style="font-size:18px; font-weight:800; margin-bottom:15px;">ç·¨è¼¯éŠ€è¡Œè³‡è¨Š</div>
                <input type="hidden" id="editIndex">
                <label class="form-label">éŠ€è¡Œåç¨± (ä¸å¯ä¿®æ”¹)</label>
                <input type="text" id="editBankName" class="styled-input" style="margin-bottom:15px;" disabled>
                <div class="grid-2">
                    <div><label class="form-label">çµå¸³æ—¥</label><input type="number" id="editBill" class="styled-input"></div>
                    <div><label class="form-label">æ‰£æ¬¾æ—¥</label><input type="number" id="editPay" class="styled-input"></div>
                </div>
                <div style="display:flex; gap:10px; margin-top:15px;">
                    <button class="btn-submit" onclick="closeModal('editTemplateModal')" style="background:#F3F4F6; color:#333; margin-top:0;">å–æ¶ˆ</button>
                    <button id="btnSaveEdit" class="btn-submit" onclick="saveTemplateEdit()" style="margin-top:0;"><div class="spinner"></div> <span class="btn-text">å„²å­˜</span></button>
                </div>
                <div style="font-size:12px; color:#999; margin-top:15px; text-align:center;">å¦‚éœ€ä¿®æ”¹éŠ€è¡Œåç¨±ï¼Œè«‹åˆªé™¤å¾Œé‡æ–°æ–°å¢ã€‚</div>
            </div>
        </div>

        <div id="confirmModal" class="modal-overlay">
            <div class="modal-box" style="display:block; padding:24px;">
                <div id="confirmMsg" style="font-size:16px; color:#333; margin-bottom:20px; line-height:1.5;"></div>
                <div style="display:flex; gap:10px; justify-content:flex-end;">
                    <button class="action-btn" style="width:auto; background:#F3F4F6; margin:0;" onclick="closeModal('confirmModal')">å–æ¶ˆ</button>
                    <button class="action-btn" style="width:auto; background:#1F2937; color:white; margin:0;" id="confirmBtnAction">ç¢ºå®š</button>
                </div>
            </div>
        </div>

        <div class="hero">
            <div class="header-row">
                <div><span class="app-title">My Wallet</span> <span style="font-size:12px; background:#E5E7EB; padding:3px 6px; border-radius:6px; color:#555;">V9.0</span></div>
                <div style="display:flex; gap:8px;">
                    <button class="btn-icon" onclick="openSettingsModal()">âš™ï¸ è¨­å®š</button>
                    <!-- ğŸŸ¡ å°èˆªä¿®æ­£ï¼šé€™è£¡æ”¹æˆå›é¦–é  -->
                    <button class="btn-icon" onclick="goHome()" style="color:#4F46E5;">ğŸ  é¦–é </button>
                </div>
            </div>
            <div class="total-card">
                <div class="card-content">
                    <div style="font-size:14px; opacity:0.9;">æœ¬æœˆç¸½æ”¯å‡º</div>
                    <div class="total-amount" id="totalAmount">$0</div>
                    <div class="card-footer">
                        <div class="card-sub" id="countLabel">0 ç­†ç´€éŒ„</div>
                        <button class="btn-chart-toggle" onclick="toggleChart()"><span id="chartBtnIcon">ğŸ“Š</span> <span id="chartBtnText">åˆ†æ</span></button>
                    </div>
                </div>
                <div class="status-emoji" id="emojiStatus">ğŸ˜Š</div>
                <div class="chart-drawer" id="chartDrawer"><div class="chart-wrapper"><canvas id="expenseChart"></canvas></div></div>
            </div>
        </div>

        <div class="input-panel">
            <div style="display:flex; justify-content:space-between; margin-bottom:15px; border-bottom:1px solid #eee; padding-bottom:10px;">
                <span style="font-weight:600; color:#555;">è¨˜å¸³æœˆä»½</span>
                <select id="billMonthInput" style="border:none; font-size:16px; font-weight:700; color:var(--primary); outline:none; background:transparent;"></select>
            </div>
            <div class="grid-2">
                <div><label class="form-label">éŠ€è¡Œ</label><select id="bankSelector" class="styled-input"></select></div>
                <div><label class="form-label">é‡‘é¡</label><input type="number" id="amount" class="styled-input" placeholder="$0"></div>
            </div>
            <label class="form-label">å‚™è¨»</label>
            <input type="text" id="note" class="styled-input" placeholder="é¸å¡«...">
            <button id="submitBtn" class="btn-submit" onclick="submitData()"><div class="spinner"></div> <span class="btn-text">ï¼‹ ç¢ºèªè¨˜å¸³</span></button>
        </div>

        <div class="list-section">
            <div class="list-header" style="display:flex; justify-content:space-between; margin-bottom:15px;">
                <div style="font-size:18px; font-weight:800;">å¸³å–®æ˜ç´°</div>
                <div style="display:flex; gap:10px;">
                    <select id="monthSelector" style="border:none; background:transparent; font-weight:600;" onchange="filterData()"></select>
                    <button onclick="manualReload()" style="border:none; background:white; border-radius:50%; width:30px; height:30px; box-shadow:0 2px 5px rgba(0,0,0,0.1); cursor:pointer;">â†»</button>
                </div>
            </div>
            <div id="alertContainer"></div>
            <div id="listContainer"></div>
        </div>
    </div>

<script>
    // ==========================================
    // ğŸ”´ è«‹æ›¿æ›ç‚ºä½ çš„ GAS API ç¶²å€
    const API_URL = "https://script.google.com/macros/s/AKfycby60jdswu4PguQ0YNMpYdfdOewU-YscwRvOpcVxZhV7KNpwhVzSO7tJ8vNx1fPmw_tjGw/exec";
    // ==========================================

    let allData=[], allTemplates=[], USER_PASSWORD="", expenseChart=null, currentRenderedItems = []; 
    const KEYS = { BANK:'éŠ€è¡Œåç¨±', BILL:'çµå¸³æ—¥', PAY:'æ‰£æ¬¾æ—¥' };
    
    const SyncManager = {
        queue: [], isSyncing: false, totalTasks: 0, completed: 0,
        add: function(payload) { this.queue.push(payload); if (!this.isSyncing) { this.totalTasks = this.queue.length; this.completed = 0; } else { this.totalTasks++; } this.updateUI(); this.process(); },
        updateUI: function() { const pending = this.queue.length; if (pending > 0) { const current = this.totalTasks - pending + 1; CloudStatus.set('syncing', `åŒæ­¥ä¸­ (${current}/${this.totalTasks})...`); } else { CloudStatus.set('success'); this.totalTasks = 0; this.completed = 0; } },
        process: async function() {
            if (this.isSyncing || this.queue.length === 0) return;
            this.isSyncing = true;
            while (this.queue.length > 0) {
                this.updateUI(); const currentTask = this.queue[0];
                try { await fetch(API_URL, { method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ ...currentTask, password: USER_PASSWORD }) }); this.queue.shift(); this.completed++; await new Promise(r => setTimeout(r, 300)); } 
                catch (e) { console.error("Sync Failed:", e); CloudStatus.set('error'); this.isSyncing = false; return; }
            }
            this.isSyncing = false; this.updateUI(); loadData(); 
        }
    };

    const CloudStatus = {
        el: document.getElementById('cloudStatus'), icon: document.querySelector('#cloudStatus .status-icon'), text: document.getElementById('cloudText'), timer: null,
        set: function(state, customText) { clearTimeout(this.timer); this.el.className = 'show ' + state; if (state === 'success') { this.icon.innerHTML = 'âœ…'; this.text.innerText = customText || 'å·²å„²å­˜'; this.timer = setTimeout(() => { this.el.className = ''; }, 2000); } else if (state === 'syncing') { this.icon.innerHTML = '<div class="spin-circle"></div>'; this.text.innerText = customText || 'é›²ç«¯åŒæ­¥ä¸­...'; } else if (state === 'error') { this.icon.innerHTML = 'âŒ'; this.text.innerText = 'åŒæ­¥å¤±æ•— (é»æ­¤é‡è©¦)'; this.el.onclick = () => SyncManager.process(); } }
    };

    // ğŸŸ¡ å°èˆªæ§åˆ¶
    function goHome() {
        document.getElementById('app-wallet').classList.add('hidden-layer');
        document.getElementById('app-hub').classList.remove('hidden-layer');
    }
    function openWallet() {
        document.getElementById('app-hub').classList.add('hidden-layer');
        document.getElementById('app-wallet').classList.remove('hidden-layer');
        // å¼·åˆ¶é‡ç¹ªä¸€ä¸‹åœ–è¡¨ (å¦‚æœæœ‰çš„è©±) é¿å…å¯¬åº¦å•é¡Œ
        if (allData.length > 0 && expenseChart) expenseChart.resize(); 
    }

    document.addEventListener('DOMContentLoaded', () => {
        const p = localStorage.getItem('myBillPass');
        initMonthSelect('monthSelector'); initMonthSelect('billMonthInput');
        const curr = getCurrentMonthVal();
        document.getElementById('billMonthInput').value = curr;
        document.getElementById('monthSelector').value = curr;
        document.getElementById('passwordInput').addEventListener('input', e=>{ if(e.target.value.length===8) verifyLogin(); });
        if(p) { document.getElementById('passwordInput').value=p; verifyLogin(true); }
    });

    function setBtnLoading(btnId, isLoading, text) {
        const btn = document.getElementById(btnId); const txtSpan = btn.querySelector('.btn-text');
        if(isLoading) { btn.disabled = true; btn.classList.add('btn-loading'); if(txtSpan) { btn.dataset.orgText = txtSpan.innerText; txtSpan.innerText = text; } } 
        else { btn.disabled = false; btn.classList.remove('btn-loading'); if(txtSpan && btn.dataset.orgText) { txtSpan.innerText = btn.dataset.orgText; } }
    }

    function showToast(m) { const t=document.getElementById('toast'); t.innerText=m; t.className='show'; setTimeout(()=>t.className='', 2500); }
    function manualReload() { if (SyncManager.isSyncing) { showToast("âš ï¸ é›²ç«¯åŒæ­¥ä¸­ï¼Œè«‹ç¨å¾Œå†åˆ·æ–°"); return; } CloudStatus.set('syncing', 'è³‡æ–™æ›´æ–°ä¸­...'); loadData(false, true); }
    function toggleChart() { const drawer = document.getElementById('chartDrawer'); const btnText = document.getElementById('chartBtnText'); const btnIcon = document.getElementById('chartBtnIcon'); if (drawer.classList.contains('open')) { drawer.classList.remove('open'); btnText.innerText = "åˆ†æ"; btnIcon.innerText = "ğŸ“Š"; } else { drawer.classList.add('open'); btnText.innerText = "æ”¶èµ·"; btnIcon.innerText = "ğŸ”¼"; if(allData.length > 0) filterData(); } }

    // ğŸŸ¡ æ ¸å¿ƒï¼šverifyLogin ä¿®æ”¹ç‚ºé€²å…¥ Hub
    function verifyLogin(auto=false) { 
        USER_PASSWORD=document.getElementById('passwordInput').value; 
        if(USER_PASSWORD){ 
            setBtnLoading('loginBtn', true, 'å®‰å…¨é©—è­‰ä¸­...'); 
            // è§¸ç™¼è³‡æ–™é è¼‰ï¼Œä½† loadData å…§éƒ¨é‚è¼¯æœƒè™•ç† UI åˆ‡æ›
            loadData(true); 
        } 
    }

    async function loadData(isInit=false, isManual=false) {
        const ctr = document.getElementById('listContainer');
        if(isInit) {
            // é€™è£¡ä¸åšä»»ä½•é¡¯ç¤ºï¼Œå› ç‚ºé‚„åœ¨ç™»å…¥ç•«é¢ï¼Œç­‰å¾…è³‡æ–™å›ä¾†
        } else {
            // æ‰‹å‹•åˆ·æ–°æ™‚é¡¯ç¤º
            ctr.innerHTML = '<div style="text-align:center; padding:20px; color:#aaa;">è¼‰å…¥ä¸­...</div>';
        }
        
        try {
            const res = await fetch(`${API_URL}?password=${encodeURIComponent(USER_PASSWORD)}`);
            const json = await res.json();
            if(json.error) throw new Error(json.error);
            
            localStorage.setItem('myBillPass', USER_PASSWORD);
            allData = normalize(json.data).reverse();
            allTemplates = normalize(json.templates);
            
            if(isInit) {
                // ğŸŸ¡ ç™»å…¥æˆåŠŸ -> åˆ‡æ›åˆ° Hub
                const overlay = document.getElementById('loginOverlay');
                overlay.style.opacity = '0'; overlay.style.pointerEvents = 'none'; 
                setTimeout(()=> {
                    overlay.style.display='none';
                    document.getElementById('app-hub').classList.remove('hidden-layer'); // é¡¯ç¤º Hub
                }, 300);
            }
            
            updateBankSelect();
            filterData();
            setBtnLoading('loginBtn', false);
            
            if(isManual) CloudStatus.set('success', 'è³‡æ–™å·²æ›´æ–°'); 

        } catch(e) {
            console.error(e);
            if(isInit) {
                document.getElementById('loginError').innerText = e.message.includes("å¯†ç¢¼") ? 'âŒ å¯†ç¢¼éŒ¯èª¤' : 'âš ï¸ é€£ç·šå¤±æ•—';
                setBtnLoading('loginBtn', false); 
                if(e.message.includes("å¯†ç¢¼")) localStorage.removeItem('myBillPass');
            } else {
                if(isManual) CloudStatus.set('error');
                else ctr.innerHTML = 'âš ï¸ è¼‰å…¥å¤±æ•—';
            }
        }
    }

    function filterData() {
        const m = document.getElementById('monthSelector').value;
        const list = document.getElementById('listContainer');
        // æ³¨æ„ï¼šé€™è£¡è¦åˆ¤æ–·å¦‚æœæ˜¯ Hub æ¨¡å¼ï¼Œå¯èƒ½ list container æ˜¯éš±è—çš„ï¼Œä½†æ²’é—œä¿‚ï¼Œæˆ‘å€‘é‚„æ˜¯æ¸²æŸ“ HTML æº–å‚™å¥½
        if(allTemplates.length===0) { list.innerHTML='<div style="text-align:center; padding:30px; color:#999;">è«‹å…ˆåœ¨ã€Œè¨­å®šã€æ–°å¢éŠ€è¡Œ</div>'; return; }

        const sorted = [...allTemplates].sort((a,b) => (parseInt(getVal(a,KEYS.BILL))||0) - (parseInt(getVal(b,KEYS.BILL))||0));
        const monthData = allData.filter(d => String(d.month).trim() === m);
        let total=0, count=0, html='', cLabels=[], cData=[], cColors=[];
        currentRenderedItems = [];

        sorted.forEach((t, index) => {
            const bank = getVal(t, KEYS.BANK); const bill = getVal(t, KEYS.BILL); const pay = getVal(t, KEYS.PAY);
            const rec = monthData.find(r => r.bank === bank);
            currentRenderedItems.push({ template: t, record: rec });
            const itemIndex = currentRenderedItems.length - 1;
            let cls='', right='';
            if(rec) {
                const amt = Number(rec.amount); total += amt; count++;
                cls = 't-card logged';
                right = `<div class="t-amount">$${amt.toLocaleString()}</div>`;
                cLabels.push(bank); cData.push(amt); cColors.push(strColor(bank));
            } else {
                cls = 't-card unlogged'; right = `<div class="badge-todo">å¾…ç™»éŒ„</div>`;
            }
            html += `<div class="${cls}" onclick="handleItemClick(${itemIndex})"><div class="t-icon">${bank.charAt(0)}</div><div class="t-content"><div class="t-bank">${bank}</div><div style="font-size:12px; color:#888;">çµå¸³æ—¥ ${bill} / æ‰£æ¬¾æ—¥ ${pay}</div></div>${right}</div>`;
        });

        list.innerHTML = html;
        updateTotal(total, count);
        checkOverdue(m);
        const drawer = document.getElementById('chartDrawer');
        if(total > 0 && (drawer.classList.contains('open') || expenseChart)) renderChart(cLabels, cData, cColors);
    }

    function handleItemClick(index) { const item = currentRenderedItems[index]; const bank = getVal(item.template, KEYS.BANK); if (item.record) openActionModal(bank, item.record); else fillInput(bank, '', ''); }
    function openActionModal(bank, record) { document.getElementById('actionTitle').innerText = bank; document.getElementById('actionSubtitle').innerText = `å·²ç™»éŒ„ï¼š$${Number(record.amount).toLocaleString()}`; document.getElementById('btnActionEdit').onclick = () => { fillInput(bank, record.amount, record.note || ''); closeModal('actionModal'); }; document.getElementById('btnActionDelete').onclick = () => { closeModal('actionModal'); customConfirm(`ç¢ºå®šè¦åˆªé™¤ ${bank} çš„ç´€éŒ„å—ï¼Ÿ`, () => deleteRecord(record.uuid, bank)); }; openModal('actionModal'); }
    function fillInput(bank, amt, note) { document.getElementById('bankSelector').value = bank; document.getElementById('amount').value = amt; document.getElementById('note').value = note; document.querySelector('.input-panel').scrollIntoView({behavior:'smooth'}); if(!amt) document.getElementById('amount').focus(); }
    function submitData() { const bank = document.getElementById('bankSelector').value; const amt = document.getElementById('amount').value; const note = document.getElementById('note').value; const month = document.getElementById('billMonthInput').value; if(!bank || !amt) return showToast('âš ï¸ è«‹å¡«å¯«å®Œæ•´'); const isDup = allData.some(r => r.bank === bank && String(r.month).trim() === month); if(isDup) customConfirm('æ­¤éŠ€è¡Œæœ¬æœˆå·²æœ‰ç´€éŒ„ï¼Œç¢ºå®šè¦æ–°å¢(è¦†è“‹)å—ï¼Ÿ', () => executeSubmit(bank, amt, note, month)); else executeSubmit(bank, amt, note, month); }
    function executeSubmit(bank, amt, note, month) { const tpl = allTemplates.find(t=>getVal(t,KEYS.BANK)===bank); const pay = tpl ? getVal(tpl,KEYS.PAY) : '-'; const fakeRecord = { bank, amount: amt, note, month, paymentDate: pay, rowIndex: -1, uuid: null }; allData.unshift(fakeRecord); filterData(); document.getElementById('amount').value=''; document.getElementById('note').value=''; SyncManager.add({ action: 'post', bank, amount: amt, note, paymentDate: pay, month }); }
    function deleteRecord(uuid, bankName) { if(uuid) allData = allData.filter(r => r.uuid !== uuid); else allData = allData.filter(r => r.bank !== bankName); filterData(); SyncManager.add({ action: 'delete', uuid: uuid }); }
    function addTemplate() { const b=document.getElementById('newBank').value, bill=document.getElementById('newBill').value, pay=document.getElementById('newPay').value; if(!b||!bill||!pay) return showToast('âš ï¸ è«‹å¡«å¯«å®Œæ•´'); document.getElementById('newBank').value=''; document.getElementById('newBill').value=''; document.getElementById('newPay').value=''; setBtnLoading('btnAddTemp', true, 'æ’ç¨‹ä¸­...'); CloudStatus.set('syncing'); fetch(API_URL, { method:'POST', mode:'no-cors', headers:{'Content-Type':'application/json'}, body:JSON.stringify({password:USER_PASSWORD, action:'template_create', BankName:b, BillDate:bill, PaymentDate:pay}) }).then(() => setTimeout(()=>{ loadData().then(() => renderTemplateList()); setBtnLoading('btnAddTemp', false); CloudStatus.set('success'); },1000)); }
    function saveTemplateEdit() { const idx = document.getElementById('editIndex').value; const bank = document.getElementById('editBankName').value; const bill = document.getElementById('editBill').value; const pay = document.getElementById('editPay').value; if(!bill || !pay) return showToast('âš ï¸ æ—¥æœŸä¸èƒ½ç‚ºç©º'); setBtnLoading('btnSaveEdit', true, 'å„²å­˜ä¸­...'); const target = allTemplates.find(t => t.templateIndex == idx); if (target) { if(target.BillDate !== undefined) target.BillDate = bill; if(target.PaymentDate !== undefined) target.PaymentDate = pay; if(target['çµå¸³æ—¥'] !== undefined) target['çµå¸³æ—¥'] = bill; if(target['æ‰£æ¬¾æ—¥'] !== undefined) target['æ‰£æ¬¾æ—¥'] = pay; } renderTemplateList(); filterData(); CloudStatus.set('syncing'); fetch(API_URL, { method:'POST', mode:'no-cors', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ password: USER_PASSWORD, action: 'template_update', templateIndex: idx, BankName: bank, BillDate: bill, PaymentDate: pay }) }).then(() => { setTimeout(() => { closeModal('editTemplateModal'); setBtnLoading('btnSaveEdit', false); CloudStatus.set('success'); loadData(); }, 1000); }); }
    function deleteTemplate(idx) { customConfirm('ç¢ºå®šåˆªé™¤æ­¤éŠ€è¡Œï¼Ÿ', () => { CloudStatus.set('syncing'); fetch(API_URL, { method:'POST', mode:'no-cors', headers:{'Content-Type':'application/json'}, body:JSON.stringify({password:USER_PASSWORD, action:'template_delete', templateIndex:idx}) }).then(()=>setTimeout(() => { loadData().then(() => renderTemplateList()); CloudStatus.set('success'); }, 1000)); }); }
    function openEditTemplateModal(index, bank, bill, pay) { document.getElementById('editIndex').value = index; document.getElementById('editBankName').value = bank; document.getElementById('editBill').value = bill; document.getElementById('editPay').value = pay; openModal('editTemplateModal'); }
    function renderTemplateList() { const d = document.getElementById('templateList'); d.innerHTML=''; const sorted = [...allTemplates].sort((a,b) => (parseInt(getVal(a,KEYS.BILL))||0) - (parseInt(getVal(b,KEYS.BILL))||0)); sorted.forEach(t => { const n = getVal(t,KEYS.BANK); const b = getVal(t,KEYS.BILL); const p = getVal(t,KEYS.PAY); const row = document.createElement('div'); row.className='setup-row'; row.innerHTML = `<div><div style="font-weight:700">${n}</div><div style="font-size:12px;color:#888;">çµå¸³æ—¥ ${b} / æ‰£æ¬¾æ—¥ ${p}</div></div><div style="display:flex; gap:5px;"><button class="btn-setup-action" style="color:#4F46E5;" onclick="openEditTemplateModal(${t.templateIndex}, '${n}', '${b}', '${p}')">âœ ç·¨è¼¯</button><button class="btn-setup-action" style="color:#EF4444;" onclick="deleteTemplate(${t.templateIndex})">ğŸ—‘ï¸ åˆªé™¤</button></div>`; d.appendChild(row); }); }
    function openModal(id) { document.getElementById(id).classList.add('show'); }
    function closeModal(id) { document.getElementById(id).classList.remove('show'); }
    function openSettingsModal() { renderTemplateList(); openModal('settingsModal'); }
    function customConfirm(msg, callback) { document.getElementById('confirmMsg').innerText = msg; document.getElementById('confirmBtnAction').onclick = () => { closeModal('confirmModal'); callback(); }; openModal('confirmModal'); }
    function renderChart(l,d,c) { const ctx = document.getElementById('expenseChart').getContext('2d'); if(expenseChart) expenseChart.destroy(); expenseChart = new Chart(ctx, { type:'doughnut', data:{labels:l,datasets:[{data:d,backgroundColor:c,borderWidth:2,borderColor:'rgba(255,255,255,0.2)'}]}, options:{responsive:true,maintainAspectRatio:false,cutout:'65%',plugins:{legend:{display:true,position:'right',labels:{color:'white',boxWidth:12,font:{size:11}}},layout:{padding:0}}} }); }
    function checkOverdue(ym) { const now=new Date(), y=parseInt(ym.substring(0,4)), m=parseInt(ym.substring(4,6)); const alertList = []; allTemplates.forEach(t=>{ const d = parseInt(getVal(t,KEYS.BILL)); if(!d) return; const cutoff = new Date(y, m-1, d+1); const n = getVal(t,KEYS.BANK); if(now > cutoff && !allData.some(r=>r.bank===n && String(r.month).trim()===ym)) alertList.push(n); }); const container = document.getElementById('alertContainer'); if (alertList.length > 0) container.innerHTML = `<div class="alert-box"><span class="alert-icon">ğŸ””</span><div><span class="alert-title">å¾…ç™»éŒ„æé†’</span>${alertList.join('ã€')} å¸³å–®å·²çµå¸³ï¼Œè«‹æ ¸å°ä¸¦ç™»éŒ„é‡‘é¡ã€‚</div></div>`; else container.innerHTML = ''; }
    function updateBankSelect() { const s = document.getElementById('bankSelector'); s.innerHTML='<option value="" disabled selected>è«‹é¸æ“‡</option>'; allTemplates.forEach(t => { const o=document.createElement('option'); o.value=getVal(t,KEYS.BANK); o.text=getVal(t,KEYS.BANK); s.appendChild(o); }); }
    function updateTotal(t,c) { document.getElementById('totalAmount').innerText=`$${t.toLocaleString()}`; document.getElementById('countLabel').innerText=`${c} ç­†ç´€éŒ„`; const s = document.getElementById('emojiStatus'); s.innerText = t > 20000 ? 'ğŸ’¸' : (t > 5000 ? 'ğŸ¤”' : 'ğŸ˜Š'); }
    function logout() { customConfirm('ç¢ºå®šç™»å‡ºï¼Ÿ', () => { localStorage.removeItem('myBillPass'); location.reload(); }); }
    function normalize(a) { return Array.isArray(a)?a.map(o=>{const n={};for(let k in o)n[k.trim()]=o[k];return n;}):[]; }
    function getVal(t,k) { const m={[KEYS.BANK]:'BankName',[KEYS.BILL]:'BillDate',[KEYS.PAY]:'PaymentDate'}; return t?.[k]??t?.[m[k]]??'-'; }
    function strColor(s) { let h=0;for(let i=0;i<s.length;i++)h=s.charCodeAt(i)+((h<<5)-h); return '#'+("00000"+(h&0xFFFFFF).toString(16)).substr(-6); }
    function getCurrentMonthVal() { const d=new Date(); return `${d.getFullYear()}${String(d.getMonth()+1).padStart(2,'0')}`; }
    function initMonthSelect(id) { const s=document.getElementById(id),d=new Date(); d.setMonth(d.getMonth()+1); for(let i=0;i<24;i++){ const v=`${d.getFullYear()}${String(d.getMonth()+1).padStart(2,'0')}`; const o=document.createElement('option'); o.value=v; o.text=`${d.getFullYear()} / ${String(d.getMonth()+1).padStart(2,'0')}`; s.appendChild(o); d.setMonth(d.getMonth()-1); } }
</script>
</body>
</html>
