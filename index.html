<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <!-- PWA Settings -->
    <meta name="theme-color" content="#F2F4F8">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <title>My Wallet V16.62 Tactile</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js" defer></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/viewerjs/1.11.6/viewer.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/viewerjs/1.11.6/viewer.min.js"></script>
    <style>
        /* --- â„ï¸ V16.62 System: Tactile Feedback --- */
        :root { 
            --bg-body: #F2F4F8;
            --primary: #007AFF; 
            --text-main: #1D1D1F; 
            --text-sub: #86868B;
            --danger: #FF3B30; 
            --success: #34C759;
            /* Qå½ˆçš„å›å½ˆæ›²ç·šï¼Œç”¨æ–¼æ”¾é–‹æŒ‰éˆ•æ™‚ */
            --spring-easing: cubic-bezier(0.34, 1.56, 0.64, 1);
            
            /* Layout */
            --app-width: 480px; 
            --page-padding: clamp(16px, 4vw, 24px);
            --header-top-gap: clamp(10px, 2vh, 25px);
            --header-spacing: calc(env(safe-area-inset-top) + var(--header-top-gap)); 
            --section-gap: clamp(15px, 2.5vh, 24px);
            
            /* Z-Index */
            --z-bg: -1;
            --z-swipe-action: 1;  
            --z-card: 10;         
            --z-nav: 100;         
            --z-login: 2000; 
            --z-modal: 3000;      
            --z-prompt: 9999; 
            --z-toast: 5000;      
        }
        
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        
        html {
            background: #F2F4F8; height: 100%; overflow: hidden; overscroll-behavior: none;
        }

        body { 
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", sans-serif; 
            background: transparent; color: var(--text-main); 
            margin: 0; height: 100%; overflow: hidden; 
            user-select: none; -webkit-user-select: none; width: 100%;
            -webkit-transform: translateZ(0); transform: translateZ(0);
        }

        /* Optimized Background */
        .ambient-light { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            overflow: hidden; z-index: var(--z-bg); pointer-events: none; 
            background: #F2F4F8;
        }
        .blob { 
            position: absolute; border-radius: 50%; opacity: 0.5; 
            filter: blur(60px); will-change: transform; transform: translate3d(0, 0, 0);
            animation: floatBlob 20s infinite alternate ease-in-out;
        }
        .blob:nth-child(1) { top: -10%; left: -10%; width: 90vw; height: 90vw; background: #CDEFFF; }
        .blob:nth-child(2) { bottom: 0%; right: -20%; width: 80vw; height: 80vw; background: #E8DFF5; animation-delay: -5s; }
        .blob:nth-child(3) { bottom: 40%; left: 30%; width: 60vw; height: 60vw; background: #FFE4E6; opacity: 0.4; animation-delay: -8s; }
        @keyframes floatBlob { from { transform: translate3d(0, 0, 0); } to { transform: translate3d(30px, -30px, 0); } }

        /* View Container */
        .view-container {
            width: 100%; max-width: var(--app-width); margin: 0 auto; 
            padding-top: var(--header-spacing); 
            padding-left: var(--page-padding); padding-right: var(--page-padding);
            padding-bottom: calc(env(safe-area-inset-bottom) + 40px);
            height: 100%; 
            overflow-y: auto; overflow-x: hidden;
            -webkit-overflow-scrolling: touch; 
            position: relative;
            display: flex; flex-direction: column;
        }

        .hidden-layer { display: none !important; }
        
        @keyframes iosSlideUp {
            0% { opacity: 0; transform: scale(0.95) translateY(10px); }
            100% { opacity: 1; transform: scale(1) translateY(0); }
        }
        .animate-entry {
            animation: iosSlideUp 0.35s cubic-bezier(0.16, 1, 0.3, 1) forwards;
            transform-origin: center center;
        }

        /* --- ğŸŸ¢ UNIVERSAL INTERACTIVE FEEDBACK ğŸŸ¢ --- */
        
        /* 1. Base State: Smooth Spring Return */
        button, .app-card, .t-card, .segment-btn, .action-btn, .refresh-btn, .mini-action-btn, .chart-type-btn, .btn-liquid, .btn-submit, .btn-icon, #versionTag {
            transition: transform 0.4s var(--spring-easing), opacity 0.2s, background-color 0.2s, box-shadow 0.2s;
            cursor: pointer; 
            transform: translateZ(0); /* GPU Keep Alive */
            -webkit-tap-highlight-color: transparent;
        }

        /* 2. Active State: Instant Shrink (Snappy) */
        button:active, .segment-btn:active, .action-btn:active, .refresh-btn:active, .mini-action-btn:active, .chart-type-btn:active, .btn-liquid:active, .btn-submit:active, .btn-icon:active, #versionTag:active {
            transform: scale(0.92) translateZ(0);
            opacity: 0.85;
            transition: transform 0.05s ease-out, opacity 0.05s; /* Instant response */
        }

        /* Special Case: App Cards (Larger items shrink less) */
        .app-card:active {
            transform: scale(0.96) translateZ(0);
            box-shadow: 0 5px 15px -5px rgba(0,0,0,0.1);
            transition: transform 0.05s ease-out;
        }

        /* Special Case: List Cards (Very subtle to not break list flow) */
        .t-card:active {
            transform: scale(0.98) translate3d(0,0,0);
            background-color: #F2F2F7; /* Highlight color */
            transition: transform 0.05s ease-out, background-color 0.05s;
        }

        /* --- Component Styling --- */

        /* Buttons */
        .btn-liquid {
            width: 100%; border: none; padding: 14px; border-radius: 22px;
            font-size: 16px; font-weight: 700; color: #FFF; margin-top: 0;
            background: linear-gradient(135deg, #FF9500 0%, #FF2D55 100%);
            box-shadow: 0 10px 20px rgba(255, 45, 85, 0.3), inset 0 2px 0 rgba(255,255,255,0.3), inset 0 -2px 5px rgba(0,0,0,0.1);
            position: relative; overflow: hidden; display: flex; justify-content: center; align-items: center;
            text-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }
        .btn-text { z-index: 2; }

        .btn-submit {
            width: 100%; border: none; padding: 14px; border-radius: 20px; 
            font-size: 16px; font-weight: 700; color: white; margin-top: 12px;
            background: var(--primary); box-shadow: 0 8px 20px rgba(0,122,255,0.25);
            position: relative; overflow: hidden; display: flex; justify-content: center; align-items: center;
        }
        
        .btn-icon { 
            background: rgba(255,255,255,0.8); border: 1px solid rgba(255,255,255,1); 
            padding: 6px 12px; border-radius: 14px; font-weight: 600; font-size: 14px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05); color: #1D1D1F; backdrop-filter: blur(10px);
        }

        /* Hub */
        .hub-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; flex-shrink: 0; padding: 0 5px; }
        .hub-title { font-size: 34px; font-weight: 800; color: #000; letter-spacing: -0.5px; }
        .app-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 18px; padding-bottom: 40px; } 
        
        .app-card {
            background: rgba(255, 255, 255, 0.65); 
            backdrop-filter: blur(25px); -webkit-backdrop-filter: blur(25px);
            border: 1px solid rgba(255, 255, 255, 0.8);
            box-shadow: 0 15px 35px -10px rgba(0,0,0,0.08), inset 0 1px 0 rgba(255,255,255,0.5);
            border-radius: 30px; padding: 20px; 
            height: clamp(160px, 23vh, 190px);
            display: flex; flex-direction: column; justify-content: space-between;
            position: relative; overflow: hidden;
        }
        .app-icon-wrapper {
            width: 56px; height: 56px; background: rgba(255,255,255,0.5);
            border-radius: 18px; display: flex; justify-content: center; align-items: center;
            font-size: 32px; margin-bottom: 10px; box-shadow: 0 8px 20px -5px rgba(0,0,0,0.05);
        }
        .app-name { font-size: 20px; font-weight: 700; letter-spacing: 0.3px; color: #1D1D1F; margin-top: auto; }
        .app-ver { position: absolute; top: 20px; right: 20px; font-size: 12px; color: #8E8E93; font-weight: 600; opacity: 0.7; }

        /* Common UI */
        .header-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-shrink: 0; }
        .app-title { font-size: 30px; font-weight: 800; color: #000; }
        
        .total-card {
            background: rgba(255,255,255,0.65); backdrop-filter: blur(30px); -webkit-backdrop-filter: blur(30px);
            border: 1px solid rgba(255,255,255,0.6);
            border-radius: 32px; padding: 24px;
            box-shadow: 0 20px 50px -10px rgba(0,122,255,0.1);
            position: relative; overflow: hidden; margin-bottom: var(--section-gap); flex-shrink: 0;
        }
        .card-label { font-size: 14px; opacity: 0.6; font-weight: 600; color: #000; }
        .total-amount { font-size: 42px; font-weight: 800; letter-spacing: -1.5px; color: #000; margin: 5px 0; line-height: 1.1; }
        .status-emoji { position: absolute; top: 20px; right: 20px; font-size: 48px; opacity: 1; filter: drop-shadow(0 10px 20px rgba(0,0,0,0.1)); }

        .input-panel {
            padding: 20px;
            background: rgba(255,255,255,0.8); backdrop-filter: blur(30px); -webkit-backdrop-filter: blur(30px);
            border-radius: 28px; box-shadow: 0 10px 30px -5px rgba(0,0,0,0.05);
            border: 1px solid rgba(255,255,255,0.5);
            margin-bottom: var(--section-gap); flex-shrink: 0;
        }
        .styled-input {
            width: 100%; padding: 13px 14px; border-radius: 16px; border: 1px solid transparent;
            background: #F2F2F7; font-size: 16px; color: #1D1D1F; transition: 0.2s;
            -webkit-appearance: none; box-shadow: inset 0 2px 5px rgba(0,0,0,0.02);
            box-sizing: border-box;
        }
        .styled-input:focus { background: #FFF; border-color: var(--primary); box-shadow: 0 0 0 4px rgba(0,122,255,0.1); }
        .form-label { font-size: 13px; font-weight: 600; color: var(--text-sub); margin-bottom: 6px; margin-left: 4px; display: block; }
        .segment-control { display: flex; background: #E5E5EA; padding: 4px; border-radius: 16px; margin-bottom: 16px; }
        .segment-btn { flex: 1; padding: 8px; text-align: center; font-size: 14px; font-weight: 600; color: #8E8E93; border-radius: 12px; }
        .segment-btn.active { background: #FFFFFF; color: #000; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }

        .list-section { padding-bottom: 20px; flex: 1; } 
        .list-header { display: flex; justify-content: space-between; margin-bottom: 12px; align-items: center; }
        .list-title { font-size: 20px; font-weight: 800; }
        .month-selector { border:none; background:transparent; font-size:16px; font-weight:700; color:var(--primary); text-align: right; padding-right: 0; }
        
        .swipe-item-container { position: relative; margin-bottom: 12px; height: 80px; border-radius: 24px; transform: translateZ(0); }
        .swipe-bg-action { 
            position: absolute; top: 0; bottom: 0; right: 0; width: 90px; 
            background: #FF3B30; color: white; font-weight: 700; 
            border-radius: 24px; display: flex; justify-content: center; align-items: center;
            z-index: var(--z-swipe-action); 
            box-shadow: inset 5px 0 15px rgba(0,0,0,0.1);
            opacity: 0; transition: opacity 0.1s;
        }
        .swipe-item-container.active-swipe .swipe-bg-action { opacity: 1; }

        .t-card {
            position: relative; width: 100%; height: 100%;
            background: #FFFFFF; border-radius: 24px; padding: 16px;
            display: flex; align-items: center; gap: 14px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.03); border: 1px solid rgba(0,0,0,0.02);
            z-index: var(--z-card); 
            /* Note: transition controlled by JS during swipe, but CSS handles active state */
            will-change: transform;
            backface-visibility: hidden;
        }
        .t-card.unlogged { background: #FAFAFA; border: 2px dashed #C7C7CC; box-shadow: none; }
        .t-card.schedule-card { margin-bottom: 14px; }
        .t-icon { width: 44px; height: 44px; border-radius: 14px; background: #F2F2F7; display: flex; justify-content: center; align-items: center; font-size: 20px; flex-shrink: 0; }
        .t-content { flex: 1; min-width: 0; }
        .t-bank { font-size: 16px; font-weight: 700; margin-bottom: 3px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .t-amount { font-weight: 800; font-size: 18px; flex-shrink: 0; }

        .mini-action-btn {
            width: 36px; height: 36px; border-radius: 12px;
            display: flex; justify-content: center; align-items: center; font-size: 16px;
            border: 1px solid #E5E5EA; background: #FFF;
            box-shadow: 0 2px 5px rgba(0,0,0,0.03);
        }
        .mini-action-btn.danger { color: #FF3B30; background: #FFF2F2; border-color: #FFDADA; }

        /* Modals */
        .modal-overlay { 
            position: fixed; top:0; left:0; width:100%; height:100%; 
            background: rgba(0,0,0,0.3); backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px);
            z-index: var(--z-modal); display: flex; justify-content: center; align-items: center; 
            opacity: 0; pointer-events: none; transition: opacity 0.2s;
        }
        .modal-overlay.show { opacity: 1; pointer-events: auto; }
        
        .modal-box { 
            background: rgba(255,255,255,0.98); backdrop-filter: blur(50px); -webkit-backdrop-filter: blur(50px);
            width: 92%; max-width: 400px; max-height: 85vh;
            border-radius: 32px; padding: 0; 
            box-shadow: 0 30px 90px rgba(0,0,0,0.3);
            transform: scale(0.94); transition: 0.3s var(--spring-easing);
            display: flex; flex-direction: column;
            border: 1px solid rgba(255,255,255,0.6);
        }
        .modal-overlay.show .modal-box { transform: scale(1); }
        
        .modal-header { padding: clamp(20px, 3vh, 30px); padding-bottom: 10px; flex-shrink: 0; }
        .modal-title-text { font-size: 20px; font-weight: 800; color: #000; }
        .modal-content-scroll { padding: 0 clamp(20px, 3vh, 30px); overflow-y: auto; -webkit-overflow-scrolling: touch; flex: 1; }
        .modal-footer { padding: 15px clamp(20px, 3vh, 30px) 25px; flex-shrink: 0; }
        
        .modal-box .styled-input { font-size: 15px; padding: 12px; background: #F2F4F8; border: 1px solid #E5E5EA; }
        .action-btn { width: 100%; padding: 12px; border-radius: 16px; font-weight: 700; border: none; margin-bottom: 10px; font-size: 15px; }

        .settings-group { background: #F2F4F8; padding: 16px; border-radius: 20px; margin-bottom: 16px; }
        .settings-label { font-size: 12px; color: #FF9500; font-weight: 700; margin-bottom: 8px; display:block; }
        .flex-input-row { display: flex; gap: 10px; align-items: center; width: 100%; }
        .flex-input-row .styled-input { flex: 1; background: #FFF; }
        .flex-input-row .btn-submit { margin: 0; width: auto; padding: 0 20px; height: 44px; }

        /* Install & Status */
        #iosInstallPrompt {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.98); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            z-index: var(--z-prompt);
            flex-direction: column; justify-content: center; align-items: center;
            padding: 40px; text-align: center;
        }
        .install-icon { 
            font-size: 50px; margin-bottom: 20px; background: #FFF; width: 90px; height: 90px; 
            display: flex; justify-content: center; align-items: center;
            border-radius: 22px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); border: 1px solid rgba(0,0,0,0.05);
        }

        #loginOverlay { 
            position: fixed; top:0; left:0; width:100%; height:100%; 
            background: rgba(255,255,255,0.6); backdrop-filter: blur(50px);
            z-index: var(--z-login); 
            display: flex; flex-direction: column; justify-content: center; align-items: center; 
            transition: opacity 0.5s ease;
        }
        .login-input { 
            background: #FFFFFF; border: 1px solid rgba(0,0,0,0.1); width: 240px; padding: 15px; 
            border-radius: 24px; font-size: 24px; text-align: center; margin: 25px 0; letter-spacing: 8px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.05); transition: all 0.3s;
        }
        .login-input:focus { border-color: var(--primary); transform: translateY(-5px); box-shadow: 0 15px 35px rgba(0,122,255,0.15); }

        #cloudStatus { 
            position: fixed; top: 15px; left: 50%; transform: translateX(-50%);
            background: white; padding: 8px 16px; border-radius: 30px; 
            box-shadow: 0 8px 25px rgba(0,0,0,0.15); font-weight: 600; font-size: 12px;
            display: none; align-items: center; gap: 8px; z-index: var(--z-toast);
            border: 1px solid rgba(0,0,0,0.05); width: auto; white-space: nowrap;
        }
        #cloudStatus.show { display: flex; animation: fadeInStatus 0.3s; }
        #toast { 
            visibility: hidden; background: rgba(20,20,20,0.8); color: white; backdrop-filter: blur(10px);
            padding: 12px 24px; border-radius: 50px; 
            position: fixed; bottom: 40px; left: 50%; transform: translateX(-50%); 
            z-index: var(--z-toast); opacity:0; transition:0.3s; font-weight: 600; font-size: 14px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2); width: auto; white-space: nowrap;
        }
        #toast.show { visibility: visible; opacity: 1; bottom: 50px; }

        .chart-drawer { max-height: 0; opacity: 0; overflow: hidden; transition: max-height 0.6s var(--spring-easing), opacity 0.4s ease; margin-top: 0; }
        .chart-drawer.open { max-height: 400px; opacity: 1; margin-top: 20px; padding-top: 20px; border-top: 1px solid rgba(0,0,0,0.05); }
        .chart-type-btn { background: #F2F2F7; border:none; padding: 6px 14px; border-radius: 14px; color: #8E8E93; font-weight: 600; font-size: 13px; }
        .chart-type-btn.active { background: #1D1D1F; color: #FFF; }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px; }
        .refresh-btn { width: 32px; height: 32px; border-radius: 50%; border: 1px solid #E5E5EA; background: white; display: flex; justify-content: center; align-items: center; font-size: 14px; box-shadow: 0 2px 6px rgba(0,0,0,0.05); }
        .spinner { width: 18px; height: 18px; border: 2px solid rgba(255,255,255,0.3); border-top-color: white; border-radius: 50%; animation: spin 0.8s linear infinite; display: none; margin-right: 8px; }
        #s-img-spinner { margin: 0; border-color: #CCC; border-top-color: #007AFF; }
        .btn-loading .spinner { display: inline-block; }
        .spin-circle { width: 14px; height: 14px; border: 2px solid #E5E7FF; border-top-color: var(--primary); border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        @keyframes fadeIn { from { opacity:0; transform: translateY(10px); } to { opacity:1; transform: translateY(0); } }
        @keyframes fadeInStatus { from { opacity:0; transform: translate(-50%, -10px); } to { opacity:1; transform: translate(-50%, 0); } }
    </style>
</head>
<body ontouchstart="">

    <div class="ambient-light">
        <div class="blob"></div>
        <div class="blob"></div>
        <div class="blob"></div>
    </div>

    <div id="cloudStatus"><div class="status-icon"><div class="spin-circle"></div></div><span id="cloudText">é›²ç«¯åŒæ­¥ä¸­...</span></div>
    <div id="toast"></div>

    <div id="iosInstallPrompt">
        <div class="install-icon">ğŸ“²</div>
        <div style="font-size: 22px; font-weight: 800; margin-bottom: 10px; color:#000;">å®‰è£ My Wallet</div>
        <div style="color: #666; margin-bottom: 25px; line-height: 1.5;">è«‹å°‡æ­¤ç¶²é åŠ å…¥ä¸»ç•«é¢<br>ä»¥ç²å¾—æœ€ä½³å…¨è¢å¹•é«”é©—</div>
        <div style="background:#F2F2F7; padding:20px; border-radius:20px; width:100%; margin-bottom:20px;">
            <div style="color: #333; font-weight: 600; margin-bottom: 10px; text-align:left;">1. é»æ“Šç€è¦½å™¨ä¸‹æ–¹åˆ†äº«æŒ‰éˆ•</div>
            <div style="color: #333; font-weight: 600; text-align:left;">2. é¸æ“‡ã€ŒåŠ å…¥ä¸»ç•«é¢ã€</div>
        </div>
        <button class="action-btn" onclick="document.getElementById('iosInstallPrompt').style.display='none'" style="background:transparent; color:#8E8E93; margin-top:10px;">æš«æ™‚ä¸è¦</button>
    </div>

    <div id="loginOverlay">
        <div style="font-size:64px; margin-bottom:20px; filter: drop-shadow(0 10px 20px rgba(0,0,0,0.1));">ğŸ”’</div>
        <div style="font-weight:800; font-size:26px; color:#1D1D1F;">App Hub</div>
        <input type="password" id="passwordInput" class="login-input" placeholder="â€¢â€¢â€¢â€¢" maxlength="8" inputmode="numeric">
        <button id="loginBtn" class="btn-submit" onclick="verifyLogin()" style="width:240px;">
            <div class="spinner"></div> <span class="btn-text">è§£é–</span>
        </button>
        <div id="loginError" style="color:var(--danger); margin-top:20px; min-height:20px; font-weight:600;"></div>
        <div id="versionTag" onclick="LoginHandler.clickVersion()" style="position:absolute; bottom:40px; color:#AAA; font-size:12px; font-weight:600;">v16.62 Tactile</div>
    </div>

    <!-- App Hub View Container -->
    <div id="app-hub" class="hidden-layer view-container">
        <div class="hub-header">
            <div class="hub-title">Apps</div>
            <button class="btn-icon" onclick="logout()" style="color:var(--danger); border-color: #FFDADA; background:#FFF2F2;">ç™»å‡º</button>
        </div>
        <div class="app-grid">
            <div class="app-card" onclick="Nav.open('wallet')">
                <div class="app-icon-wrapper">ğŸ’°</div>
                <div class="app-name">My Wallet</div>
                <div class="app-ver">v9.7</div>
            </div>
            <div class="app-card" onclick="Nav.open('crypto')">
                <div class="app-icon-wrapper">ğŸª™</div>
                <div class="app-name">Crypto</div>
                <div class="app-ver">v2.1</div>
            </div>
            <div class="app-card" onclick="Nav.open('schedule')">
                <div class="app-icon-wrapper">ğŸ“…</div>
                <div class="app-name">ç­è¡¨</div>
                <div class="app-ver">v1.8</div>
            </div>
        </div>
    </div>

    <!-- Wallet View Container -->
    <div id="app-wallet" class="hidden-layer view-container">
        <div class="hero">
            <div class="header-row">
                <div class="app-title">My Wallet</div>
                <div style="display:flex; gap:8px;">
                    <button class="btn-icon" onclick="openWalletSettings()">âš™ï¸</button>
                    <button class="btn-icon" onclick="Nav.home()" style="color:var(--primary);">ğŸ </button>
                </div>
            </div>
            <div class="total-card">
                <div style="position:relative; z-index:2;">
                    <div class="card-label">æœ¬æœˆç¸½æ”¯å‡º</div>
                    <div class="total-amount" id="w-total">$0</div>
                    <div class="budget-container" id="budgetContainer" style="display:none; margin-top:15px;">
                        <div style="background:rgba(0,0,0,0.05); height:8px; border-radius:4px;">
                            <div id="budgetFill" style="height:100%; background:#34C759; width:0%; border-radius:4px; transition:width 0.5s;"></div>
                        </div>
                        <div style="margin-top:8px; display:flex; justify-content:space-between; font-size:12px; font-weight:600; color:#8E8E93;">
                            <span id="budgetStatusText">é ç®—ç›£æ§</span><span id="budgetLeftText">å‰©é¤˜ $0</span>
                        </div>
                    </div>
                    <div style="margin-top:20px; display:flex; justify-content:space-between; align-items:center;">
                        <div style="font-size:13px; opacity:0.5; font-weight:600;" id="w-count">0 ç­†ç´€éŒ„</div>
                        <button class="btn-icon" onclick="WalletApp.toggleChart()" style="background:rgba(255,255,255,0.9);">
                            <span id="chartBtnIcon">ğŸ“Š</span> <span id="chartBtnText">åˆ†æ</span>
                        </button>
                    </div>
                </div>
                <div class="status-emoji" id="emojiStatus">ğŸ˜Š</div>
                <div class="chart-drawer" id="chartDrawer">
                    <div style="display:flex; justify-content:center; gap:10px; margin-bottom:15px;">
                        <button class="chart-type-btn active" id="btnChartPie" onclick="WalletApp.setChartType('pie')">åœ“é¤…åœ–</button>
                        <button class="chart-type-btn" id="btnChartBar" onclick="WalletApp.setChartType('bar')">è¶¨å‹¢</button>
                    </div>
                    <div style="height:200px; display:flex; justify-content:center;"><canvas id="expenseChart"></canvas></div>
                </div>
            </div>
        </div>
        <div class="input-panel">
            <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
                <span style="font-weight:600; color:var(--text-sub);">è¨˜å¸³æœˆä»½</span>
                <select id="w-input-month" style="border:none; font-size:16px; font-weight:700; color:var(--primary); outline:none; background:transparent;"></select>
            </div>
            <div class="grid-2">
                <div><label class="form-label">éŠ€è¡Œ</label><select id="w-bank" class="styled-input"></select></div>
                <div><label class="form-label">é‡‘é¡</label><input type="number" id="w-amount" class="styled-input" placeholder="$0" inputmode="decimal" pattern="[0-9]*"></div>
            </div>
            <label class="form-label">å‚™è¨»</label><input type="text" id="w-note" class="styled-input" placeholder="é¸å¡«...">
            <button id="w-submit" class="btn-submit" onclick="WalletApp.submit()">
                <div class="spinner"></div> <span class="btn-text">ï¼‹ ç¢ºèªè¨˜å¸³</span>
            </button>
        </div>
        <div class="list-section">
            <div class="list-header">
                <span class="list-title">å¸³å–®æ˜ç´°</span>
                <div style="display:flex; align-items:center;">
                    <select id="w-list-month" class="month-selector" onchange="WalletApp.render()"></select>
                    <button class="refresh-btn" onclick="manualReload()">â†»</button>
                </div>
            </div>
            <div id="alertContainer"></div>
            <div id="w-list"></div>
        </div>
    </div>

    <!-- Crypto View Container -->
    <div id="app-crypto" class="hidden-layer view-container">
        <div class="hero">
            <div class="header-row">
                <div class="app-title">Crypto</div>
                <div style="display:flex; gap:8px;">
                    <button class="btn-icon" onclick="openCryptoSettings()">âš™ï¸</button>
                    <button class="btn-icon" onclick="Nav.home()" style="color:var(--primary);">ğŸ </button>
                </div>
            </div>
            <div class="total-card">
                <div style="position:relative; z-index:2;">
                    <div class="card-label">ç¸½æŠ•å…¥æˆæœ¬</div>
                    <div class="total-amount" id="c-total-twd">$0 TWD</div>
                    <div style="margin-top:10px; font-size:16px; opacity:0.6; font-family:monospace; color:#333;" id="c-total-usd">â‰ˆ $0 USD</div>
                </div>
            </div>
        </div>
        <div class="input-panel">
            <div class="segment-control">
                <div class="segment-btn active" id="seg-twd" onclick="CryptoApp.setMode('twd')">ğŸ‡¹ğŸ‡¼ å°å¹£å…¥é‡‘</div>
                <div class="segment-btn" id="seg-usd" onclick="CryptoApp.setMode('usd')">ğŸ‡ºğŸ‡¸ å¤–å¹£å…¥é‡‘</div>
            </div>
            <div class="grid-2">
                <div><label class="form-label">å…¥é‡‘æ—¥æœŸ</label><input type="date" id="c-date" class="styled-input"></div>
                <div><label class="form-label">å…¥é‡‘ç®¡é“</label><select id="c-method" class="styled-input"></select></div>
            </div>
            <div class="grid-2">
                <div><label class="form-label">æˆæœ¬ (TWD)</label><input type="number" id="c-cost" class="styled-input" placeholder="å°å¹£" inputmode="decimal"></div>
                <div id="c-usd-field" style="display:none;"><label class="form-label">é‡‘é¡ (U)</label><input type="number" id="c-usd" class="styled-input" placeholder="ç¾é‡‘/U" inputmode="decimal"></div>
            </div>
            <label class="form-label">å‚™è¨»</label><input type="text" id="c-note" class="styled-input" placeholder="é¸å¡«...">
            <button id="c-submit" class="btn-submit" onclick="CryptoApp.submit()">
                <div class="spinner"></div> <span class="btn-text">ï¼‹ æ–°å¢ç´€éŒ„</span>
            </button>
        </div>
        <div class="list-section">
            <div class="list-header"><span class="list-title">æŠ•è³‡ç´€éŒ„</span><button class="refresh-btn" onclick="manualReload()">â†»</button></div>
            <div id="c-list"></div>
        </div>
    </div>

    <!-- Schedule View Container -->
    <div id="app-schedule" class="hidden-layer view-container">
        <div class="hero">
            <div class="header-row">
                <div class="app-title">ç­è¡¨</div>
                <div style="display:flex; gap:8px;">
                    <button class="btn-icon" onclick="Nav.home()" style="color:var(--primary);">ğŸ </button>
                </div>
            </div>
            <div class="total-card">
                <div style="position:relative; z-index:2;">
                    <div class="card-label">ç•¶æœˆç­è¡¨</div>
                    <div class="total-amount" id="s-display-month">-- / --</div>
                </div>
                <div class="status-emoji" style="position:absolute; top:20px; right:20px; font-size:50px;">ğŸ“…</div>
            </div>
        </div>
        
        <div style="padding:15px 0; display:flex; gap:10px;">
            <select id="s-month-selector" class="styled-input" style="flex:1;" onchange="ScheduleApp.render()"></select>
            <div style="position:relative; flex:1;">
                <button id="s-upload-btn" class="btn-liquid">
                    <div id="uploadSpinner" class="spinner"></div>
                    <span class="btn-text">ğŸ“· ä¸Šå‚³</span>
                </button>
                <input type="file" id="s-upload-input" style="position:absolute; left:0; top:0; width:100%; height:100%; opacity:0;" accept="image/*" onchange="ScheduleApp.handleUpload(this)">
            </div>
        </div>

        <div class="schedule-viewer" id="s-viewer-container" style="margin:0 0 30px 0; border-radius:24px; height:300px; display:flex; justify-content:center; align-items:center; position:relative; background:#F2F2F7; border:2px dashed #D1D1D6;">
            <div id="s-img-spinner" class="spinner"></div>
            <div id="s-empty-msg" style="color:#8E8E93; text-align:center;">
                <div style="font-size:40px;">ğŸ“„</div>
                <div>æœ¬æœˆå°šç„¡ç­è¡¨</div>
            </div>
            <img id="s-image" style="max-width:100%; max-height:100%; display:none; border-radius:20px;" onload="ScheduleApp.onImageLoad()" onerror="ScheduleApp.onImageError()">
        </div>
        <div class="list-section">
            <div class="list-header"><span class="list-title">æ­·å²ç´€éŒ„</span></div>
            <div id="s-list"></div>
        </div>
    </div>

    <!-- Modals -->
    <div id="actionModal" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-header" style="text-align:center;">
                <div id="actionTitle" class="modal-title-text"></div>
                <div id="actionSubtitle" style="font-size:14px; color:#8E8E93; margin:5px 0 0 0;"></div>
            </div>
            <div style="padding: 0 clamp(20px, 3vh, 30px) 25px;">
                <button class="action-btn" id="btnActionEdit" style="background:#F2F2F7; color:#007AFF;">âœ ä¿®æ”¹ / å¡«å…¥</button>
                <button class="action-btn" id="btnActionDelete" style="background:#FFF2F2; color:#FF3B30;">ğŸ—‘ï¸ åˆªé™¤ç´€éŒ„</button>
                <button class="action-btn" onclick="closeModal('actionModal')" style="background:transparent; color:#8E8E93;">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <div id="settingsModal" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-header">
                <div class="modal-title-text" style="margin-bottom:15px;">è¨­å®š</div>
                <div class="settings-group">
                    <label class="settings-label">é ç®—ç›®æ¨™</label>
                    <div class="flex-input-row">
                        <input type="number" id="budgetInput" class="styled-input" style="background:#FFF;">
                        <button class="btn-submit" onclick="saveBudget()" id="btnSaveBudget" style="background:#FF9500;">å„²å­˜</button>
                    </div>
                </div>
            </div>
            <div class="modal-content-scroll">
                <div style="font-size:13px; font-weight:700; margin-bottom:10px; color:#8E8E93;">æ–°å¢éŠ€è¡Œå¡ç‰‡</div>
                <div class="settings-group">
                    <input type="text" id="newBank" class="styled-input" placeholder="åç¨±" style="margin-bottom:10px; background:#FFF;">
                    <div class="grid-2">
                        <input type="number" id="newBill" class="styled-input" placeholder="çµå¸³æ—¥" style="background:#FFF;">
                        <input type="number" id="newPay" class="styled-input" placeholder="æ‰£æ¬¾æ—¥" style="background:#FFF;">
                    </div>
                    <button id="btnAddTemp" class="btn-submit" onclick="addTemplate()" style="margin-top:5px;">ï¼‹ æ–°å¢</button>
                </div>
                <div style="font-size:12px; color:#C7C7CC; margin:20px 0 10px 0; font-weight:700;">å·²å„²å­˜</div>
                <div id="templateList" style="padding-bottom: 20px;"></div>
            </div>
            <div class="modal-footer">
                <button class="btn-submit" onclick="closeModal('settingsModal')" style="background:#E5E5EA; color:#000; margin:0;">é—œé–‰</button>
            </div>
        </div>
    </div>

    <div id="cryptoSettingsModal" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-header">
                <div class="modal-title-text" style="margin-bottom:15px;">å…¥é‡‘ç®¡é“</div>
                <div class="flex-input-row">
                    <input type="text" id="newCryptoMethod" class="styled-input" placeholder="åç¨±">
                    <button id="btnAddCryptoMethod" class="btn-submit" onclick="CryptoApp.addMethod()">æ–°å¢</button>
                </div>
            </div>
            <div class="modal-content-scroll" id="cryptoMethodList"></div>
            <div class="modal-footer">
                <div id="cryptoSettingsRate" style="text-align:center; color:#34C759; font-weight:600; font-size:13px; margin-bottom:10px;"></div>
                <button class="btn-submit" onclick="closeModal('cryptoSettingsModal')" style="background:#E5E5EA; color:#000; margin:0;">é—œé–‰</button>
            </div>
        </div>
    </div>

    <div id="editTemplateModal" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-header">
                <div class="modal-title-text" style="margin-bottom:15px;">ç·¨è¼¯</div>
                <input type="hidden" id="editIndex">
                <input type="text" id="editBankName" class="styled-input" disabled style="color:#8E8E93; margin-bottom:10px;">
                <div class="grid-2">
                    <input type="number" id="editBill" class="styled-input" placeholder="çµå¸³æ—¥">
                    <input type="number" id="editPay" class="styled-input" placeholder="æ‰£æ¬¾æ—¥">
                </div>
            </div>
            <div style="display:flex; gap:10px; padding: 0 clamp(20px, 3vh, 30px) 25px;">
                <button class="btn-submit" onclick="closeModal('editTemplateModal')" style="background:#E5E5EA; color:#000; margin:0;">å–æ¶ˆ</button>
                <button class="btn-submit" id="btnSaveEdit" onclick="saveTemplateEdit()" style="margin:0;">å„²å­˜</button>
            </div>
        </div>
    </div>

    <div id="alertModal" class="modal-overlay">
        <div class="modal-box" style="text-align:center;">
            <div id="alertMsg" style="font-size:16px; margin: 30px 20px;"></div>
            <div style="padding: 0 24px 24px 24px;">
                <button class="btn-submit" onclick="closeModal('alertModal')" style="margin:0;">ç¢ºå®š</button>
            </div>
        </div>
    </div>
    <div id="confirmModal" class="modal-overlay">
        <div class="modal-box" style="text-align:center;">
            <div id="confirmMsg" style="font-size:16px; margin: 30px 20px;"></div>
            <div style="display:flex; gap:10px; padding: 0 24px 24px 24px;">
                <button class="btn-submit" onclick="closeModal('confirmModal')" style="background:#E5E5EA; color:#000; margin:0;">å–æ¶ˆ</button>
                <button class="btn-submit" id="confirmBtnAction" style="margin:0;">ç¢ºå®š</button>
            </div>
        </div>
    </div>

<script>
/* --- Core Logic (Stable) --- */
const API_URL = "https://script.google.com/macros/s/AKfycby60jdswu4PguQ0YNMpYdfdOewU-YscwRvOpcVxZhV7KNpwhVzSO7tJ8vNx1fPmw_tjGw/exec";
const CLOUDINARY_CLOUD_NAME = "dmgdasluw"; 
const CLOUDINARY_UPLOAD_PRESET = "my_wallet_preset"; 

let USER_PASSWORD = "";
let GLOBAL_DATA = { wallet: {data:[], templates:[]}, crypto: {data:[], methods:[], rate: 32.5}, schedule: {data:[]}, config: {budget: 0} };

const DomUtils = {
    createEl: function(tag, className, text, children, attributes) {
        const el = document.createElement(tag);
        if(className) el.className = className;
        if(text !== undefined && text !== null) el.textContent = text;
        if(children && Array.isArray(children)) children.forEach(c => { if(c) el.appendChild(c); });
        if(attributes) for(let key in attributes) el.setAttribute(key, attributes[key]);
        return el;
    },
    renderOptions: function(selectId, options, defaultText = 'è«‹é¸æ“‡') {
        const sel = document.getElementById(selectId);
        if(!sel) return;
        sel.innerHTML = '';
        const def = document.createElement('option');
        def.text = defaultText; def.disabled = true; def.selected = true;
        sel.appendChild(def);
        options.forEach(opt => {
            const el = document.createElement('option');
            el.value = opt; el.text = opt;
            sel.appendChild(el);
        });
    }
};

/* --- Swipe Logic --- */
let isDragging = false; let startX = 0; let startY = 0; let activeSwipeEl = null;

function handleStart(e) {
    const target = e.target;
    if(target.closest('.schedule-viewer')) return; 
    if (target.classList.contains('swipe-bg-action') || target.closest('.swipe-bg-action')) return;
    
    const card = target.closest('.t-card');
    if (!card || !card.classList.contains('swipable')) { 
        if (activeSwipeEl) closeSwipe(activeSwipeEl); 
        return; 
    }
    
    if (activeSwipeEl && activeSwipeEl !== card) closeSwipe(activeSwipeEl);
    
    isDragging = true; 
    startX = e.touches[0].clientX;
    startY = e.touches[0].clientY;
    card.style.transition = 'none';
    
    const container = card.closest('.swipe-item-container');
    if(container) container.classList.add('active-swipe');
}

function handleMove(e) {
    if (!isDragging) return;
    const card = e.target.closest('.t-card');
    if (!card) return;
    
    const x = e.touches[0].clientX;
    const y = e.touches[0].clientY;
    const diffX = x - startX;
    const diffY = y - startY;

    if (Math.abs(diffY) > Math.abs(diffX)) {
        isDragging = false; 
        return; 
    }

    if (diffX < 0 && diffX > -120) { 
        if(e.cancelable) e.preventDefault(); 
        card.style.transform = `translate3d(${diffX}px, 0, 0)`; 
    } else if (diffX > 0) { 
        card.style.transform = `translate3d(0, 0, 0)`; 
    }
}

function handleEnd(e) {
    if (!isDragging) return;
    isDragging = false;
    const card = e.target.closest('.t-card');
    if (!card) return;
    
    card.style.transition = 'transform 0.2s cubic-bezier(0.25, 0.8, 0.25, 1)';
    const currentX = new WebKitCSSMatrix(window.getComputedStyle(card).transform).m41;
    
    if (currentX < -40) { 
        card.style.transform = `translate3d(-100px, 0, 0)`; 
        activeSwipeEl = card; 
    } else { 
        card.style.transform = `translate3d(0, 0, 0)`; 
        activeSwipeEl = null; 
        const container = card.closest('.swipe-item-container');
        if(container) container.classList.remove('active-swipe');
    }
}

document.addEventListener('touchstart', handleStart, { passive: true });
document.addEventListener('touchmove', handleMove, { passive: false });
document.addEventListener('touchend', handleEnd);

function closeSwipe(el) { 
    if(!el) return; 
    el.style.transform = 'translate3d(0, 0, 0)'; 
    activeSwipeEl = null; 
    const container = el.closest('.swipe-item-container');
    if(container) container.classList.remove('active-swipe');
}

const LoginHandler = {
    clickCount: 0, timer: null,
    clickVersion: function() {
        this.clickCount++; clearTimeout(this.timer); this.timer = setTimeout(() => { this.clickCount = 0; }, 2000);
        if (this.clickCount === 5) {
            this.clickCount = 0;
            customConfirm('ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰å¿«å–è¨­å®šä¸¦é‡ç½®å—ï¼Ÿ', () => { localStorage.clear(); window.location.reload(); });
        }
    }
};

document.addEventListener('DOMContentLoaded', () => {
    const isIos = /iphone|ipad|ipod/.test(window.navigator.userAgent.toLowerCase());
    const isStandalone = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone === true;
    if (isIos && !isStandalone) {
        document.getElementById('iosInstallPrompt').style.display = 'flex';
    }
    const savedPass = localStorage.getItem('myBillPass');
    if(savedPass) {
        document.getElementById('passwordInput').value = savedPass;
        USER_PASSWORD = savedPass;
        setBtnLoading('loginBtn', true, 'è‡ªå‹•ç™»å…¥ä¸­...');
        DataLoader.load(true);
    }
});

const Nav = {
    open: function(appId) {
        const layers = document.querySelectorAll('.hidden-layer, #app-hub, #app-wallet, #app-crypto, #app-schedule');
        layers.forEach(el => {
            el.classList.add('hidden-layer');
            el.classList.remove('animate-entry');
        });
        
        const target = document.getElementById('app-' + appId);
        target.classList.remove('hidden-layer');
        
        // FIX: iOS Animation Trigger
        void target.offsetWidth; // Force Reflow
        target.classList.add('animate-entry');
        
        if(appId === 'wallet') WalletApp.render();
        if(appId === 'crypto') CryptoApp.render();
        if(appId === 'schedule') ScheduleApp.render();
    },
    home: function() {
        const layers = document.querySelectorAll('.hidden-layer, #app-wallet, #app-crypto, #app-schedule');
        layers.forEach(el => {
            el.classList.add('hidden-layer');
            el.classList.remove('animate-entry');
        });
        
        const hub = document.getElementById('app-hub');
        hub.classList.remove('hidden-layer');
        
        // FIX: iOS Animation Trigger
        void hub.offsetWidth; 
        hub.classList.add('animate-entry');
    }
};

const SyncManager = {
    queue: [], isSyncing: false, totalTasks: 0, completed: 0,
    add: function(payload) { this.queue.push(payload); if (!this.isSyncing) { this.totalTasks = this.queue.length; this.completed = 0; } else { this.totalTasks++; } this.updateUI(); this.process(); },
    updateUI: function() { const pending = this.queue.length; if (pending > 0) { const current = this.totalTasks - pending + 1; CloudStatus.set('syncing', `åŒæ­¥ä¸­ (${current}/${this.totalTasks})...`); } else { CloudStatus.set('success'); this.totalTasks = 0; this.completed = 0; } },
    process: async function() {
        if (this.isSyncing || this.queue.length === 0) return;
        this.isSyncing = true;
        while (this.queue.length > 0) {
            this.updateUI(); const currentTask = this.queue[0];
            let success = false;
            for(let i=0; i<3; i++) { 
                try {
                    const f = fetch(API_URL, { method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ ...currentTask, password: USER_PASSWORD }) });
                    await Promise.race([f, new Promise((_, r) => setTimeout(() => r(new Error('Timeout')), 8000))]);
                    success = true; break;
                } catch(e) { await new Promise(r => setTimeout(r, 1500)); }
            }
            if(success) { this.queue.shift(); this.completed++; await new Promise(r => setTimeout(r, 500)); } 
            else { CloudStatus.set('error'); this.isSyncing = false; return; }
        }
        this.isSyncing = false; this.updateUI(); DataLoader.load(); 
    }
};

const CloudStatus = {
    el: document.getElementById('cloudStatus'), icon: document.querySelector('#cloudStatus .status-icon'), text: document.getElementById('cloudText'), timer: null,
    set: function(state, customText) {
        clearTimeout(this.timer); this.el.className = 'show ' + state;
        if (state === 'success') { this.icon.innerHTML = 'âœ…'; this.text.innerText = customText || 'å·²å„²å­˜'; this.timer = setTimeout(() => { this.el.className = ''; }, 2000); } 
        else if (state === 'syncing') { this.icon.innerHTML = '<div class="spin-circle"></div>'; this.text.innerText = customText || 'é›²ç«¯åŒæ­¥ä¸­...'; } 
        else if (state === 'error') { this.icon.innerHTML = 'âŒ'; this.text.innerText = 'åŒæ­¥å¤±æ•—'; this.el.onclick = () => SyncManager.process(); }
    }
};

const DATA_KEY_MAP = { 
    'UUID': 'uuid', 'Month': 'month', 'ImageURL': 'imageurl', 'Timestamp': 'timestamp',
    'æœˆä»½': 'month', 'month': 'month', 'imageurl': 'imageurl', 'image': 'imageurl', 'url': 'imageurl', 'timestamp': 'timestamp', 'time': 'timestamp',
    'éŠ€è¡Œåç¨±': 'bankname', 'bankname': 'bankname', 'çµå¸³æ—¥': 'billdate', 'billdate': 'billdate', 'æ‰£æ¬¾æ—¥': 'paymentdate', 'paymentdate': 'paymentdate', 
    'éŠ€è¡Œ': 'bank', 'bank': 'bank', 'é‡‘é¡': 'amount', 'amount': 'amount', 'å‚™è¨»': 'note', 'note': 'note', 
    'æ—¥æœŸ': 'date', 'date': 'date', 'ç®¡é“': 'method', 'method': 'method', 
    'å°å¹£æˆæœ¬': 'cost_twd', 'cost_twd': 'cost_twd', 'cost': 'cost_twd', 
    'å¤–å¹£é‡‘é¡': 'amount_usd', 'amount_usd': 'amount_usd', 'type': 'type', 
    'å¹£åˆ¥': 'type', 'Type': 'type', 'USD': 'amount_usd', 'ç¾é‡‘': 'amount_usd'
};

const DataLoader = {
    load: async function(isInit=false, isManual=false) {
        try {
            if(isManual) CloudStatus.set('syncing', 'è³‡æ–™æ›´æ–°ä¸­...');
            const res = await fetch(`${API_URL}?password=${encodeURIComponent(USER_PASSWORD)}`);
            const json = await res.json();
            if(json.error) throw new Error(json.error);
            GLOBAL_DATA = { 
                wallet: { data: mapNormalize(json.wallet.data).reverse(), templates: mapNormalize(json.wallet.templates) }, 
                crypto: { data: mapNormalize(json.crypto.data), methods: json.crypto.methods, rate: json.crypto.rate },
                schedule: { data: mapNormalize(json.schedule.data) },
                config: json.config || {budget: 0} 
            };
            localStorage.setItem('myBillPass', USER_PASSWORD);
            document.getElementById('budgetInput').value = GLOBAL_DATA.config.budget;
            if(isInit) { 
                const loginOverlay = document.getElementById('loginOverlay');
                loginOverlay.style.opacity = '0';
                setTimeout(() => {
                    loginOverlay.style.display = 'none';
                    Nav.home(); 
                }, 500);
            }
            if(!document.getElementById('app-wallet').classList.contains('hidden-layer')) WalletApp.render();
            if(!document.getElementById('app-crypto').classList.contains('hidden-layer')) CryptoApp.render();
            if(!document.getElementById('app-schedule').classList.contains('hidden-layer')) ScheduleApp.render();
            setBtnLoading('loginBtn', false);
            if(isManual) CloudStatus.set('success', 'è³‡æ–™å·²æ›´æ–°');
        } catch(e) {
            console.error(e);
            if(isInit) { document.getElementById('loginError').innerText = e.message.includes("å¯†ç¢¼") ? 'âŒ å¯†ç¢¼éŒ¯èª¤' : 'âš ï¸ é€£ç·šå¤±æ•—'; setBtnLoading('loginBtn', false); if(e.message.includes("å¯†ç¢¼")) localStorage.removeItem('myBillPass'); } 
            else { CloudStatus.set('error'); }
        }
    }
};

function verifyLogin() { USER_PASSWORD = document.getElementById('passwordInput').value; if(!USER_PASSWORD) return; setBtnLoading('loginBtn', true, 'é©—è­‰ä¸­...'); DataLoader.load(true); }
function formatMoney(num) { if(!num && num !== 0) return '0'; return Number(num).toLocaleString(undefined, { maximumFractionDigits: 2 }); }
function parseMoney(numStr) { if(typeof numStr === 'number') return numStr; if(!numStr) return 0; const cleanStr = String(numStr).replace(/,/g, '').replace(/\s/g, ''); return parseFloat(cleanStr) || 0; }
function mapNormalize(arr) { if(!Array.isArray(arr)) return []; return arr.map(obj => { const newObj = {}; for(let k in obj) { const cleanKey = k.trim(); const mappedKey = DATA_KEY_MAP[cleanKey] || DATA_KEY_MAP[cleanKey.toLowerCase()] || cleanKey.toLowerCase(); newObj[mappedKey] = obj[k]; } return newObj; }); }

const WalletApp = {
    chart: null, chartType: 'pie',
    render: function() {
        const listSel = document.getElementById('w-list-month');
        if(listSel.innerHTML == "") initMonthSelect('w-list-month'); 
        const inputSel = document.getElementById('w-input-month');
        if(inputSel.innerHTML == "") initMonthSelect('w-input-month');
        const m = listSel.value;
        const data = GLOBAL_DATA.wallet.data.filter(r => String(r.month).trim() === m);
        const templates = GLOBAL_DATA.wallet.templates.sort((a,b) => (parseInt(a.billdate)||0) - (parseInt(b.billdate)||0));
        
        DomUtils.renderOptions('w-bank', templates.map(t => t.bankname), 'é¸æ“‡éŠ€è¡Œ');
        
        let total = 0, count = 0, alertList = [];
        const now = new Date(); const year = parseInt(m.substring(0, 4)); const month = parseInt(m.substring(4, 6));
        const frag = document.createDocumentFragment();
        templates.forEach(t => {
            const rec = data.find(r => r.bank === t.bankname);
            let rightEl, cls, clickEvent, delEvent;
            if(rec) { 
                total += parseMoney(rec.amount); count++; cls = 't-card logged'; 
                rightEl = DomUtils.createEl('div', 't-amount', `$${formatMoney(rec.amount)}`); 
                clickEvent = null; 
                delEvent = () => WalletApp.askDelete(rec.uuid, rec.bank); 
            } else { 
                cls = 't-card unlogged'; 
                rightEl = DomUtils.createEl('div', 'badge-todo', 'å¾…ç™»éŒ„', [], {style:'font-size:12px; padding:4px 8px; border-radius:10px; background:rgba(0,0,0,0.05);'}); 
                clickEvent = () => WalletApp.fill(t.bankname); 
                delEvent = null; 
                const billDay = parseInt(t.billdate); if (billDay) { const cutoff = new Date(year, month - 1, billDay + 1); if (now > cutoff) alertList.push(t.bankname); } 
            }

            const container = DomUtils.createEl('div', 'swipe-item-container');
            const card = DomUtils.createEl('div', cls);
            if(clickEvent) card.onclick = clickEvent;
            const content = DomUtils.createEl('div', 't-content');
            content.appendChild(DomUtils.createEl('div', 't-bank', t.bankname));
            content.appendChild(DomUtils.createEl('div', '', `çµå¸³æ—¥ ${t.billdate} / æ‰£æ¬¾æ—¥ ${t.paymentdate}`, [], {style:'font-size:12px;color:#8E8E93;'}));
            if(rec && rec.note) content.appendChild(DomUtils.createEl('div', '', rec.note, [], {style:'font-size:12px;color:#8E8E93;margin-top:2px;'}));
            card.appendChild(DomUtils.createEl('div', 't-icon', t.bankname.charAt(0))); card.appendChild(content); card.appendChild(rightEl);
            
            if(delEvent) {
                const bgAction = DomUtils.createEl('div', 'swipe-bg-action', 'åˆªé™¤');
                bgAction.onclick = delEvent;
                container.appendChild(bgAction);
                card.classList.add('swipable');
            }

            container.appendChild(card); frag.appendChild(container);
        });
        document.getElementById('w-list').innerHTML = ''; document.getElementById('w-list').appendChild(frag);
        document.getElementById('w-total').innerText = `$${formatMoney(total)}`; document.getElementById('w-count').innerText = `${count} ç­†ç´€éŒ„`;
        this.updateBudgetUI(total);
        const alertContainer = document.getElementById('alertContainer');
        if (alertList.length > 0) { alertContainer.innerHTML = `<div class="alert-box" style="background:#FFF8E1; border:1px solid #FFE082; color:#FF8F00; padding:15px; border-radius:20px; margin-bottom:20px; font-size:13px; display:flex; align-items:center; gap:10px;"><span style="font-size:20px;">ğŸ””</span><div><span style="font-weight:800;">å¾…ç™»éŒ„</span> ${alertList.join('ã€')}</div></div>`; } else { alertContainer.innerHTML = ''; }
        if(document.getElementById('chartDrawer').classList.contains('open')) this.renderChart(data);
    },
    updateBudgetUI: function(currentTotal) {
        const budget = GLOBAL_DATA.config.budget || 0;
        const container = document.getElementById('budgetContainer'); const fill = document.getElementById('budgetFill'); const txtLeft = document.getElementById('budgetLeftText');
        const emoji = document.getElementById('emojiStatus');
        if(budget > 0) { 
            container.style.display = 'block'; const pct = Math.min((currentTotal / budget) * 100, 100); const left = budget - currentTotal; fill.style.width = `${pct}%`; 
            if (pct < 80) { fill.style.background = '#34C759'; emoji.innerText = 'ğŸ˜Š'; } 
            else if (pct < 100) { fill.style.background = '#FF9500'; emoji.innerText = 'ğŸ˜“'; } 
            else { fill.style.background = '#FF3B30'; emoji.innerText = 'ğŸ’¸'; } 
            if(left >= 0) { txtLeft.innerText = `å‰©é¤˜ $${formatMoney(left)}`; txtLeft.style.color = '#8E8E93'; } else { txtLeft.innerText = `è¶…æ”¯ $${formatMoney(Math.abs(left))}`; txtLeft.style.color = '#FF3B30'; } 
        } else { container.style.display = 'none'; emoji.innerText = 'ğŸ˜Š'; }
    },
    toggleChart: function() { const drawer = document.getElementById('chartDrawer'); const btnText = document.getElementById('chartBtnText'); const btnIcon = document.getElementById('chartBtnIcon'); if (drawer.classList.contains('open')) { drawer.classList.remove('open'); btnText.innerText = "åˆ†æ"; btnIcon.innerText = "ğŸ“Š"; } else { drawer.classList.add('open'); btnText.innerText = "æ”¶èµ·"; btnIcon.innerText = "ğŸ”¼"; const m = document.getElementById('w-list-month').value; const data = GLOBAL_DATA.wallet.data.filter(r => String(r.month).trim() === m); this.renderChart(data); } },
    setChartType: function(type) { this.chartType = type; document.getElementById('btnChartPie').className = type === 'pie' ? 'chart-type-btn active' : 'chart-type-btn'; document.getElementById('btnChartBar').className = type === 'bar' ? 'chart-type-btn active' : 'chart-type-btn'; const m = document.getElementById('w-list-month').value; const data = GLOBAL_DATA.wallet.data.filter(r => String(r.month).trim() === m); this.renderChart(data); },
    renderChart: function(currentMonthData) {
        if(this.chart) this.chart.destroy(); const ctx = document.getElementById('expenseChart').getContext('2d');
        if (this.chartType === 'pie') { const grouped = {}; currentMonthData.forEach(r => { grouped[r.bank] = (grouped[r.bank] || 0) + parseMoney(r.amount); }); const labels = Object.keys(grouped); const data = Object.values(grouped); this.chart = new Chart(ctx, { type:'doughnut', data:{labels: labels, datasets:[{data: data, backgroundColor:['#007AFF','#5856D6','#FF2D55','#FF9500','#34C759', '#5AC8FA'], borderWidth:0}]}, options:{responsive:true, maintainAspectRatio:false, cutout:'70%', plugins:{legend:{display:true,position:'right',labels:{color:'#1D1D1F',boxWidth:10}}}} }); } 
        else { const labels = []; const data = []; const d = new Date(); for(let i=5; i>=0; i--) { const tempD = new Date(d.getFullYear(), d.getMonth() - i, 1); const mStr = `${tempD.getFullYear()}${String(tempD.getMonth()+1).padStart(2,'0')}`; labels.push(`${tempD.getMonth()+1}æœˆ`); const sum = GLOBAL_DATA.wallet.data.filter(r => String(r.month).trim() === mStr).reduce((acc, curr) => acc + parseMoney(curr.amount), 0); data.push(sum); } this.chart = new Chart(ctx, { type: 'bar', data: { labels: labels, datasets: [{ label: 'ç¸½æ”¯å‡º', data: data, backgroundColor: 'rgba(0, 122, 255, 0.6)', borderRadius: 4 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, tooltip: { callbacks: { label: (c) => '$' + c.parsed.y.toLocaleString() } } }, scales: { x: { ticks: { color: '#8E8E93' }, grid: { display: false } }, y: { ticks: { color: '#8E8E93' }, grid: { color: '#E5E5EA' } } } } }); }
    },
    submit: function() { const bank = document.getElementById('w-bank').value; const amt = document.getElementById('w-amount').value; const note = document.getElementById('w-note').value; const month = document.getElementById('w-input-month').value; if(bank=="è«‹é¸æ“‡" || !amt) return showToast('âš ï¸ è«‹å¡«å¯«å®Œæ•´'); const isDup = GLOBAL_DATA.wallet.data.some(r => r.bank === bank && String(r.month).trim() === month); if(isDup) customConfirm('æ­¤éŠ€è¡Œæœ¬æœˆå·²æœ‰ç´€éŒ„ï¼Œç¢ºå®šè¦æ–°å¢å—ï¼Ÿ', () => this.executeSubmit(bank, amt, note, month)); else this.executeSubmit(bank, amt, note, month); },
    executeSubmit: function(bank, amt, note, month) { const tpl = GLOBAL_DATA.wallet.templates.find(t=>t.bankname===bank); GLOBAL_DATA.wallet.data.unshift({bank, amount:amt, note, month, uuid: 'temp', paymentdate: tpl?tpl.paymentdate:'-'}); document.getElementById('w-list-month').value = month; this.render(); document.getElementById('w-amount').value=''; document.getElementById('w-note').value=''; setBtnLoading('w-submit', true, 'æ’ç¨‹ä¸­...'); setTimeout(() => setBtnLoading('w-submit', false), 500); SyncManager.add({ appName:'wallet', action:'post', bank, amount:amt, note, month, paymentDate: tpl?tpl.paymentdate:'-' }); },
    askDelete: function(uuid, bank) { if(activeSwipeEl) closeSwipe(activeSwipeEl); document.getElementById('actionTitle').innerText = bank; const rec = GLOBAL_DATA.wallet.data.find(r => r.uuid === uuid); document.getElementById('actionSubtitle').innerText = rec ? `å·²ç™»éŒ„ï¼š$${formatMoney(rec.amount)}` : ''; document.getElementById('btnActionEdit').onclick = () => { this.fill(bank); if(rec) { document.getElementById('w-amount').value = rec.amount; document.getElementById('w-note').value = rec.note; } closeModal('actionModal'); }; document.getElementById('btnActionDelete').onclick = () => { closeModal('actionModal'); customConfirm(`ç¢ºå®šè¦åˆªé™¤ ${bank} çš„ç´€éŒ„å—ï¼Ÿ`, () => { if(uuid === 'temp') GLOBAL_DATA.wallet.data = GLOBAL_DATA.wallet.data.filter(r => r.bank !== bank); else GLOBAL_DATA.wallet.data = GLOBAL_DATA.wallet.data.filter(r => r.uuid !== uuid); this.render(); SyncManager.add({ appName:'wallet', action:'delete', uuid }); }); }; openModal('actionModal'); },
    fill: function(bank) { document.getElementById('w-bank').value = bank; document.getElementById('w-amount').focus(); document.querySelector('.input-panel').scrollIntoView({behavior:'smooth'}); }
};

const CryptoApp = {
    mode: 'twd',
    render: function() {
        const frag = document.createDocumentFragment(); 
        const data = GLOBAL_DATA.crypto.data.sort((a,b) => new Date(b.date) - new Date(a.date)); 
        
        if(!document.getElementById('c-date').value) document.getElementById('c-date').valueAsDate = new Date();
        this.updateMethodSelect();
        const totalTwd = data.reduce((sum, r) => sum + parseMoney(r.cost_twd || r.cost), 0); 
        
        let rate = parseFloat(GLOBAL_DATA.crypto.rate);
        if (isNaN(rate) || rate <= 0) rate = 32.5;
        
        document.getElementById('c-total-twd').innerText = `$${formatMoney(totalTwd)} TWD`; 
        document.getElementById('c-total-usd').innerText = `â‰ˆ $${formatMoney(totalTwd/rate)} USD`;
        
        data.forEach(r => {
            let dateObj = new Date(r.date); 
            let subInfo = dateObj.getFullYear() + '-' + String(dateObj.getMonth() + 1).padStart(2, '0') + '-' + String(dateObj.getDate()).padStart(2, '0');
            
            const tAmount = DomUtils.createEl('div', 't-amount', `$${formatMoney(r.cost_twd || r.cost)}`); 
            // Force right align
            const rightSide = DomUtils.createEl('div', '', '', [], {style: 'text-align:right; min-width:80px;'}); 
            rightSide.appendChild(tAmount);
            
            const usd = parseMoney(r.amount_usd);
            const isUSD = (r.type && r.type.toUpperCase() === 'USD') || (usd > 0);

            if (isUSD) { 
                const cost = parseMoney(r.cost_twd || r.cost); 
                const calcRate = (usd > 0) ? (cost / usd).toFixed(2) : '0.00'; 
                const subVal = DomUtils.createEl('div', 'c-sub-value', `â‰ˆ $${formatMoney(usd)} USD `, [], {style:'font-size:12px; color:#34C759; text-align:right;'}); 
                subVal.appendChild(DomUtils.createEl('span', 'c-rate', `(@${calcRate})`, [], {style:'color:#8E8E93;'})); 
                rightSide.appendChild(subVal); 
            }
            
            let icon = isUSD ? 'ğŸ‡ºğŸ‡¸' : 'ğŸª™'; 
            const container = DomUtils.createEl('div', 'swipe-item-container'); 
            const bgAction = DomUtils.createEl('div', 'swipe-bg-action', 'åˆªé™¤'); 
            bgAction.onclick = () => CryptoApp.askDelete(r.uuid);
            const card = DomUtils.createEl('div', 't-card'); 
            const content = DomUtils.createEl('div', 't-content'); 
            content.appendChild(DomUtils.createEl('div', 't-bank', r.method)); 
            content.appendChild(DomUtils.createEl('div', '', `${subInfo} ${r.note ? '- '+r.note : ''}`, [], {style:'font-size:12px;color:#8E8E93'}));
            card.appendChild(DomUtils.createEl('div', 't-icon', icon)); 
            card.appendChild(content); 
            card.appendChild(rightSide); 
            
            card.classList.add('swipable'); 
            container.appendChild(bgAction); container.appendChild(card); frag.appendChild(container);
        });
        document.getElementById('c-list').innerHTML = ''; document.getElementById('c-list').appendChild(frag);
    },
    updateMethodSelect: function() { const methods = GLOBAL_DATA.crypto.methods; const sel = document.getElementById('c-method'); if(sel.options.length !== methods.length + 1) { const currentVal = sel.value; DomUtils.renderOptions('c-method', methods, 'é¸æ“‡ç®¡é“'); if(methods.includes(currentVal)) sel.value = currentVal; } },
    setMode: function(m) { this.mode = m; document.getElementById('seg-twd').className = m=='twd'?'segment-btn active':'segment-btn'; document.getElementById('seg-usd').className = m=='usd'?'segment-btn active':'segment-btn'; document.getElementById('c-usd-field').style.display = m=='usd'?'block':'none'; },
    submit: function() { const date = document.getElementById('c-date').value; const method = document.getElementById('c-method').value; const cost = document.getElementById('c-cost').value; const usd = document.getElementById('c-usd').value; const note = document.getElementById('c-note').value; if(method == "é¸æ“‡ç®¡é“" || !cost) return showToast('âš ï¸ è«‹å¡«å¯«å®Œæ•´'); if(this.mode === 'usd' && !usd) return showToast('âš ï¸ è«‹è¼¸å…¥å¤–å¹£é‡‘é¡'); const now = new Date(); const fullDate = new Date(date); fullDate.setHours(now.getHours(), now.getMinutes(), now.getSeconds()); const isoDate = fullDate.toISOString(); GLOBAL_DATA.crypto.data.unshift({ date: isoDate, method, cost_twd: cost, note, type: this.mode === 'usd' ? 'USD' : 'TWD', amount_usd: this.mode === 'usd' ? usd : 0, uuid: 'temp' }); this.render(); document.getElementById('c-cost').value = ''; document.getElementById('c-usd').value = ''; document.getElementById('c-note').value = ''; document.getElementById('c-cost').focus(); setBtnLoading('c-submit', true, 'æ’ç¨‹ä¸­...'); setTimeout(() => setBtnLoading('c-submit', false), 500); SyncManager.add({ appName: 'crypto', action: 'post', date: isoDate, method, cost, note, type: this.mode === 'usd' ? 'USD' : 'TWD', amount_usd: this.mode === 'usd' ? usd : 0, uuid: 'temp' }); },
    askDelete: function(uuid) { if(activeSwipeEl) closeSwipe(activeSwipeEl); customConfirm('åˆªé™¤æ­¤ç´€éŒ„?', () => { GLOBAL_DATA.crypto.data = GLOBAL_DATA.crypto.data.filter(r => r.uuid !== uuid); this.render(); SyncManager.add({ appName: 'crypto', action: 'delete', uuid }); }); },
    openSettings: function() { this.renderSettingsList(); let rate = parseFloat(GLOBAL_DATA.crypto.rate); if(isNaN(rate)) rate = 0; document.getElementById('cryptoSettingsRate').innerText = `ğŸ‡ºğŸ‡¸ 1 USD â‰ˆ ${rate.toFixed(2)} TWD`; document.getElementById('cryptoSettingsModal').classList.add('show'); },
    renderSettingsList: function() { const d = document.getElementById('cryptoMethodList'); d.innerHTML = ''; GLOBAL_DATA.crypto.methods.forEach(m => { const row = DomUtils.createEl('div', 'setup-row', '', [], {style:'display:flex; justify-content:space-between; padding:12px 0; border-bottom:1px solid #E5E5EA;'}); row.innerHTML = `<div><div style="font-weight:700">${m}</div></div><button class="btn-setup-action" style="color:#FF3B30; background:transparent; border:none;" onclick="CryptoApp.deleteMethod('${m}')">ğŸ—‘ï¸</button>`; d.appendChild(row); }); },
    addMethod: function() { const val = document.getElementById('newCryptoMethod').value; if(!val) return showToast('âš ï¸ è«‹è¼¸å…¥åç¨±'); setBtnLoading('btnAddCryptoMethod', true, 'æ–°å¢ä¸­...'); GLOBAL_DATA.crypto.methods.push(val); this.renderSettingsList(); this.updateMethodSelect(); document.getElementById('c-method').value = val; document.getElementById('newCryptoMethod').value = ''; CloudStatus.set('syncing'); fetch(API_URL, { method:'POST', mode:'no-cors', headers:{'Content-Type':'application/json'}, body:JSON.stringify({password:USER_PASSWORD, appName:'crypto', action:'config_add', methodName:val}) }).then(() => { setBtnLoading('btnAddCryptoMethod', false); CloudStatus.set('success'); }); },
    deleteMethod: function(name) { customConfirm(`åˆªé™¤ ${name}?`, () => { GLOBAL_DATA.crypto.methods = GLOBAL_DATA.crypto.methods.filter(m => m !== name); this.renderSettingsList(); this.updateMethodSelect(); CloudStatus.set('syncing'); fetch(API_URL, { method:'POST', mode:'no-cors', headers:{'Content-Type':'application/json'}, body:JSON.stringify({password:USER_PASSWORD, appName:'crypto', action:'config_delete', methodName:name}) }).then(() => { CloudStatus.set('success'); }); }); }
};

const ScheduleApp = {
    render: function() {
        const sel = document.getElementById('s-month-selector');
        if(sel.innerHTML == "") {
            const d = new Date();
            d.setMonth(d.getMonth() + 1);
            const frag = document.createDocumentFragment();
            for(let i=0; i<=12; i++) {
                const val = `${d.getFullYear()}${String(d.getMonth()+1).padStart(2,'0')}`;
                const opt = document.createElement('option');
                opt.value = val; opt.text = `${d.getFullYear()} å¹´ ${String(d.getMonth()+1).padStart(2,'0')} æœˆ`;
                frag.appendChild(opt); d.setMonth(d.getMonth()-1);
            }
            sel.appendChild(frag);
            if(sel.options.length > 1) sel.selectedIndex = 1;
        }
        const m = sel.value;
        document.getElementById('s-display-month').innerText = `${m.substring(0,4)} / ${m.substring(4,6)}`;
        const imgEl = document.getElementById('s-image');
        const emptyEl = document.getElementById('s-empty-msg');
        const spinner = document.getElementById('s-img-spinner');
        let viewer = null;
        if (imgEl._viewer) { viewer = imgEl._viewer; }
        const record = GLOBAL_DATA.schedule.data.find(r => String(r.month) === m);
        if(record && record.imageurl) { 
            if(imgEl.src !== record.imageurl) { 
                imgEl.style.opacity = '0'; imgEl.classList.remove('loaded'); spinner.style.display = 'block'; 
                if(viewer) { viewer.destroy(); imgEl._viewer = null; }
                imgEl.src = record.imageurl; 
            }
            imgEl.style.display = 'block'; emptyEl.style.display = 'none'; 
        } else { 
            imgEl.style.display = 'none'; spinner.style.display = 'none'; emptyEl.style.display = 'block'; 
        }
        const listDiv = document.getElementById('s-list'); listDiv.innerHTML = ''; const frag = document.createDocumentFragment();
        const sortedData = [...GLOBAL_DATA.schedule.data].sort((a, b) => (parseInt(b.month)||0) - (parseInt(a.month)||0));
        if (sortedData.length === 0) { const emptyState = DomUtils.createEl('div', '', 'å°šç„¡æ­·å²ç´€éŒ„', [], {style: 'text-align:center; color:#8E8E93; padding:20px; font-size:14px;'}); listDiv.appendChild(emptyState); } 
        else {
            sortedData.forEach(r => {
                const card = DomUtils.createEl('div', 't-card schedule-card'); card.onclick = () => ScheduleApp.selectMonth(r.month);
                const icon = DomUtils.createEl('div', 't-icon', 'ğŸ“…'); const content = DomUtils.createEl('div', 't-content', '', [], {style:'flex:1'});
                const mStr = String(r.month || '??????'); const displayMonth = mStr.length >= 6 ? `${mStr.substring(0,4)} / ${mStr.substring(4,6)}` : mStr;
                content.appendChild(DomUtils.createEl('div', 't-bank', displayMonth));
                const timeStr = r.timestamp ? new Date(r.timestamp).toLocaleDateString() : '';
                content.appendChild(DomUtils.createEl('div', '', `ä¸Šå‚³æ–¼ ${timeStr}`, [], {style:'font-size:12px;color:#8E8E93'}));
                
                const actions = DomUtils.createEl('div', 'card-actions', '', [], {style:'display:flex; gap:10px;'});
                const btnCopy = DomUtils.createEl('button', 'mini-action-btn', 'ğŸ”—'); 
                btnCopy.onclick = (e) => { e.stopPropagation(); ScheduleApp.copyLink(r.imageurl); };
                
                const btnDelete = DomUtils.createEl('button', 'mini-action-btn danger', 'ğŸ—‘ï¸'); 
                btnDelete.onclick = (e) => { e.stopPropagation(); ScheduleApp.delete(r.uuid); };
                
                actions.appendChild(btnCopy); actions.appendChild(btnDelete);
                card.appendChild(icon); card.appendChild(content); card.appendChild(actions); frag.appendChild(card);
            });
            listDiv.appendChild(frag);
        }
    },
    onImageLoad: function() { 
        const imgEl = document.getElementById('s-image'); const spinner = document.getElementById('s-img-spinner'); 
        spinner.style.display = 'none'; imgEl.classList.add('loaded'); imgEl.style.opacity = '1'; 
        if(imgEl._viewer) imgEl._viewer.destroy();
        imgEl._viewer = new Viewer(imgEl, { inline: false, toolbar: false, navbar: false, title: false, tooltip: false, movable: true, zoomable: true, rotatable: false, scalable: false, transition: true, backdrop: true });
    },
    onImageError: function() { document.getElementById('s-img-spinner').style.display = 'none'; showToast('âš ï¸ åœ–ç‰‡è¼‰å…¥å¤±æ•—'); },
    selectMonth: function(m) {
        if(!m) return;
        const sel = document.getElementById('s-month-selector'); let opt = sel.querySelector(`option[value="${m}"]`);
        if (!opt) { opt = document.createElement('option'); opt.value = m; opt.text = `${m.substring(0,4)} å¹´ ${m.substring(4,6)} æœˆ`; sel.appendChild(opt); }
        sel.value = m; this.render(); document.querySelector('#app-schedule .hero').scrollIntoView({behavior:'smooth'});
    },
    copyLink: function(url) { navigator.clipboard.writeText(url).then(() => showToast('âœ… é€£çµå·²è¤‡è£½')).catch(() => showToast('âŒ è¤‡è£½å¤±æ•—')); },
    handleUpload: async function(input) {
        if(!CLOUDINARY_CLOUD_NAME) return alert("è«‹å¡«å…¥ Cloud Name");

        const file = input.files[0]; if(!file) return;
        const m = document.getElementById('s-month-selector').value;
        const exists = GLOBAL_DATA.schedule.data.find(r => String(r.month) === m);
        if (exists) { input.value = ''; return customAlert('âš ï¸ è©²æœˆä»½å·²æœ‰ç­è¡¨ï¼Œè«‹å…ˆåˆªé™¤èˆŠç´€éŒ„å¾Œå†ä¸Šå‚³ã€‚'); }
        const spinner = document.getElementById('uploadSpinner'); spinner.style.display = 'inline-block';
        try {
            const compressedFile = await compressImage(file, 1024, 0.6);
            const formData = new FormData(); formData.append('file', compressedFile); formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);
            const res = await fetch(`https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/image/upload`, { method: 'POST', body: formData });
            const json = await res.json();
            if(!res.ok) throw new Error(json.error ? json.error.message : 'Upload Failed');
            const link = json.secure_url;
            GLOBAL_DATA.schedule.data.unshift({ month: m, imageurl: link, timestamp: new Date(), uuid: 'temp' });
            this.render(); SyncManager.add({ appName: 'schedule', action: 'post', month: m, url: link });
            showToast('âœ… ä¸Šå‚³æˆåŠŸ');
        } catch(e) { alert(`âŒ ä¸Šå‚³å¤±æ•—: ${e.message}`); console.error(e); } finally { spinner.style.display = 'none'; input.value = ''; }
    },
    delete: function(uuid) { customConfirm('ç¢ºå®šåˆªé™¤æ­¤ç­è¡¨?', () => { GLOBAL_DATA.schedule.data = GLOBAL_DATA.schedule.data.filter(r => r.uuid !== uuid); this.render(); SyncManager.add({ appName: 'schedule', action: 'delete', uuid }); }); }
};

function compressImage(file, maxWidth, quality) { return new Promise((resolve, reject) => { const reader = new FileReader(); reader.readAsDataURL(file); reader.onload = (event) => { const img = new Image(); img.src = event.target.result; img.onload = () => { const canvas = document.createElement('canvas'); let width = img.width; let height = img.height; if (width > maxWidth) { height = Math.round(height * (maxWidth / width)); width = maxWidth; } canvas.width = width; canvas.height = height; const ctx = canvas.getContext('2d'); ctx.drawImage(img, 0, 0, width, height); canvas.toBlob((blob) => { resolve(blob); }, 'image/jpeg', quality); }; img.onerror = (err) => reject(err); }; reader.onerror = (err) => reject(err); }); }
function saveBudget() { const b = parseInt(document.getElementById('budgetInput').value) || 0; setBtnLoading('btnSaveBudget', true, 'å„²å­˜ä¸­...'); GLOBAL_DATA.config.budget = b; WalletApp.render(); CloudStatus.set('syncing'); fetch(API_URL, { method:'POST', mode:'no-cors', headers:{'Content-Type':'application/json'}, body:JSON.stringify({password:USER_PASSWORD, action:'config_update', key:'Budget', value:b}) }).then(() => { setBtnLoading('btnSaveBudget', false); closeModal('settingsModal'); CloudStatus.set('success'); }); }
function openWalletSettings() { renderTemplateList(); document.getElementById('settingsModal').classList.add('show'); }
function openCryptoSettings() { CryptoApp.openSettings(); }
function closeModal(id) { document.getElementById(id).classList.remove('show'); }
function logout() { customConfirm('ç¢ºå®šç™»å‡º?', () => { localStorage.removeItem('myBillPass'); window.location.reload(true); }); }
function setBtnLoading(btnId, isLoading, text) { const btn = document.getElementById(btnId); const txtSpan = btn.querySelector('.btn-text'); if(isLoading) { btn.disabled = true; btn.classList.add('btn-loading'); if(txtSpan) { btn.dataset.orgText = txtSpan.innerText; txtSpan.innerText = text; } } else { btn.disabled = false; btn.classList.remove('btn-loading'); if(txtSpan && btn.dataset.orgText) { txtSpan.innerText = btn.dataset.orgText; } } }
function showToast(m) { const t=document.getElementById('toast'); t.innerText=m; t.className='show'; setTimeout(()=>t.className='', 2500); }
function manualReload() { if (SyncManager.isSyncing) { showToast("âš ï¸ é›²ç«¯åŒæ­¥ä¸­ï¼Œè«‹ç¨å¾Œå†åˆ·æ–°"); return; } CloudStatus.set('syncing', 'è³‡æ–™æ›´æ–°ä¸­...'); DataLoader.load(false, true); }
function customConfirm(msg, callback) { document.getElementById('confirmMsg').innerText = msg; const oldBtn = document.getElementById('confirmBtnAction'); const newBtn = oldBtn.cloneNode(true); oldBtn.parentNode.replaceChild(newBtn, oldBtn); newBtn.onclick = () => { closeModal('confirmModal'); callback(); }; openModal('confirmModal'); }
function customAlert(msg) { document.getElementById('alertMsg').innerText = msg; openModal('alertModal'); }
function openModal(id) { document.getElementById(id).classList.add('show'); }
function initMonthSelect(id) { const s=document.getElementById(id); if (!s) return; const startD = new Date(); startD.setMonth(startD.getMonth() + 1); const frag = document.createDocumentFragment(); for(let i=0; i<24; i++){ const v=`${startD.getFullYear()}${String(startD.getMonth()+1).padStart(2,'0')}`; const o=document.createElement('option'); o.value=v; o.text=`${startD.getFullYear()} / ${String(startD.getMonth()+1).padStart(2,'0')}`; frag.appendChild(o); startD.setMonth(startD.getMonth()-1); } s.appendChild(frag); const d=new Date(); s.value = `${d.getFullYear()}${String(d.getMonth()+1).padStart(2,'0')}`; }
function addTemplate() { const b=document.getElementById('newBank').value, bill=document.getElementById('newBill').value, pay=document.getElementById('newPay').value; if(!b||!bill||!pay) return showToast('âš ï¸ è«‹å¡«å¯«å®Œæ•´'); document.getElementById('newBank').value=''; document.getElementById('newBill').value=''; document.getElementById('newPay').value=''; 
    GLOBAL_DATA.wallet.templates.push({ bankname: b, billdate: bill, paymentdate: pay, templateindex: b });
    renderTemplateList(); WalletApp.render(); CloudStatus.set('syncing'); fetch(API_URL, { method:'POST', mode:'no-cors', headers:{'Content-Type':'application/json'}, body:JSON.stringify({password:USER_PASSWORD, appName:'wallet', action:'template_create', BankName:b, BillDate:bill, PaymentDate:pay}) }).then(() => { CloudStatus.set('success'); }); 
}
function saveTemplateEdit() { const idx = document.getElementById('editIndex').value; const bank = document.getElementById('editBankName').value; const bill = document.getElementById('editBill').value; const pay = document.getElementById('editPay').value; if(!bill || !pay) return showToast('âš ï¸ æ—¥æœŸä¸èƒ½ç‚ºç©º'); 
    const target = GLOBAL_DATA.wallet.templates.find(t => t.templateindex == idx); if (target) { target.billdate = bill; target.paymentdate = pay; }
    renderTemplateList(); WalletApp.render(); closeModal('editTemplateModal'); CloudStatus.set('syncing'); fetch(API_URL, { method:'POST', mode:'no-cors', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ password: USER_PASSWORD, appName:'wallet', action: 'template_update', templateIndex: idx, BankName: bank, BillDate: bill, PaymentDate: pay }) }).then(() => { CloudStatus.set('success'); }); 
}
function deleteTemplate(idx) { 
    customConfirm('ç¢ºå®šåˆªé™¤æ­¤éŠ€è¡Œ?', () => { 
        GLOBAL_DATA.wallet.templates = GLOBAL_DATA.wallet.templates.filter(t => t.templateindex !== String(idx));
        renderTemplateList(); WalletApp.render(); CloudStatus.set('syncing'); fetch(API_URL, { method:'POST', mode:'no-cors', headers:{'Content-Type':'application/json'}, body:JSON.stringify({password:USER_PASSWORD, appName:'wallet', action:'template_delete', templateIndex:idx}) }).then(()=> { CloudStatus.set('success'); }); 
    }); 
}
function openEditTemplateModal(index, bank, bill, pay) { document.getElementById('editIndex').value = index; document.getElementById('editBankName').value = bank; document.getElementById('editBill').value = bill; document.getElementById('editPay').value = pay; openModal('editTemplateModal'); }
function renderTemplateList() { const d = document.getElementById('templateList'); d.innerHTML=''; const sorted = [...GLOBAL_DATA.wallet.templates].sort((a,b) => (parseInt(a.billdate)||0) - (parseInt(b.billdate)||0)); sorted.forEach(t => { const n = t.bankname; const b = t.billdate; const p = t.paymentdate; const row = DomUtils.createEl('div', 'setup-row', '', [], {style:'display:flex; justify-content:space-between; padding:12px 0; border-bottom:1px solid #E5E5EA;'}); row.innerHTML = `<div><div style="font-weight:700">${n}</div><div style="font-size:12px;color:#8E8E93;">çµå¸³æ—¥ ${b} / æ‰£æ¬¾æ—¥ ${p}</div></div><div style="display:flex; gap:5px;"><button class="mini-action-btn" style="color:#007AFF; border:none; background:transparent;" onclick="openEditTemplateModal('${t.templateindex}', '${n}', '${b}', '${p}')">âœ</button><button class="mini-action-btn" style="color:#FF3B30; border:none; background:transparent;" onclick="deleteTemplate('${t.templateindex}')">ğŸ—‘ï¸</button></div>`; d.appendChild(row); }); }
</script>
</body>
</html>
