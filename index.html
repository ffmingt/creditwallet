<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>My Wallet V14.0</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* --- V14.0 Style System --- */
        :root { 
            --bg-body: #F9FAFB; 
            --primary: #4F46E5; 
            --primary-gradient: linear-gradient(135deg, #4F46E5 0%, #7C3AED 100%);
            --crypto-gradient: linear-gradient(135deg, #1F2937 0%, #059669 100%);
            --text-main: #1F2937; --text-sub: #6B7280; 
            --danger: #EF4444; --success: #10B981;
            --warning-bg: #FFF7ED; --warning-border: #FED7AA; --warning-text: #9A3412;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
        }
        
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; background: var(--bg-body); color: var(--text-main); margin: 0; padding-bottom: 140px; user-select: none; -webkit-user-select: none; overscroll-behavior-y: none; }

        .hidden-layer { display: none !important; }

        /* Login: z-index 2000 */
        #loginOverlay { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(249,250,251,0.98); backdrop-filter: blur(5px); z-index: 2000; display: flex; flex-direction: column; justify-content: center; align-items: center; transition: opacity 0.3s; }
        .login-input { width:240px; padding:15px; border:1px solid #E5E7EB; border-radius:16px; font-size:24px; text-align:center; outline:none; margin:20px 0; letter-spacing:8px; background:white; box-shadow: var(--shadow); }
        .login-input:focus { border-color: var(--primary); }
        #versionTag { position: absolute; bottom: 30px; font-size: 12px; color: #9CA3AF; font-weight: 500; cursor: pointer; padding: 10px; z-index: 2001; }

        /* Buttons & Loading */
        .btn-submit { width: 100%; background: #1F2937; color: white; border: none; padding: 15px; border-radius: 14px; font-size: 16px; font-weight: 600; margin-top: 10px; display: flex; justify-content: center; align-items: center; cursor: pointer; transition: transform 0.1s, background-color 0.2s; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .btn-submit:active { transform: scale(0.96); background-color: #000; }
        .btn-submit:disabled { background: #6B7280; opacity: 0.8; cursor: not-allowed; transform: none; }
        
        .spinner { width: 18px; height: 18px; min-width: 18px; margin-right: 8px; border: 2px solid rgba(255,255,255,0.3); border-radius: 50%; border-top-color: #fff; animation: spin 0.8s linear infinite; display: none; }
        .btn-loading .spinner { display: inline-block; } 
        @keyframes spin { to { transform: rotate(360deg); } }

        .btn-icon { background:white; border:1px solid #E5E7EB; padding:8px 12px; border-radius:12px; font-size:13px; font-weight:600; color:#555; box-shadow:0 1px 2px rgba(0,0,0,0.05); transition:0.1s; cursor: pointer; }
        .btn-icon:active { transform:scale(0.95); background: #f3f4f6; }

        /* Cloud Status: z-index 2000000 */
        #cloudStatus { position: fixed; top: 20px; left: 50%; transform: translateX(-50%) translateY(-200%); opacity: 0; background: white; padding: 8px 16px; border-radius: 30px; box-shadow: 0 4px 15px rgba(0,0,0,0.15); display: flex; align-items: center; gap: 8px; font-size: 13px; font-weight: 600; color: var(--text-main); z-index: 2000000; transition: all 0.5s cubic-bezier(0.34, 1.56, 0.64, 1); pointer-events: none; }
        #cloudStatus.show { transform: translateX(-50%) translateY(0); opacity: 1; }
        #cloudStatus.syncing { color: var(--primary); border: 1px solid #E0E7FF; }
        #cloudStatus.success { color: var(--success); border: 1px solid #D1FAE5; }
        #cloudStatus.error { color: var(--danger); border: 1px solid #FEE2E2; pointer-events: auto; cursor: pointer; }
        .status-icon { width: 16px; height: 16px; display: flex; justify-content: center; align-items: center; }
        .spin-circle { width: 14px; height: 14px; border: 2px solid #E0E7FF; border-top-color: var(--primary); border-radius: 50%; animation: spin 0.8s linear infinite; }

        /* Hub Layout */
        #app-hub { padding: 20px 24px; animation: fadeIn 0.4s ease; display: flex; flex-direction: column; height: 80vh; }
        .hub-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; flex-shrink: 0; }
        .hub-title { font-size: 28px; font-weight: 800; color: var(--text-main); margin: 0; }
        .app-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; flex: 1; align-content: start; }
        .app-card { background: white; border-radius: 24px; padding: 20px; box-shadow: var(--shadow); border: 1px solid transparent; display: flex; flex-direction: column; justify-content: space-between; height: 140px; cursor: pointer; transition: transform 0.1s; position: relative; }
        .app-card:active { transform: scale(0.96); background: #F3F4F6; }
        .app-icon { font-size: 32px; margin-bottom: 10px; }
        .app-name { font-size: 16px; font-weight: 700; color: var(--text-main); }
        .app-ver { position: absolute; bottom: 15px; right: 15px; font-size: 11px; color: #4B5563; font-weight: 500; background: #E5E7EB; padding: 2px 6px; border-radius: 6px; }
        
        /* Rate Bar */
        .rate-bar { margin-top: auto; background: #ECFDF5; border: 1px solid #D1FAE5; color: #047857; font-weight: 600; font-size: 14px; padding: 12px; border-radius: 16px; text-align: center; font-family: monospace; display: flex; justify-content: center; align-items: center; gap: 8px; }

        /* Wallet & Crypto Layout */
        .hero { padding: 20px 24px 10px 24px; }
        .header-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
        .app-title { font-size: 24px; font-weight: 800; color: #111; }
        
        .total-card { background: var(--primary-gradient); border-radius: 28px; padding: 25px; color: white; box-shadow: 0 20px 25px -5px rgba(79, 70, 229, 0.4); position: relative; overflow: hidden; transition: all 0.3s ease; }
        .crypto-bg { background: var(--crypto-gradient) !important; box-shadow: 0 20px 25px -5px rgba(5, 150, 105, 0.4) !important; }
        
        .total-amount { font-size: 42px; font-weight: 800; margin: 5px 0; letter-spacing: -1px; }
        .total-amount-group { display: flex; flex-direction: column; margin-top: 5px; }
        .total-amount-main { font-size: 42px; font-weight: 800; letter-spacing: -1px; line-height: 1.1; }
        .total-amount-sub { font-size: 18px; opacity: 0.9; font-weight: 500; color: #A7F3D0; margin-top: 4px; font-family: monospace; }
        .card-content { position: relative; z-index: 2; }
        .card-footer { display: flex; justify-content: space-between; align-items: center; margin-top: 5px; }
        .card-sub { font-size: 13px; opacity: 0.8; background: rgba(255,255,255,0.2); padding: 2px 8px; border-radius: 10px; }
        
        /* Budget Progress Bar */
        .budget-container { margin-top: 15px; margin-bottom: 5px; }
        .budget-bar-bg { background: rgba(0,0,0,0.2); height: 6px; border-radius: 3px; overflow: hidden; position: relative; }
        .budget-bar-fill { height: 100%; background: white; width: 0%; transition: width 0.5s ease, background-color 0.3s; border-radius: 3px; }
        .budget-text { font-size: 12px; font-weight: 600; margin-top: 4px; display: flex; justify-content: space-between; opacity: 0.9; }

        .status-emoji { position:absolute; top:30px; right:25px; font-size:48px; animation: float 3s ease-in-out infinite; pointer-events: none; z-index: 1; }
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-6px); } }

        .btn-chart-toggle { background: rgba(255, 255, 255, 0.2); border: 1px solid rgba(255, 255, 255, 0.3); color: white; padding: 6px 12px; border-radius: 20px; font-size: 13px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 5px; backdrop-filter: blur(5px); }
        .chart-drawer { max-height: 0; opacity: 0; overflow: hidden; transition: max-height 0.4s ease, opacity 0.3s ease; }
        .chart-drawer.open { max-height: 320px; opacity: 1; margin-top: 20px; border-top: 1px solid rgba(255,255,255,0.2); padding-top: 15px; }
        .chart-actions { display: flex; justify-content: center; gap: 10px; margin-bottom: 10px; }
        .chart-type-btn { background: rgba(255,255,255,0.15); border: none; color: white; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600; cursor: pointer; }
        .chart-type-btn.active { background: white; color: var(--primary); }

        /* Inputs */
        .input-panel { margin: 20px 24px 0; padding: 24px; background: white; border-radius: 24px; box-shadow: var(--shadow); border: 1px solid #F3F4F6; }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px; }
        .form-label { font-size: 12px; font-weight: 600; color: var(--text-sub); margin-bottom: 6px; display: block; }
        .styled-input { width: 100%; padding: 12px 14px; border-radius: 12px; border: 1px solid #E5E7EB; background: #F9FAFB; font-size: 16px; color: #333; outline: none; -webkit-appearance: none; }
        .styled-input:disabled { background: #E5E7EB; color: #9CA3AF; cursor: not-allowed; }
        .segment-control { display: flex; background: #F3F4F6; padding: 4px; border-radius: 14px; margin-bottom: 15px; }
        .segment-btn { flex: 1; padding: 8px; text-align: center; font-size: 13px; font-weight: 600; color: #6B7280; border-radius: 10px; cursor: pointer; transition: 0.2s; }
        .segment-btn.active { background: white; color: #1F2937; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }

        /* Lists & Swipe */
        .list-section { padding: 30px 24px; }
        .list-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; padding-bottom: 10px; border-bottom: 1px solid #EEE; }
        .list-title { font-size: 18px; font-weight: 800; color: var(--text-main); }
        .month-selector { border: none; background: transparent; font-size: 15px; font-weight: 600; color: var(--text-main); text-align: right; outline: none; cursor: pointer; }
        .refresh-btn { border: none; background: white; border-radius: 50%; width: 32px; height: 32px; margin-left: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); cursor: pointer; display: flex; justify-content: center; align-items: center; font-size: 16px; transition: transform 0.2s; }
        .refresh-btn:active { transform: rotate(180deg); }

        .swipe-item-container { position: relative; margin-bottom: 12px; height: 76px; overflow: hidden; border-radius: 18px; box-shadow: var(--shadow); }
        .swipe-bg-action { position: absolute; top: 0; bottom: 0; right: 0; width: 100px; background: var(--danger); display: flex; justify-content: center; align-items: center; color: white; font-weight: 700; font-size: 14px; letter-spacing: 1px; z-index: 1; border-radius: 18px; cursor: pointer; }
        
        .t-card { position: relative; z-index: 2; height: 100%; background: white; border-radius: 18px; padding: 16px; display: flex; align-items: center; gap: 14px; border: 1px solid #E5E7EB; transition: transform 0.2s cubic-bezier(0.2, 0.8, 0.2, 1); touch-action: pan-y; margin-bottom: 0; box-shadow: none; }
        .t-card.logged { border: 1px solid #E5E7EB; }
        .t-card.logged::before { content:''; position:absolute; left:0; top:0; bottom:0; width:5px; background: var(--success); }
        .t-card.unlogged { background: #F9FAFB; border: 1px dashed #D1D5DB; opacity: 0.98; }
        .t-card.unlogged .t-icon { background: #E5E7EB; color: #9CA3AF; }
        .t-icon { width: 42px; height: 42px; border-radius: 12px; background: #F3F4F6; color: #374151; font-size: 18px; font-weight: 700; display: flex; justify-content: center; align-items: center; flex-shrink: 0; }
        .t-content { flex: 1; min-width: 0; }
        .t-bank { font-size: 16px; font-weight: 700; color: var(--text-main); margin-bottom: 4px; }
        .t-amount { font-size: 18px; font-weight: 800; color: var(--text-main); text-align: right; }
        .c-sub-value { font-size: 12px; color: #059669; font-weight: 600; text-align: right; margin-top: 3px; font-family: monospace; }
        .c-rate { font-size: 11px; color: #9CA3AF; font-weight: 400; margin-left: 3px; }
        .badge-todo { font-size: 12px; font-weight: 600; color: #6B7280; background: #E5E7EB; padding: 4px 10px; border-radius: 20px; }

        .alert-box { background: var(--warning-bg); border: 1px solid var(--warning-border); color: var(--warning-text); padding: 16px; border-radius: 16px; margin-bottom: 20px; font-size: 14px; line-height: 1.6; display: flex; align-items: flex-start; gap: 12px; width: 100%; box-sizing: border-box; }
        .alert-icon { font-size: 20px; margin-top: -2px; flex-shrink: 0; }
        .alert-content { flex: 1; }
        .alert-title { font-weight: 700; margin-bottom: 2px; display: block; color: #7C2D12; }

        /* Modals: z-index 1,000,000 */
        .modal-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.5); backdrop-filter: blur(2px); z-index: 1000000; display: flex; justify-content: center; align-items: center; opacity: 0; pointer-events: none; transition: opacity 0.2s; }
        .modal-overlay.show { opacity: 1; pointer-events: auto; }
        .modal-box { background: white; width: 85%; max-width: 380px; border-radius: 24px; padding: 0; transform: scale(0.95); transition: 0.2s; max-height: 80vh; display: flex; flex-direction: column; overflow: hidden; }
        .modal-overlay.show .modal-box { transform: scale(1); }
        .modal-header { padding: 24px 24px 15px 24px; flex-shrink: 0; background: white; z-index: 10; }
        .modal-content-scroll { padding: 0 24px; overflow-y: auto; flex: 1; -webkit-overflow-scrolling: touch; }
        .modal-footer { padding: 15px 24px 24px 24px; flex-shrink: 0; background: white; border-top: 1px solid #F3F4F6; }
        .action-btn { display: block; width: 100%; padding: 14px; margin-bottom: 10px; border: none; border-radius: 12px; font-size: 16px; font-weight: 600; cursor: pointer; }
        .btn-edit { background: #F3F4F6; color: var(--text-main); }
        .btn-delete { background: #FEF2F2; color: var(--danger); }
        .setup-row { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid #F3F4F6; }
        .btn-setup-action { border: none; background: none; cursor: pointer; font-size: 14px; padding: 5px; transition: opacity 0.1s, transform 0.1s;}
        .btn-setup-action:active { opacity: 0.6; transform: scale(0.95); }

        /* Toast: z-index 2,000,000 */
        #toast { visibility: hidden; background: #333; color: #fff; padding: 12px 24px; border-radius: 50px; position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); z-index: 2000000; opacity:0; transition:0.3s; }
        #toast.show { visibility: visible; opacity: 1; bottom: 40px; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body ontouchstart="">

    <div id="cloudStatus"><div class="status-icon"><div class="spin-circle"></div></div><span id="cloudText">é›²ç«¯åŒæ­¥ä¸­...</span></div>
    <div id="toast"></div>

    <!-- Login -->
    <div id="loginOverlay">
        <div style="font-size:50px; margin-bottom:10px;">ğŸ”’</div>
        <div style="font-weight:800; font-size:22px;">App Hub</div>
        <input type="password" id="passwordInput" class="login-input" placeholder="â€¢â€¢â€¢â€¢" maxlength="8" inputmode="numeric">
        <button id="loginBtn" class="btn-submit" onclick="verifyLogin()" style="width:240px;">
            <div class="spinner"></div> <span class="btn-text">è§£é–</span>
        </button>
        <div id="loginError" style="color:var(--danger); margin-top:20px; min-height:20px;"></div>
        <!-- Version Tag for Cache Clear -->
        <div id="versionTag" onclick="LoginHandler.clickVersion()">v14.0</div>
    </div>

    <!-- Hub -->
    <div id="app-hub" class="hidden-layer">
        <div class="hub-header">
            <div class="hub-title">Apps</div>
            <button class="btn-icon" onclick="logout()" style="color:var(--danger);">ç™»å‡º</button>
        </div>
        <div class="app-grid">
            <div class="app-card" onclick="Nav.open('wallet')">
                <div><div class="app-icon">ğŸ’°</div><div class="app-name">My Wallet</div></div>
                <div class="app-ver">v9.4</div>
            </div>
            <div class="app-card" onclick="Nav.open('crypto')">
                <div><div class="app-icon">ğŸª™</div><div class="app-name">Crypto</div></div>
                <div class="app-ver">v1.8</div>
            </div>
        </div>
    </div>

    <!-- Wallet -->
    <div id="app-wallet" class="hidden-layer">
        <div class="hero">
            <div class="header-row">
                <div class="app-title">My Wallet</div>
                <div style="display:flex; gap:8px;">
                    <button class="btn-icon" onclick="openWalletSettings()">âš™ï¸ è¨­å®š</button>
                    <button class="btn-icon" onclick="Nav.home()" style="color:#4F46E5;">ğŸ  é¦–é </button>
                </div>
            </div>
            <div class="total-card">
                <div class="card-content">
                    <div style="font-size:14px; opacity:0.9;">æœ¬æœˆç¸½æ”¯å‡º</div>
                    <div class="total-amount" id="w-total">$0</div>
                    
                    <!-- Budget Progress Bar -->
                    <div class="budget-container" id="budgetContainer" style="display:none;">
                        <div class="budget-bar-bg"><div id="budgetFill" class="budget-bar-fill"></div></div>
                        <div class="budget-text">
                            <span id="budgetStatusText">é ç®—ç›£æ§</span>
                            <span id="budgetLeftText">å‰©é¤˜ $0</span>
                        </div>
                    </div>

                    <div class="card-footer">
                        <div class="card-sub" id="w-count">0 ç­†ç´€éŒ„</div>
                        <button class="btn-chart-toggle" onclick="WalletApp.toggleChart()"><span id="chartBtnIcon">ğŸ“Š</span> <span id="chartBtnText">åˆ†æ</span></button>
                    </div>
                </div>
                <div class="status-emoji" id="emojiStatus">ğŸ˜Š</div>
                <div class="chart-drawer" id="chartDrawer">
                    <div class="chart-actions">
                        <button class="chart-type-btn active" id="btnChartPie" onclick="WalletApp.setChartType('pie')">åœ“é¤…åœ–</button>
                        <button class="chart-type-btn" id="btnChartBar" onclick="WalletApp.setChartType('bar')">è¿‘åŠå¹´è¶¨å‹¢</button>
                    </div>
                    <div style="position:relative; height:200px; display:flex; justify-content:center;">
                        <canvas id="expenseChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        <div class="input-panel">
            <div style="display:flex; justify-content:space-between; margin-bottom:15px; border-bottom:1px solid #eee; padding-bottom:10px;">
                <span style="font-weight:600; color:#555;">è¨˜å¸³æœˆä»½</span>
                <select id="w-input-month" style="border:none; font-size:16px; font-weight:700; color:var(--primary); outline:none; background:transparent;"></select>
            </div>
            <div class="grid-2">
                <div><label class="form-label">éŠ€è¡Œ</label><select id="w-bank" class="styled-input"></select></div>
                <div><label class="form-label">é‡‘é¡</label><input type="number" id="w-amount" class="styled-input" placeholder="$0" inputmode="decimal"></div>
            </div>
            <label class="form-label">å‚™è¨»</label><input type="text" id="w-note" class="styled-input" placeholder="é¸å¡«...">
            <button id="w-submit" class="btn-submit" onclick="WalletApp.submit()">
                <div class="spinner"></div> <span class="btn-text">ï¼‹ ç¢ºèªè¨˜å¸³</span>
            </button>
        </div>
        <div class="list-section">
            <div class="list-header">
                <span class="list-title">å¸³å–®æ˜ç´°</span>
                <div style="display:flex; align-items:center;">
                    <select id="w-list-month" class="month-selector" onchange="WalletApp.render()"></select>
                    <button class="refresh-btn" onclick="manualReload()">â†»</button>
                </div>
            </div>
            <div id="alertContainer"></div>
            <div id="w-list"></div>
        </div>
    </div>

    <!-- Crypto -->
    <div id="app-crypto" class="hidden-layer">
        <div class="hero">
            <div class="header-row">
                <div class="app-title">Crypto</div>
                <div style="display:flex; gap:8px;">
                    <button class="btn-icon" onclick="openCryptoSettings()">âš™ï¸ è¨­å®š</button>
                    <button class="btn-icon" onclick="Nav.home()" style="color:#4F46E5;">ğŸ  é¦–é </button>
                </div>
            </div>
            <div class="total-card crypto-bg">
                <div class="card-content">
                    <div style="font-size:14px; opacity:0.9;">ç¸½æŠ•å…¥æˆæœ¬</div>
                    <div class="total-amount-group">
                        <div class="total-amount-main" id="c-total-twd">$0 TWD</div>
                        <div class="total-amount-sub" id="c-total-usd">â‰ˆ $0 USD</div>
                    </div>
                </div>
            </div>
        </div>
        <div class="input-panel">
            <div class="segment-control">
                <div class="segment-btn active" id="seg-twd" onclick="CryptoApp.setMode('twd')">ğŸ‡¹ğŸ‡¼ å°å¹£å…¥é‡‘</div>
                <div class="segment-btn" id="seg-usd" onclick="CryptoApp.setMode('usd')">ğŸ‡ºğŸ‡¸ å¤–å¹£å…¥é‡‘</div>
            </div>
            <div class="grid-2">
                <div><label class="form-label">å…¥é‡‘æ—¥æœŸ</label><input type="date" id="c-date" class="styled-input"></div>
                <div><label class="form-label">å…¥é‡‘ç®¡é“</label><select id="c-method" class="styled-input"></select></div>
            </div>
            <div class="grid-2">
                <div><label class="form-label">æŠ•å…¥æˆæœ¬ (TWD)</label><input type="number" id="c-cost" class="styled-input" placeholder="å°å¹£é‡‘é¡" inputmode="decimal"></div>
                <div id="c-usd-field" style="display:none;"><label class="form-label">æ›å¾—é‡‘é¡ (U)</label><input type="number" id="c-usd" class="styled-input" placeholder="ç¾é‡‘/U" inputmode="decimal"></div>
            </div>
            <label class="form-label">å‚™è¨»</label><input type="text" id="c-note" class="styled-input" placeholder="é¸å¡«...">
            <button id="c-submit" class="btn-submit" onclick="CryptoApp.submit()">
                <div class="spinner"></div> <span class="btn-text">ï¼‹ æ–°å¢ç´€éŒ„</span>
            </button>
        </div>
        <div class="list-section">
            <div class="list-header">
                <span class="list-title">æŠ•è³‡ç´€éŒ„</span>
                <button class="refresh-btn" onclick="manualReload()">â†»</button>
            </div>
            <div id="c-list"></div>
        </div>
    </div>

    <!-- Modals -->
    <div id="actionModal" class="modal-overlay">
        <div class="modal-box" style="display:block; padding:24px;">
            <div style="text-align:center; margin-bottom:20px;">
                <div id="actionTitle" style="font-size:18px; font-weight:800;"></div>
                <div id="actionSubtitle" style="font-size:14px; color:#6B7280; margin-top:5px;"></div>
            </div>
            <button class="action-btn btn-edit" id="btnActionEdit">âœï¸ ä¿®æ”¹ / å¡«å…¥</button>
            <button class="action-btn btn-delete" id="btnActionDelete">ğŸ—‘ï¸ åˆªé™¤ç´€éŒ„</button>
            <button class="action-btn" style="background:white; color:#888; margin-bottom:0;" onclick="closeModal('actionModal')">å–æ¶ˆ</button>
        </div>
    </div>

    <div id="settingsModal" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-header">
                <div style="font-size:18px; font-weight:800; margin-bottom:15px;">Wallet è¨­å®š</div>
                <!-- Budget Setting -->
                <div style="background:#FFF7ED; padding:15px; border-radius:16px; margin-bottom:15px; border:1px solid #FED7AA;">
                    <label class="form-label" style="color:#9A3412;">æ¯æœˆé ç®—ç›®æ¨™ ($)</label>
                    <div style="display:flex; gap:10px;">
                        <input type="number" id="budgetInput" class="styled-input" placeholder="ä¾‹å¦‚: 30000" style="background:white;" inputmode="numeric">
                        <button id="btnSaveBudget" class="btn-submit" onclick="saveBudget()" style="width:80px; margin-top:0; background:#9A3412;"><div class="spinner"></div><span class="btn-text">å„²å­˜</span></button>
                    </div>
                </div>

                <div style="font-size:14px; font-weight:700; margin-bottom:10px;">æ–°å¢éŠ€è¡Œå¡ç‰‡</div>
                <div style="background:#F9FAFB; padding:15px; border-radius:16px;">
                    <input type="text" id="newBank" class="styled-input" placeholder="éŠ€è¡Œåç¨± (ä¾‹: ä¸­ä¿¡)" style="margin-bottom:10px; background:white;">
                    <div class="grid-2">
                        <input type="number" id="newBill" class="styled-input" placeholder="çµå¸³æ—¥" style="background:white;">
                        <input type="number" id="newPay" class="styled-input" placeholder="æ‰£æ¬¾æ—¥" style="background:white;">
                    </div>
                    <button id="btnAddTemp" class="btn-submit" onclick="addTemplate()" style="padding:10px; font-size:14px;"><div class="spinner"></div><span class="btn-text">ï¼‹ æ–°å¢</span></button>
                </div>
                <div style="font-size:12px; color:#999; margin-top:15px; font-weight:700;">å·²å„²å­˜çš„éŠ€è¡Œ</div>
            </div>
            <div class="modal-content-scroll"><div id="templateList"></div></div>
            <div class="modal-footer"><button class="btn-submit" onclick="closeModal('settingsModal')" style="background:#F3F4F6; color:#333; margin-top:0;">é—œé–‰</button></div>
        </div>
    </div>

    <div id="cryptoSettingsModal" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-header">
                <div style="font-size:18px; font-weight:800; margin-bottom:15px;">å…¥é‡‘ç®¡é“è¨­å®š</div>
                <div style="background:#F9FAFB; padding:15px; border-radius:16px;">
                    <label class="form-label">æ–°å¢ç®¡é“</label>
                    <input type="text" id="newCryptoMethod" class="styled-input" placeholder="ä¾‹å¦‚: MAX, ä¿¡ç”¨å¡..." style="background:white;">
                    <button id="btnAddCryptoMethod" class="btn-submit" onclick="CryptoApp.addMethod()" style="padding:10px; font-size:14px;"><div class="spinner"></div><span class="btn-text">ï¼‹ æ–°å¢</span></button>
                </div>
                <div style="font-size:12px; color:#999; margin-top:15px; font-weight:700;">å·²å„²å­˜ç®¡é“</div>
            </div>
            <div class="modal-content-scroll"><div id="cryptoMethodList"></div></div>
            <div class="modal-footer">
                <div id="cryptoSettingsRate" class="rate-bar">Loading...</div>
                <button class="btn-submit" onclick="closeModal('cryptoSettingsModal')" style="background:#F3F4F6; color:#333; margin-top:0;">é—œé–‰</button>
            </div>
        </div>
    </div>

    <div id="editTemplateModal" class="modal-overlay">
        <div class="modal-box" style="display:block; padding:24px;">
            <div style="font-size:18px; font-weight:800; margin-bottom:15px;">ç·¨è¼¯éŠ€è¡Œè³‡è¨Š</div>
            <input type="hidden" id="editIndex">
            <label class="form-label">éŠ€è¡Œåç¨± (ä¸å¯ä¿®æ”¹)</label>
            <input type="text" id="editBankName" class="styled-input" style="margin-bottom:15px;" disabled>
            <div class="grid-2">
                <div><label class="form-label">çµå¸³æ—¥</label><input type="number" id="editBill" class="styled-input"></div>
                <div><label class="form-label">æ‰£æ¬¾æ—¥</label><input type="number" id="editPay" class="styled-input"></div>
            </div>
            <div style="display:flex; gap:10px; margin-top:15px;">
                <button class="btn-submit" onclick="closeModal('editTemplateModal')" style="background:#F3F4F6; color:#333; margin-top:0;">å–æ¶ˆ</button>
                <button id="btnSaveEdit" class="btn-submit" onclick="saveTemplateEdit()" style="margin-top:0;"><div class="spinner"></div> <span class="btn-text">å„²å­˜</span></button>
            </div>
            <div style="font-size:12px; color:#999; margin-top:15px; text-align:center;">å¦‚éœ€ä¿®æ”¹éŠ€è¡Œåç¨±ï¼Œè«‹åˆªé™¤å¾Œé‡æ–°æ–°å¢ã€‚</div>
        </div>
    </div>

    <!-- Common Alert/Confirm Modals -->
    <div id="alertModal" class="modal-overlay">
        <div class="modal-box" style="display:block; padding:24px;">
            <div id="alertMsg" style="font-size:16px; color:#333; margin-bottom:20px; line-height:1.5;"></div>
            <div style="display:flex; gap:10px; justify-content:flex-end;">
                <button class="action-btn" style="width:auto; background:#1F2937; color:white; margin:0;" onclick="closeModal('alertModal')">ç¢ºå®š</button>
            </div>
        </div>
    </div>

    <div id="confirmModal" class="modal-overlay">
        <div class="modal-box" style="display:block; padding:24px;">
            <div id="confirmMsg" style="font-size:16px; color:#333; margin-bottom:20px; line-height:1.5;"></div>
            <div style="display:flex; gap:10px; justify-content:flex-end;">
                <button class="action-btn" style="width:auto; background:#F3F4F6; margin:0;" onclick="closeModal('confirmModal')">å–æ¶ˆ</button>
                <button class="action-btn" style="width:auto; background:#1F2937; color:white; margin:0;" id="confirmBtnAction">ç¢ºå®š</button>
            </div>
        </div>
    </div>

<script>
// ==========================================
// ğŸ”´ è«‹æ›¿æ›ç‚ºä½ çš„ GAS API ç¶²å€
const API_URL = "https://script.google.com/macros/s/AKfycby60jdswu4PguQ0YNMpYdfdOewU-YscwRvOpcVxZhV7KNpwhVzSO7tJ8vNx1fPmw_tjGw/exec";
// ==========================================

let USER_PASSWORD = "";
let GLOBAL_DATA = { wallet: {data:[], templates:[]}, crypto: {data:[], methods:[], rate: 32.5}, config: {budget: 0} };

const DATA_KEY_MAP = { 
    'éŠ€è¡Œåç¨±': 'bankname', 'bankname': 'bankname', 'çµå¸³æ—¥': 'billdate', 'billdate': 'billdate', 'æ‰£æ¬¾æ—¥': 'paymentdate', 'paymentdate': 'paymentdate', 
    'éŠ€è¡Œ': 'bank', 'bank': 'bank', 'é‡‘é¡': 'amount', 'amount': 'amount', 'å‚™è¨»': 'note', 'note': 'note', 'æœˆä»½': 'month', 'month': 'month', 
    'uuid': 'uuid', 'UUID': 'uuid', 'æ—¥æœŸ': 'date', 'date': 'date', 'ç®¡é“': 'method', 'method': 'method', 
    
    // Complete Mapping Table for Crypto
    'å°å¹£æˆæœ¬': 'cost_twd', 'cost_twd': 'cost_twd', 'cost': 'cost_twd', 'costtwd': 'cost_twd', 'CostTWD': 'cost_twd',
    'å¤–å¹£é‡‘é¡': 'amount_usd', 'amount_usd': 'amount_usd', 'amountusd': 'amount_usd', 'AmountUSD': 'amount_usd',
    'å¹£åˆ¥': 'type', 'type': 'type' 
};

// ğŸŸ¡ Login Handler
const LoginHandler = {
    clickCount: 0, timer: null,
    clickVersion: function() {
        this.clickCount++; clearTimeout(this.timer); this.timer = setTimeout(() => { this.clickCount = 0; }, 2000);
        if (this.clickCount === 5) {
            this.clickCount = 0;
            customConfirm('ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰å¿«å–è¨­å®šä¸¦é‡ç½®å—ï¼Ÿ', () => { localStorage.clear(); window.location.reload(); });
        }
    }
};

document.addEventListener('DOMContentLoaded', () => {
    const savedPass = localStorage.getItem('myBillPass');
    if(savedPass) {
        document.getElementById('passwordInput').value = savedPass;
        USER_PASSWORD = savedPass;
        setBtnLoading('loginBtn', true, 'è‡ªå‹•ç™»å…¥ä¸­...');
        DataLoader.load(true);
    }
});

const Nav = {
    open: function(appId) {
        document.querySelectorAll('.hidden-layer, #app-hub, #app-wallet, #app-crypto').forEach(el => el.classList.add('hidden-layer'));
        document.getElementById('app-' + appId).classList.remove('hidden-layer');
        if(appId === 'wallet') WalletApp.render();
        if(appId === 'crypto') CryptoApp.render();
    },
    home: function() {
        document.querySelectorAll('.hidden-layer, #app-wallet, #app-crypto').forEach(el => el.classList.add('hidden-layer'));
        document.getElementById('app-hub').classList.remove('hidden-layer');
    }
};

// ğŸŸ¡ Swipe Logic
let touchStartX = 0; let touchStartY = 0; let activeSwipeEl = null;
document.addEventListener('touchstart', (e) => {
    const card = e.target.closest('.t-card'); if (!card) { if (activeSwipeEl) closeSwipe(activeSwipeEl); return; }
    touchStartX = e.touches[0].clientX; touchStartY = e.touches[0].clientY;
    if (activeSwipeEl && activeSwipeEl !== card) closeSwipe(activeSwipeEl);
    card.style.transition = 'none';
}, { passive: true });
document.addEventListener('touchmove', (e) => {
    if (!touchStartX) return; const card = e.target.closest('.t-card'); if (!card) return;
    const diffX = e.touches[0].clientX - touchStartX; const diffY = e.touches[0].clientY - touchStartY;
    if (Math.abs(diffY) > Math.abs(diffX)) return;
    if (diffX < 0 && diffX > -120) { e.preventDefault(); card.style.transform = `translateX(${diffX}px)`; } 
    else if (diffX > 0) { card.style.transform = `translateX(0px)`; }
}, { passive: false });
document.addEventListener('touchend', (e) => {
    const card = e.target.closest('.t-card'); if (!card) return;
    card.style.transition = 'transform 0.2s cubic-bezier(0.2, 0.8, 0.2, 1)';
    const currentX = new WebKitCSSMatrix(window.getComputedStyle(card).transform).m41;
    if (currentX < -40) { card.style.transform = `translateX(-100px)`; activeSwipeEl = card; } 
    else { card.style.transform = `translateX(0px)`; activeSwipeEl = null; }
    touchStartX = 0;
});
function closeSwipe(el) { if(!el) return; el.style.transform = 'translateX(0px)'; activeSwipeEl = null; }

const SyncManager = {
    queue: [], isSyncing: false, totalTasks: 0, completed: 0,
    add: function(payload) { this.queue.push(payload); if (!this.isSyncing) { this.totalTasks = this.queue.length; this.completed = 0; } else { this.totalTasks++; } this.updateUI(); this.process(); },
    updateUI: function() { const pending = this.queue.length; if (pending > 0) { const current = this.totalTasks - pending + 1; CloudStatus.set('syncing', `åŒæ­¥ä¸­ (${current}/${this.totalTasks})...`); } else { CloudStatus.set('success'); this.totalTasks = 0; this.completed = 0; } },
    process: async function() {
        if (this.isSyncing || this.queue.length === 0) return;
        this.isSyncing = true;
        while (this.queue.length > 0) {
            this.updateUI(); const currentTask = this.queue[0];
            let success = false;
            for(let i=0; i<3; i++) { 
                try {
                    const f = fetch(API_URL, { method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ ...currentTask, password: USER_PASSWORD }) });
                    await Promise.race([f, new Promise((_, r) => setTimeout(() => r(new Error('Timeout')), 8000))]);
                    success = true; break;
                } catch(e) { await new Promise(r => setTimeout(r, 1500)); }
            }
            if(success) { this.queue.shift(); this.completed++; await new Promise(r => setTimeout(r, 500)); } 
            else { CloudStatus.set('error'); this.isSyncing = false; return; }
        }
        this.isSyncing = false; this.updateUI(); DataLoader.load(); 
    }
};

const CloudStatus = {
    el: document.getElementById('cloudStatus'), icon: document.querySelector('#cloudStatus .status-icon'), text: document.getElementById('cloudText'), timer: null,
    set: function(state, customText) {
        clearTimeout(this.timer); this.el.className = 'show ' + state;
        if (state === 'success') { this.icon.innerHTML = 'âœ…'; this.text.innerText = customText || 'å·²å„²å­˜'; this.timer = setTimeout(() => { this.el.className = ''; }, 2000); } 
        else if (state === 'syncing') { this.icon.innerHTML = '<div class="spin-circle"></div>'; this.text.innerText = customText || 'é›²ç«¯åŒæ­¥ä¸­...'; } 
        else if (state === 'error') { this.icon.innerHTML = 'âŒ'; this.text.innerText = 'åŒæ­¥å¤±æ•—'; this.el.onclick = () => SyncManager.process(); }
    }
};

const DataLoader = {
    load: async function(isInit=false, isManual=false) {
        try {
            if(isManual) CloudStatus.set('syncing', 'è³‡æ–™æ›´æ–°ä¸­...');
            const res = await fetch(`${API_URL}?password=${encodeURIComponent(USER_PASSWORD)}`);
            const json = await res.json();
            if(json.error) throw new Error(json.error);
            GLOBAL_DATA = { 
                wallet: { data: mapNormalize(json.wallet.data).reverse(), templates: mapNormalize(json.wallet.templates) }, 
                crypto: { data: mapNormalize(json.crypto.data), methods: json.crypto.methods, rate: json.crypto.rate },
                config: json.config || {budget: 0} 
            };
            localStorage.setItem('myBillPass', USER_PASSWORD);
            
            // Populate settings
            document.getElementById('budgetInput').value = GLOBAL_DATA.config.budget;

            if(isInit) { document.getElementById('loginOverlay').style.display = 'none'; document.getElementById('app-hub').classList.remove('hidden-layer'); }
            if(!document.getElementById('app-wallet').classList.contains('hidden-layer')) WalletApp.render();
            if(!document.getElementById('app-crypto').classList.contains('hidden-layer')) CryptoApp.render();
            setBtnLoading('loginBtn', false);
            if(isManual) CloudStatus.set('success', 'è³‡æ–™å·²æ›´æ–°');
        } catch(e) {
            console.error(e);
            if(isInit) { document.getElementById('loginError').innerText = e.message.includes("å¯†ç¢¼") ? 'âŒ å¯†ç¢¼éŒ¯èª¤' : 'âš ï¸ é€£ç·šå¤±æ•—'; setBtnLoading('loginBtn', false); if(e.message.includes("å¯†ç¢¼")) localStorage.removeItem('myBillPass'); } 
            else { CloudStatus.set('error'); }
        }
    }
};

function verifyLogin() { USER_PASSWORD = document.getElementById('passwordInput').value; if(!USER_PASSWORD) return; setBtnLoading('loginBtn', true, 'é©—è­‰ä¸­...'); DataLoader.load(true); }
// ğŸŸ¢ Fix: Robust Money Parsing
function formatMoney(num) { if(!num && num !== 0) return '0'; return Number(num).toLocaleString(undefined, { maximumFractionDigits: 2 }); }
function parseMoney(numStr) { 
    if(typeof numStr === 'number') return numStr;
    if(!numStr) return 0;
    // Remove commas and spaces, then parse
    const cleanStr = String(numStr).replace(/,/g, '').replace(/\s/g, '');
    return parseFloat(cleanStr) || 0; 
}

// --- Wallet Logic ---
const WalletApp = {
    chart: null, chartType: 'pie',
    render: function() {
        const fragList = document.createDocumentFragment();
        const listSel = document.getElementById('w-list-month');
        if(listSel.innerHTML == "") initMonthSelect('w-list-month'); 
        const inputSel = document.getElementById('w-input-month');
        if(inputSel.innerHTML == "") initMonthSelect('w-input-month');

        const m = listSel.value;
        const data = GLOBAL_DATA.wallet.data.filter(r => String(r.month).trim() === m);
        const templates = GLOBAL_DATA.wallet.templates.sort((a,b) => (parseInt(a.billdate)||0) - (parseInt(b.billdate)||0));
        
        const sel = document.getElementById('w-bank');
        if(sel.options.length <= 1) {
            let ops = ['<option disabled selected>é¸æ“‡éŠ€è¡Œ</option>'];
            templates.forEach(t => ops.push(`<option value="${t.bankname}">${t.bankname}</option>`));
            sel.innerHTML = ops.join('');
        }

        let total = 0, count = 0, alertList = [];
        const now = new Date(); const year = parseInt(m.substring(0, 4)); const month = parseInt(m.substring(4, 6));

        templates.forEach(t => {
            const rec = data.find(r => r.bank === t.bankname);
            let right = `<div class="badge-todo">å¾…ç™»éŒ„</div>`, cls = 't-card unlogged', click = `WalletApp.fill('${t.bankname}')`;
            let delFunc = ``;
            if(rec) {
                total += parseMoney(rec.amount); count++; cls = 't-card logged';
                right = `<div class="t-amount">$${formatMoney(rec.amount)}</div>`;
                click = ``; delFunc = `WalletApp.askDelete('${rec.uuid}', '${rec.bank}')`;
            } else {
                const billDay = parseInt(t.billdate);
                if (billDay) { const cutoff = new Date(year, month - 1, billDay + 1); if (now > cutoff) alertList.push(t.bankname); }
            }
            
            const container = document.createElement('div'); container.className = 'swipe-item-container';
            container.innerHTML = `<div class="swipe-bg-action" onclick="${delFunc}">åˆªé™¤</div><div class="t-card ${rec ? 'logged' : 'unlogged'}" onclick="${click}"><div class="t-icon">${t.bankname.charAt(0)}</div><div class="t-content"><div class="t-bank">${t.bankname}</div><div style="font-size:12px;color:#888">çµå¸³æ—¥ ${t.billdate} / æ‰£æ¬¾æ—¥ ${t.paymentdate}</div>${rec && rec.note ? `<div style="font-size:12px;color:#6B7280;margin-top:2px;">${rec.note}</div>` : ''}</div>${right}</div>`;
            fragList.appendChild(container);
        });
        
        document.getElementById('w-list').innerHTML = ''; document.getElementById('w-list').appendChild(fragList);
        document.getElementById('w-total').innerText = `$${formatMoney(total)}`; document.getElementById('w-count').innerText = `${count} ç­†ç´€éŒ„`;
        
        this.updateBudgetUI(total);
        const alertContainer = document.getElementById('alertContainer');
        if (alertList.length > 0) alertContainer.innerHTML = `<div class="alert-box"><span class="alert-icon">ğŸ””</span><div class="alert-content"><span class="alert-title">å¾…ç™»éŒ„æé†’</span>${alertList.join('ã€')} å¸³å–®å·²çµå¸³ï¼Œè«‹æ ¸å°ä¸¦ç™»éŒ„é‡‘é¡ã€‚</div></div>`; else alertContainer.innerHTML = '';
        if(document.getElementById('chartDrawer').classList.contains('open')) this.renderChart(data);
    },
    updateBudgetUI: function(currentTotal) {
        const budget = GLOBAL_DATA.config.budget || 0;
        const container = document.getElementById('budgetContainer');
        const fill = document.getElementById('budgetFill');
        const txtLeft = document.getElementById('budgetLeftText');

        if(budget > 0) {
            container.style.display = 'block';
            const pct = Math.min((currentTotal / budget) * 100, 100);
            const left = budget - currentTotal;
            fill.style.width = `${pct}%`;
            if (pct < 80) { fill.style.backgroundColor = '#10B981'; } else if (pct < 100) { fill.style.backgroundColor = '#F59E0B'; } else { fill.style.backgroundColor = '#EF4444'; }
            if(left >= 0) { txtLeft.innerText = `å‰©é¤˜ $${formatMoney(left)}`; txtLeft.style.color = '#1F2937'; }
            else { txtLeft.innerText = `è¶…æ”¯ $${formatMoney(Math.abs(left))}`; txtLeft.style.color = '#EF4444'; }
        } else { container.style.display = 'none'; }
    },
    toggleChart: function() { const drawer = document.getElementById('chartDrawer'); const btnText = document.getElementById('chartBtnText'); const btnIcon = document.getElementById('chartBtnIcon'); if (drawer.classList.contains('open')) { drawer.classList.remove('open'); btnText.innerText = "åˆ†æ"; btnIcon.innerText = "ğŸ“Š"; } else { drawer.classList.add('open'); btnText.innerText = "æ”¶èµ·"; btnIcon.innerText = "ğŸ”¼"; const m = document.getElementById('w-list-month').value; const data = GLOBAL_DATA.wallet.data.filter(r => String(r.month).trim() === m); this.renderChart(data); } },
    setChartType: function(type) { this.chartType = type; document.getElementById('btnChartPie').className = type === 'pie' ? 'chart-type-btn active' : 'chart-type-btn'; document.getElementById('btnChartBar').className = type === 'bar' ? 'chart-type-btn active' : 'chart-type-btn'; const m = document.getElementById('w-list-month').value; const data = GLOBAL_DATA.wallet.data.filter(r => String(r.month).trim() === m); this.renderChart(data); },
    renderChart: function(currentMonthData) {
        if(this.chart) this.chart.destroy(); const ctx = document.getElementById('expenseChart').getContext('2d');
        if (this.chartType === 'pie') {
            const grouped = {}; currentMonthData.forEach(r => { grouped[r.bank] = (grouped[r.bank] || 0) + parseMoney(r.amount); });
            const labels = Object.keys(grouped); const data = Object.values(grouped);
            this.chart = new Chart(ctx, { type:'doughnut', data:{labels: labels, datasets:[{data: data, backgroundColor:['#4F46E5','#7C3AED','#EC4899','#F59E0B','#10B981', '#3B82F6'], borderWidth:2, borderColor:'rgba(255,255,255,0.2)'}]}, options:{responsive:true, maintainAspectRatio:false, cutout:'65%', plugins:{legend:{display:true,position:'right',labels:{color:'white',boxWidth:10}}}} });
        } else {
            const labels = []; const data = []; const d = new Date();
            for(let i=5; i>=0; i--) {
                const tempD = new Date(d.getFullYear(), d.getMonth() - i, 1); const mStr = `${tempD.getFullYear()}${String(tempD.getMonth()+1).padStart(2,'0')}`;
                labels.push(`${tempD.getMonth()+1}æœˆ`);
                const sum = GLOBAL_DATA.wallet.data.filter(r => String(r.month).trim() === mStr).reduce((acc, curr) => acc + parseMoney(curr.amount), 0);
                data.push(sum);
            }
            this.chart = new Chart(ctx, { type: 'bar', data: { labels: labels, datasets: [{ label: 'ç¸½æ”¯å‡º', data: data, backgroundColor: 'rgba(255, 255, 255, 0.8)', borderRadius: 4 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, tooltip: { callbacks: { label: (c) => '$' + c.parsed.y.toLocaleString() } } }, scales: { x: { ticks: { color: 'white' }, grid: { display: false } }, y: { ticks: { color: 'white' }, grid: { color: 'rgba(255,255,255,0.1)' } } } } });
        }
    },
    submit: function() { const bank = document.getElementById('w-bank').value; const amt = document.getElementById('w-amount').value; const note = document.getElementById('w-note').value; const month = document.getElementById('w-input-month').value; if(bank=="é¸æ“‡éŠ€è¡Œ" || !amt) return showToast('âš ï¸ è«‹å¡«å¯«å®Œæ•´'); const isDup = GLOBAL_DATA.wallet.data.some(r => r.bank === bank && String(r.month).trim() === month); if(isDup) customConfirm('æ­¤éŠ€è¡Œæœ¬æœˆå·²æœ‰ç´€éŒ„ï¼Œç¢ºå®šè¦æ–°å¢å—ï¼Ÿ', () => this.executeSubmit(bank, amt, note, month)); else this.executeSubmit(bank, amt, note, month); },
    executeSubmit: function(bank, amt, note, month) { const tpl = GLOBAL_DATA.wallet.templates.find(t=>t.bankname===bank); GLOBAL_DATA.wallet.data.unshift({bank, amount:amt, note, month, uuid: 'temp', paymentdate: tpl?tpl.paymentdate:'-'}); document.getElementById('w-list-month').value = month; this.render(); document.getElementById('w-amount').value=''; document.getElementById('w-note').value=''; setBtnLoading('w-submit', true, 'æ’ç¨‹ä¸­...'); setTimeout(() => setBtnLoading('w-submit', false), 500); SyncManager.add({ appName:'wallet', action:'post', bank, amount:amt, note, month, paymentDate: tpl?tpl.paymentdate:'-' }); },
    askDelete: function(uuid, bank) { if(activeSwipeEl) closeSwipe(activeSwipeEl); document.getElementById('actionTitle').innerText = bank; const rec = GLOBAL_DATA.wallet.data.find(r => r.uuid === uuid); document.getElementById('actionSubtitle').innerText = rec ? `å·²ç™»éŒ„ï¼š$${formatMoney(rec.amount)}` : ''; document.getElementById('btnActionEdit').onclick = () => { this.fill(bank); if(rec) { document.getElementById('w-amount').value = rec.amount; document.getElementById('w-note').value = rec.note; } closeModal('actionModal'); }; document.getElementById('btnActionDelete').onclick = () => { closeModal('actionModal'); customConfirm(`ç¢ºå®šè¦åˆªé™¤ ${bank} çš„ç´€éŒ„å—ï¼Ÿ`, () => { if(uuid === 'temp') GLOBAL_DATA.wallet.data = GLOBAL_DATA.wallet.data.filter(r => r.bank !== bank); else GLOBAL_DATA.wallet.data = GLOBAL_DATA.wallet.data.filter(r => r.uuid !== uuid); this.render(); SyncManager.add({ appName:'wallet', action:'delete', uuid }); }); }; openModal('actionModal'); },
    fill: function(bank) { document.getElementById('w-bank').value = bank; document.getElementById('w-amount').focus(); document.querySelector('.input-panel').scrollIntoView({behavior:'smooth'}); }
};

// --- Crypto Logic ---
const CryptoApp = {
    mode: 'twd',
    render: function() {
        const fragList = document.createDocumentFragment(); const data = GLOBAL_DATA.crypto.data.sort((a,b) => new Date(b.date) - new Date(a.date)); const methods = GLOBAL_DATA.crypto.methods; const rate = GLOBAL_DATA.crypto.rate; const sel = document.getElementById('c-method');
        if(!document.getElementById('c-date').value) document.getElementById('c-date').valueAsDate = new Date();
        if(sel.options.length <= 1) { let ops = ['<option disabled selected>é¸æ“‡ç®¡é“</option>']; if(methods) methods.forEach(m => ops.push(`<option value="${m}">${m}</option>`)); sel.innerHTML = ops.join(''); }
        const totalTwd = data.reduce((sum, r) => sum + parseMoney(r.cost_twd || r.cost), 0);
        document.getElementById('c-total-twd').innerText = `$${formatMoney(totalTwd)} TWD`; document.getElementById('c-total-usd').innerText = `â‰ˆ $${formatMoney(totalTwd/rate)} USD`;
        data.forEach(r => {
            let dateObj = new Date(r.date); let subInfo = dateObj.getFullYear() + '-' + String(dateObj.getMonth() + 1).padStart(2, '0') + '-' + String(dateObj.getDate()).padStart(2, '0');
            let rightSide = `<div class="t-amount">$${formatMoney(r.cost_twd || r.cost)}</div>`;
            if (r.type === 'USD') { const cost = parseMoney(r.cost_twd || r.cost); const amt = parseMoney(r.amount_usd); const calcRate = (amt > 0) ? (cost / amt).toFixed(2) : '0.00'; rightSide += `<div class="c-sub-value">â‰ˆ $${formatMoney(amt)} USD <span class="c-rate">(@${calcRate})</span></div>`; }
            let icon = r.type === 'USD' ? 'ğŸ‡ºğŸ‡¸' : 'ğŸª™';
            const container = document.createElement('div'); container.className = 'swipe-item-container';
            container.innerHTML = `<div class="swipe-bg-action" onclick="CryptoApp.askDelete('${r.uuid}')">åˆªé™¤</div><div class="t-card" onclick=""><div class="t-icon">${icon}</div><div class="t-content"><div class="t-bank">${r.method}</div><div style="font-size:12px;color:#888">${subInfo} ${r.note ? '- '+r.note : ''}</div></div><div>${rightSide}</div></div>`;
            fragList.appendChild(container);
        });
        document.getElementById('c-list').innerHTML = ''; document.getElementById('c-list').appendChild(fragList);
    },
    setMode: function(m) { this.mode = m; document.getElementById('seg-twd').className = m=='twd'?'segment-btn active':'segment-btn'; document.getElementById('seg-usd').className = m=='usd'?'segment-btn active':'segment-btn'; document.getElementById('c-usd-field').style.display = m=='usd'?'block':'none'; },
    submit: function() { const date = document.getElementById('c-date').value; const method = document.getElementById('c-method').value; const cost = document.getElementById('c-cost').value; const usd = document.getElementById('c-usd').value; const note = document.getElementById('c-note').value; if(method == "é¸æ“‡ç®¡é“" || !cost) return showToast('âš ï¸ è«‹å¡«å¯«å®Œæ•´'); if(this.mode === 'usd' && !usd) return showToast('âš ï¸ è«‹è¼¸å…¥å¤–å¹£é‡‘é¡'); const now = new Date(); const fullDate = new Date(date); fullDate.setHours(now.getHours(), now.getMinutes(), now.getSeconds()); const isoDate = fullDate.toISOString(); GLOBAL_DATA.crypto.data.unshift({ date: isoDate, method, cost_twd: cost, note, type: this.mode === 'usd' ? 'USD' : 'TWD', amount_usd: this.mode === 'usd' ? usd : 0, uuid: 'temp' }); this.render(); document.getElementById('c-cost').value = ''; document.getElementById('c-usd').value = ''; document.getElementById('c-note').value = ''; document.getElementById('c-cost').focus(); setBtnLoading('c-submit', true, 'æ’ç¨‹ä¸­...'); setTimeout(() => setBtnLoading('c-submit', false), 500); SyncManager.add({ appName: 'crypto', action: 'post', date: isoDate, method, cost, note, type: this.mode === 'usd' ? 'USD' : 'TWD', amount_usd: this.mode === 'usd' ? usd : 0 }); },
    askDelete: function(uuid) { if(activeSwipeEl) closeSwipe(activeSwipeEl); customConfirm('åˆªé™¤æ­¤ç´€éŒ„?', () => { GLOBAL_DATA.crypto.data = GLOBAL_DATA.crypto.data.filter(r => r.uuid !== uuid); this.render(); SyncManager.add({ appName: 'crypto', action: 'delete', uuid }); }); },
    openSettings: function() { this.renderSettingsList(); const rate = GLOBAL_DATA.crypto.rate || '--.--'; document.getElementById('cryptoSettingsRate').innerText = `ğŸ‡ºğŸ‡¸ 1 USD â‰ˆ ${rate} TWD`; document.getElementById('cryptoSettingsModal').classList.add('show'); },
    renderSettingsList: function() { const d = document.getElementById('cryptoMethodList'); d.innerHTML = ''; GLOBAL_DATA.crypto.methods.forEach(m => { const row = document.createElement('div'); row.className = 'setup-row'; row.innerHTML = `<div><div style="font-weight:700">${m}</div></div><button class="btn-setup-action" style="color:#EF4444;" onclick="CryptoApp.deleteMethod('${m}')">ğŸ—‘ï¸</button>`; d.appendChild(row); }); },
    addMethod: function() { const val = document.getElementById('newCryptoMethod').value; if(!val) return showToast('âš ï¸ è«‹è¼¸å…¥åç¨±'); setBtnLoading('btnAddCryptoMethod', true, 'æ–°å¢ä¸­...'); GLOBAL_DATA.crypto.methods.push(val); this.renderSettingsList(); this.render(); document.getElementById('newCryptoMethod').value = ''; CloudStatus.set('syncing'); fetch(API_URL, { method:'POST', mode:'no-cors', headers:{'Content-Type':'application/json'}, body:JSON.stringify({password:USER_PASSWORD, appName:'crypto', action:'config_add', methodName:val}) }).then(() => { setBtnLoading('btnAddCryptoMethod', false); CloudStatus.set('success'); DataLoader.load().then(() => CryptoApp.renderSettingsList()); }); },
    deleteMethod: function(name) { customConfirm(`åˆªé™¤ ${name}?`, () => { GLOBAL_DATA.crypto.methods = GLOBAL_DATA.crypto.methods.filter(m => m !== name); this.renderSettingsList(); this.render(); CloudStatus.set('syncing'); fetch(API_URL, { method:'POST', mode:'no-cors', headers:{'Content-Type':'application/json'}, body:JSON.stringify({password:USER_PASSWORD, appName:'crypto', action:'config_delete', methodName:name}) }).then(() => { CloudStatus.set('success'); DataLoader.load(); }); }); }
};

// --- Shared Logic ---
function saveBudget() { 
    const b = parseInt(document.getElementById('budgetInput').value) || 0;
    setBtnLoading('btnSaveBudget', true, 'å„²å­˜ä¸­...');
    GLOBAL_DATA.config.budget = b;
    WalletApp.render();
    CloudStatus.set('syncing');
    fetch(API_URL, {
        method:'POST', mode:'no-cors', headers:{'Content-Type':'application/json'},
        body:JSON.stringify({password:USER_PASSWORD, action:'config_update', key:'Budget', value:b})
    }).then(() => {
        setBtnLoading('btnSaveBudget', false);
        closeModal('settingsModal'); 
        CloudStatus.set('success');
    });
}
function openWalletSettings() { renderTemplateList(); document.getElementById('settingsModal').classList.add('show'); }
function openCryptoSettings() { CryptoApp.openSettings(); }
function closeModal(id) { document.getElementById(id).classList.remove('show'); }
function logout() { customConfirm('ç¢ºå®šç™»å‡º?', () => { localStorage.removeItem('myBillPass'); window.location.reload(true); }); }
function setBtnLoading(btnId, isLoading, text) { const btn = document.getElementById(btnId); const txtSpan = btn.querySelector('.btn-text'); if(isLoading) { btn.disabled = true; btn.classList.add('btn-loading'); if(txtSpan) { btn.dataset.orgText = txtSpan.innerText; txtSpan.innerText = text; } } else { btn.disabled = false; btn.classList.remove('btn-loading'); if(txtSpan && btn.dataset.orgText) { txtSpan.innerText = btn.dataset.orgText; } } }
function showToast(m) { const t=document.getElementById('toast'); t.innerText=m; t.className='show'; setTimeout(()=>t.className='', 2500); }
function manualReload() { if (SyncManager.isSyncing) { showToast("âš ï¸ é›²ç«¯åŒæ­¥ä¸­ï¼Œè«‹ç¨å¾Œå†åˆ·æ–°"); return; } CloudStatus.set('syncing', 'è³‡æ–™æ›´æ–°ä¸­...'); DataLoader.load(false, true); }
function customConfirm(msg, callback) { document.getElementById('confirmMsg').innerText = msg; const oldBtn = document.getElementById('confirmBtnAction'); const newBtn = oldBtn.cloneNode(true); oldBtn.parentNode.replaceChild(newBtn, oldBtn); newBtn.onclick = () => { closeModal('confirmModal'); callback(); }; openModal('confirmModal'); }
function customAlert(msg) { document.getElementById('alertMsg').innerText = msg; openModal('alertModal'); }
function openModal(id) { document.getElementById(id).classList.add('show'); }

// --- Template Logic ---
function addTemplate() { const b=document.getElementById('newBank').value, bill=document.getElementById('newBill').value, pay=document.getElementById('newPay').value; if(!b||!bill||!pay) return showToast('âš ï¸ è«‹å¡«å¯«å®Œæ•´'); document.getElementById('newBank').value=''; document.getElementById('newBill').value=''; document.getElementById('newPay').value=''; setBtnLoading('btnAddTemp', true, 'æ’ç¨‹ä¸­...'); CloudStatus.set('syncing'); fetch(API_URL, { method:'POST', mode:'no-cors', headers:{'Content-Type':'application/json'}, body:JSON.stringify({password:USER_PASSWORD, appName:'wallet', action:'template_create', BankName:b, BillDate:bill, PaymentDate:pay}) }).then(() => setTimeout(()=>{ DataLoader.load().then(() => { renderTemplateList(); setBtnLoading('btnAddTemp', false); CloudStatus.set('success'); }); },1000)); }
function saveTemplateEdit() { const idx = document.getElementById('editIndex').value; const bank = document.getElementById('editBankName').value; const bill = document.getElementById('editBill').value; const pay = document.getElementById('editPay').value; if(!bill || !pay) return showToast('âš ï¸ æ—¥æœŸä¸èƒ½ç‚ºç©º'); setBtnLoading('btnSaveEdit', true, 'å„²å­˜ä¸­...'); const target = GLOBAL_DATA.wallet.templates.find(t => t.templateindex == idx); if (target) { target.billdate = bill; target.paymentdate = pay; } WalletApp.render(); renderTemplateList(); CloudStatus.set('syncing'); fetch(API_URL, { method:'POST', mode:'no-cors', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ password: USER_PASSWORD, appName:'wallet', action: 'template_update', templateIndex: idx, BankName: bank, BillDate: bill, PaymentDate: pay }) }).then(() => { setTimeout(() => { closeModal('editTemplateModal'); setBtnLoading('btnSaveEdit', false); CloudStatus.set('success'); DataLoader.load(); }, 1000); }); }
function deleteTemplate(idx) { customConfirm('ç¢ºå®šåˆªé™¤æ­¤éŠ€è¡Œ?', () => { CloudStatus.set('syncing'); fetch(API_URL, { method:'POST', mode:'no-cors', headers:{'Content-Type':'application/json'}, body:JSON.stringify({password:USER_PASSWORD, appName:'wallet', action:'template_delete', templateIndex:idx}) }).then(()=>setTimeout(() => { DataLoader.load().then(() => renderTemplateList()); CloudStatus.set('success'); }, 1000)); }); }
function openEditTemplateModal(index, bank, bill, pay) { document.getElementById('editIndex').value = index; document.getElementById('editBankName').value = bank; document.getElementById('editBill').value = bill; document.getElementById('editPay').value = pay; openModal('editTemplateModal'); }
function renderTemplateList() { const d = document.getElementById('templateList'); d.innerHTML=''; const sorted = [...GLOBAL_DATA.wallet.templates].sort((a,b) => (parseInt(a.billdate)||0) - (parseInt(b.billdate)||0)); sorted.forEach(t => { const n = t.bankname; const b = t.billdate; const p = t.paymentdate; const row = document.createElement('div'); row.className='setup-row'; row.innerHTML = `<div><div style="font-weight:700">${n}</div><div style="font-size:12px;color:#888;">çµå¸³æ—¥ ${b} / æ‰£æ¬¾æ—¥ ${p}</div></div><div style="display:flex; gap:5px;"><button class="btn-setup-action" style="color:#4F46E5;" onclick="openEditTemplateModal(${t.templateindex}, '${n}', '${b}', '${p}')">âœ ç·¨è¼¯</button><button class="btn-setup-action" style="color:#EF4444;" onclick="deleteTemplate(${t.templateindex})">ğŸ—‘ï¸ åˆªé™¤</button></div>`; d.appendChild(row); }); }

// Core Functions
function mapNormalize(arr) { 
    if(!Array.isArray(arr)) return []; 
    return arr.map(obj => { 
        const newObj = {}; 
        for(let k in obj) { 
            const cleanKey = k.trim(); 
            const lowerKey = cleanKey.toLowerCase();
            const mappedKey = DATA_KEY_MAP[cleanKey] || DATA_KEY_MAP[lowerKey] || lowerKey; 
            newObj[mappedKey] = obj[k]; 
        } 
        return newObj; 
    }); 
}

function initMonthSelect(id) { 
    const s=document.getElementById(id); if (!s) return;
    const startD = new Date(); startD.setMonth(startD.getMonth() + 1);
    const frag = document.createDocumentFragment(); 
    for(let i=0; i<24; i++){ 
        const v=`${startD.getFullYear()}${String(startD.getMonth()+1).padStart(2,'0')}`; 
        const o=document.createElement('option'); o.value=v; o.text=`${startD.getFullYear()} / ${String(startD.getMonth()+1).padStart(2,'0')}`; 
        frag.appendChild(o); startD.setMonth(startD.getMonth()-1); 
    }
    s.appendChild(frag); const d=new Date(); s.value = `${d.getFullYear()}${String(d.getMonth()+1).padStart(2,'0')}`;
}
</script>
</body>
</html>
