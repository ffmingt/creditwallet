<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>My Wallet V7.1 (Pro)</title>
    <!-- å¼•å…¥ Chart.js ç”¨æ–¼åœ–è¡¨é¡¯ç¤º -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* --- æ ¸å¿ƒè®Šæ•¸èˆ‡é‡ç½® --- */
        :root { 
            --bg-color: #F3F4F6; 
            --card-bg: rgba(255, 255, 255, 0.9); 
            --primary-color: #667eea;
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            --text-main: #1F2937; 
            --text-sub: #6B7280; 
            --danger: #EF4444;
            --success: #10B981;
            --radius: 20px;
        }
        
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
            background-color: var(--bg-color); 
            color: var(--text-main); 
            margin: 0; 
            padding-bottom: 150px; 
            user-select: none;
            -webkit-user-select: none; 
        }

        /* --- é€šç”¨å‹•ç•« --- */
        @keyframes float { 0% { transform: translateY(0px); } 50% { transform: translateY(-6px); } 100% { transform: translateY(0px); } }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* --- ç™»å…¥é®ç½© --- */
        #loginOverlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(243, 244, 246, 0.98); backdrop-filter: blur(10px);
            z-index: 99999; display: flex; flex-direction: column; 
            justify-content: center; align-items: center; padding: 30px; transition: opacity 0.3s; 
        }
        .login-box { width: 100%; max-width: 320px; text-align: center; }
        .login-input { 
            width: 100%; padding: 15px; background: white; border: 2px solid transparent; border-radius: var(--radius); 
            font-size: 24px; text-align: center; outline: none; margin: 20px 0; 
            letter-spacing: 8px; font-weight: bold; box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            transition: all 0.3s;
        }
        .login-input:focus { border-color: var(--primary-color); transform: translateY(-2px); }

        /* --- ä¸»ä»‹é¢ --- */
        .hero { padding: 20px 24px; animation: fadeIn 0.5s ease; }
        .header-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .app-title { font-size: 26px; font-weight: 800; background: var(--primary-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .app-version { font-size: 12px; color: var(--text-sub); font-weight: 600; background: #E5E7EB; padding: 2px 6px; border-radius: 6px; vertical-align: middle; }

        .btn-icon { background: white; border: none; padding: 8px 12px; border-radius: 12px; font-size: 13px; font-weight: 600; color: var(--text-main); box-shadow: 0 2px 5px rgba(0,0,0,0.05); cursor: pointer; transition: 0.2s; }
        .btn-icon:active { transform: scale(0.95); }
        .btn-logout { color: var(--danger); }

        /* --- ç¸½è¦½å¡ç‰‡ (Glassmorphism) --- */
        .total-card { 
            background: var(--primary-gradient); 
            border-radius: 28px; padding: 30px 25px; color: white; 
            box-shadow: 0 20px 40px -10px rgba(102, 126, 234, 0.5); 
            position: relative; overflow: hidden; 
        }
        .total-card::before {
            content: ''; position: absolute; top: -50%; right: -20%; width: 200px; height: 200px;
            background: rgba(255,255,255,0.1); border-radius: 50%; pointer-events: none;
        }
        .card-label { font-size: 14px; opacity: 0.9; margin-bottom: 5px; font-weight: 500; }
        .total-amount { font-size: 46px; font-weight: 800; letter-spacing: -1px; text-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .spending-status { position: absolute; top: 30px; right: 25px; font-size: 45px; animation: float 3s ease-in-out infinite; filter: drop-shadow(0 4px 8px rgba(0,0,0,0.2)); }

        /* --- åœ–è¡¨å€ --- */
        .chart-container {
            margin: 20px 24px 0;
            background: white;
            border-radius: var(--radius);
            padding: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.03);
            display: none; /* é è¨­éš±è—ï¼Œæœ‰è³‡æ–™æ‰é¡¯ç¤º */
            animation: slideUp 0.4s ease;
        }
        .chart-wrapper { position: relative; height: 200px; width: 100%; display: flex; justify-content: center;}

        /* --- è¼¸å…¥å€ --- */
        .input-section { padding: 0 24px; margin-top: 20px; }
        .glass-panel { 
            background: var(--card-bg); backdrop-filter: blur(10px);
            border-radius: var(--radius); padding: 20px; 
            box-shadow: 0 10px 30px -5px rgba(0,0,0,0.05); border: 1px solid rgba(255,255,255,0.5);
        }
        
        .bill-month-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid #eee; }
        select.clean-select { border: none; background: transparent; font-size: 16px; font-weight: 700; color: var(--primary-color); outline: none; text-align: right; }

        .form-grid { display: grid; grid-template-columns: 1.5fr 1fr; gap: 12px; margin-bottom: 12px; }
        label { font-size: 12px; color: var(--text-sub); font-weight: 600; margin-bottom: 4px; display: block; margin-left: 4px; }
        
        .custom-input { width: 100%; background: #F9FAFB; border: 1px solid #E5E7EB; padding: 14px; border-radius: 14px; font-size: 16px; color: var(--text-main); outline: none; transition: 0.2s; -webkit-appearance: none; }
        .custom-input:focus { background: white; border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(102,126,234,0.1); }
        
        .btn-main { 
            width: 100%; background: var(--text-main); color: white; border: none; 
            padding: 16px; border-radius: 16px; font-size: 16px; font-weight: 600; 
            cursor: pointer; margin-top: 10px; box-shadow: 0 8px 20px rgba(0,0,0,0.15); 
            transition: transform 0.1s, opacity 0.2s; display: flex; justify-content: center; align-items: center; gap: 8px;
        }
        .btn-main:active { transform: scale(0.98); }
        .btn-main:disabled { opacity: 0.6; cursor: wait; }

        /* --- åˆ—è¡¨å€ --- */
        .list-section { padding: 30px 24px; }
        .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .section-title { font-size: 18px; font-weight: 800; }
        
        .transaction-item { 
            background: white; border-radius: 18px; padding: 16px; 
            margin-bottom: 12px; display: flex; align-items: center; gap: 15px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.03); transition: transform 0.2s;
            animation: slideUp 0.3s ease backwards;
            cursor: pointer; /* é»æ“Šå¯å¡«å…¥ */
            border: 1px solid transparent;
        }
        .transaction-item:active { transform: scale(0.98); background: #f9fafb; }
        
        /* æœªç™»éŒ„çš„æ¨£å¼ */
        .transaction-item.unlogged-item {
            background: #fff;
            border: 1px dashed #e5e7eb;
        }

        .t-icon { 
            width: 42px; height: 42px; border-radius: 14px; 
            background: #EEF2FF; color: var(--primary-color);
            display: flex; justify-content: center; align-items: center; 
            font-size: 18px; font-weight: 700; flex-shrink: 0;
        }
        .t-content { flex-grow: 1; }
        .t-title { font-size: 16px; font-weight: 700; color: var(--text-main); margin-bottom: 4px; }
        .t-meta { display: flex; gap: 8px; flex-wrap: wrap; }
        .badge { font-size: 11px; padding: 3px 8px; border-radius: 6px; font-weight: 600; }
        .badge.bill { background: #E0F2FE; color: #0284C7; }
        .badge.pay { background: #DCFCE7; color: #16A34A; }
        .t-note { font-size: 12px; color: var(--text-sub); width: 100%; margin-top: 4px; font-style: italic;}

        .t-amount-box { text-align: right; flex-shrink: 0; }
        .t-amount { font-size: 18px; font-weight: 800; color: var(--text-main); }
        
        /* æœªç™»éŒ„çš„ç´…æ¨™ */
        .status-badge-unlogged {
            font-size: 13px; color: #EF4444; background: #FEF2F2;
            padding: 6px 10px; border-radius: 8px; font-weight: 600; display: inline-block;
        }

        .btn-del-sm { background: none; border: none; color: #FDA4AF; font-size: 18px; padding: 0 0 0 10px; cursor: pointer; }

        /* --- Skeleton Loading --- */
        .skeleton { background: #E5E7EB; border-radius: 8px; animation: pulse 1.5s infinite; }
        .skeleton-text { height: 16px; margin-bottom: 6px; width: 60%; }
        @keyframes pulse { 0% { opacity: 0.6; } 50% { opacity: 1; } 100% { opacity: 0.6; } }

        /* --- Toast Notification --- */
        #toast {
            visibility: hidden; min-width: 250px; background-color: #333; color: #fff; text-align: center;
            border-radius: 50px; padding: 12px 20px; position: fixed; z-index: 99999; left: 50%; bottom: 30px;
            transform: translateX(-50%); font-size: 14px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); opacity: 0; transition: opacity 0.3s, bottom 0.3s;
        }
        #toast.show { visibility: visible; opacity: 1; bottom: 50px; }

        /* --- Overdue Alert --- */
        .alert-box {
            background: #FEF2F2; border: 1px solid #FEE2E2; color: #991B1B; padding: 15px; 
            border-radius: 16px; margin-bottom: 20px; display: flex; align-items: flex-start; gap: 10px;
            font-size: 14px; line-height: 1.5;
        }

        /* --- Modal Styles --- */
        .modal-overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.6); backdrop-filter: blur(2px); z-index: 10000; 
            display: none; justify-content: center; align-items: center; 
        }
        .modal-overlay.show { display: flex; animation: fadeIn 0.2s; }
        .modal-box { 
            background: white; width: 85%; max-width: 400px; border-radius: 24px; padding: 25px; 
            box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25); transform: scale(0.95); transition: 0.2s;
            max-height: 85vh; overflow-y: auto;
        }
        .modal-overlay.show .modal-box { transform: scale(1); }
        .modal-header { font-size: 20px; font-weight: 800; margin-bottom: 20px; color: var(--text-main); }
        .modal-actions { margin-top: 25px; display: flex; justify-content: flex-end; gap: 10px; }
        .m-btn { padding: 10px 20px; border-radius: 12px; border: none; font-weight: 600; cursor: pointer; }
        .m-btn.primary { background: var(--text-main); color: white; }
        .m-btn.secondary { background: #F3F4F6; color: var(--text-main); }
        
        /* è¨­å®šé¢æ¿åˆ—è¡¨ */
        .setup-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid #f3f4f6; }
        .setup-info { font-size: 14px; color: var(--text-sub); margin-top: 2px; }
    </style>
</head>
<body>

    <!-- ç™»å…¥å±¤ -->
    <div id="loginOverlay">
        <div class="login-box">
            <div style="font-size: 40px; margin-bottom: 10px;">ğŸ”’</div>
            <div class="app-title" style="font-size: 22px; margin-bottom: 5px;">Welcome Back</div>
            <div style="color:#888; font-size:14px;">è«‹è¼¸å…¥å¯†ç¢¼ä»¥è§£é–</div>
            <input type="password" id="passwordInput" class="login-input" placeholder="â€¢â€¢â€¢â€¢" maxlength="8" inputmode="numeric">
            <button id="loginBtn" class="btn-main" onclick="verifyLogin()">è§£é–é€²å…¥</button>
            <div id="loginError" style="color: var(--danger); margin-top: 15px; font-size: 13px; min-height: 20px;"></div>
        </div>
    </div>

    <!-- é€šç”¨æ¨¡æ…‹è¦–çª— -->
    <div id="customModal" class="modal-overlay">
        <div class="modal-box">
            <div id="modalTitle" class="modal-header">æ¨™é¡Œ</div>
            <div id="modalMessage" style="line-height:1.6; color: #4B5563;">å…§å®¹</div>
            <div class="modal-actions" id="modalActions"></div>
        </div>
    </div>

    <!-- è¨­å®šæ¨¡æ…‹è¦–çª— -->
    <div id="settingsModal" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-header">éŠ€è¡Œ/å¡åˆ¥è¨­å®š</div>
            
            <div class="glass-panel" style="padding: 15px; background: #F9FAFB; box-shadow: none; border: 1px solid #E5E7EB; margin-bottom: 20px;">
                <label>æ–°å¢éŠ€è¡Œ</label>
                <input type="text" id="newTemplateBank" class="custom-input" style="margin-bottom: 10px; background:white;" placeholder="ä¾‹å¦‚ï¼šä¸­ä¿¡ LinePay">
                <div class="form-grid">
                    <div><label>çµå¸³æ—¥</label><input type="number" id="newTemplateBillDate" class="custom-input" style="background:white;" placeholder="æ—¥"></div>
                    <div><label>æ‰£æ¬¾æ—¥</label><input type="number" id="newTemplatePaymentDate" class="custom-input" style="background:white;" placeholder="æ—¥"></div>
                </div>
                <button class="btn-main" style="padding: 10px; font-size: 14px;" onclick="addTemplate()">ï¼‹ æ–°å¢</button>
            </div>
            
            <div style="font-weight:700; font-size: 14px; margin-bottom: 10px; color: var(--text-sub);">å·²å„²å­˜åˆ—è¡¨</div>
            <div id="templateList"></div>
            <div class="modal-actions">
                <button class="m-btn secondary" onclick="closeSettingsModal()">é—œé–‰</button>
            </div>
        </div>
    </div>
    
    <!-- ç·¨è¼¯æ¨¡æ…‹è¦–çª— -->
    <div id="editTemplateModal" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-header">ç·¨è¼¯éŠ€è¡Œ</div>
            <input type="hidden" id="editTemplateIndex">
            <label>éŠ€è¡Œåç¨±</label>
            <input type="text" id="editTemplateBank" class="custom-input" style="margin-bottom: 15px;">
            <div class="form-grid">
                <div><label>çµå¸³æ—¥</label><input type="number" id="editTemplateBillDate" class="custom-input"></div>
                <div><label>æ‰£æ¬¾æ—¥</label><input type="number" id="editTemplatePaymentDate" class="custom-input"></div>
            </div>
            <div class="modal-actions">
                <button class="m-btn secondary" onclick="closeEditModal()">å–æ¶ˆ</button>
                <button class="m-btn primary" id="saveEditBtn" onclick="saveTemplateEdit()">å„²å­˜</button>
            </div>
        </div>
    </div>

    <!-- ä¸»ç•«é¢ -->
    <div class="hero">
        <div class="header-row">
            <div>
                <span class="app-title">My Wallet</span> 
                <span class="app-version">V7.1</span>
            </div>
            <div style="display:flex; gap:8px;">
                <button class="btn-icon" onclick="openSettingsModal()">âš™ï¸ è¨­å®š</button>
                <button class="btn-icon btn-logout" onclick="logout()">ç™»å‡º</button>
            </div>
        </div>

        <div class="total-card">
            <div class="card-label">æœ¬æœˆç¸½æ”¯å‡º</div>
            <div class="total-amount" id="totalAmount">$0</div>
            <div class="card-label" style="margin-top: 5px; font-size: 12px; opacity: 0.7;" id="countLabel">0 ç­†ç´€éŒ„</div>
            <span id="spendingStatus" class="spending-status">ğŸ˜Š</span>
        </div>
    </div>

    <!-- åœ–è¡¨å€ -->
    <div class="chart-container" id="chartContainer">
        <div class="chart-wrapper">
            <canvas id="expenseChart"></canvas>
        </div>
    </div>

    <div class="input-section">
        <div class="glass-panel">
            <div class="bill-month-row">
                <span style="font-weight:600; color:var(--text-sub);">è¨˜å¸³æœˆä»½</span>
                <select id="billMonthInput" class="clean-select"></select>
            </div>

            <div class="form-grid" style="grid-template-columns: 2fr 1.5fr;">
                <div>
                    <label>é¸æ“‡éŠ€è¡Œ</label>
                    <select id="bankSelector" class="custom-input" style="padding: 14px 10px;"></select>
                </div>
                <div>
                    <label>é‡‘é¡</label>
                    <input type="number" id="amount" class="custom-input" inputmode="decimal" placeholder="$0">
                </div>
            </div>

            <div>
                <label>å‚™è¨» (é¸å¡«)</label>
                <input type="text" id="note" class="custom-input" placeholder="æ¶ˆè²»é …ç›®...">
            </div>

            <button class="btn-main" id="submitBtn" onclick="submitData()">
                <span>ï¼‹</span> ç¢ºèªè¨˜å¸³
            </button>
        </div>
    </div>

    <div class="list-section">
        <div class="section-header">
            <div class="section-title">å¸³å–®æ˜ç´°</div>
            <div style="display:flex; align-items:center; gap: 10px;">
                <select id="monthSelector" class="clean-select" style="font-size: 14px; color: var(--text-main);" onchange="filterData()"></select>
                <button onclick="loadData()" style="background:white; border:none; border-radius:50%; width:30px; height:30px; box-shadow:0 2px 5px rgba(0,0,0,0.1); cursor:pointer;">â†»</button>
            </div>
        </div>

        <div id="alertContainer"></div>
        <div id="listContainer"></div>
    </div>

    <!-- Toast é€šçŸ¥ -->
    <div id="toast">æç¤ºè¨Šæ¯</div>

<script>
    // ==========================================
    // ğŸ”´ è«‹æ›¿æ›ç‚ºä½ çš„ Google Apps Script ç¶²å€
    const API_URL = "https://script.google.com/macros/s/AKfycby60jdswu4PguQ0YNMpYdfdOewU-YscwRvOpcVxZhV7KNpwhVzSO7tJ8vNx1fPmw_tjGw/exec";
    // ==========================================

    let allData = []; 
    let allTemplates = []; 
    let USER_PASSWORD = "";
    let expenseChart = null; // Chart instance

    const TEMPLATE_KEYS = { BANK: 'éŠ€è¡Œåç¨±', BILL_DATE: 'çµå¸³æ—¥', PAYMENT_DATE: 'æ‰£æ¬¾æ—¥' };

    // åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', () => {
        const savedPass = localStorage.getItem('myBillAppPassword');
        initMonthDropdown('monthSelector'); 
        initMonthDropdown('billMonthInput');
        setDefaultInputMonth();

        // è‡ªå‹•èšç„¦
        document.getElementById('passwordInput').addEventListener('input', (e) => {
            if(e.target.value.length === 8) verifyLogin();
        });

        if(savedPass) {
            document.getElementById('passwordInput').value = savedPass;
            verifyLogin(true); 
        }
    });

    // Toast é€šçŸ¥åŠŸèƒ½
    function showToast(message) {
        const toast = document.getElementById("toast");
        toast.className = "show";
        toast.innerText = message;
        setTimeout(() => { toast.className = toast.className.replace("show", ""); }, 3000);
    }

    // æ ¸å¿ƒè³‡æ–™è®€å–
    async function loadData(isInitialLogin = false) {
        const container = document.getElementById('listContainer');
        const loginBtn = document.getElementById('loginBtn');

        if (!isInitialLogin) {
            container.innerHTML = `
                <div class="transaction-item"><div class="skeleton" style="width:40px; height:40px;"></div><div style="flex:1"><div class="skeleton skeleton-text"></div><div class="skeleton skeleton-text" style="width:40%"></div></div></div>
                <div class="transaction-item"><div class="skeleton" style="width:40px; height:40px;"></div><div style="flex:1"><div class="skeleton skeleton-text"></div><div class="skeleton skeleton-text" style="width:40%"></div></div></div>
            `;
        }

        try {
            const res = await fetch(`${API_URL}?password=${encodeURIComponent(USER_PASSWORD)}`);
            const data = await res.json();

            if(data.error) throw new Error(data.error);

            localStorage.setItem('myBillAppPassword', USER_PASSWORD);

            if (isInitialLogin) {
                const overlay = document.getElementById('loginOverlay');
                overlay.style.opacity = '0';
                setTimeout(() => { overlay.style.display = 'none'; }, 300);
            }

            allData = normalizeKeys(data.data).reverse();
            allTemplates = normalizeKeys(data.templates);

            updateTemplateSelector();
            filterData();

            loginBtn.disabled = false; 
            loginBtn.innerText = 'è§£é–é€²å…¥';

        } catch(err) {
            console.error(err);
            if(isInitialLogin) {
                loginBtn.disabled = false;
                loginBtn.innerText = 'è§£é–é€²å…¥';
                document.getElementById('loginError').textContent = err.message.includes("å¯†ç¢¼") ? 'âŒ å¯†ç¢¼éŒ¯èª¤' : 'âš ï¸ é€£ç·šå¤±æ•—';
                if(err.message.includes("å¯†ç¢¼")) localStorage.removeItem('myBillAppPassword');
            } else {
                container.innerHTML = '<div style="text-align:center; padding:20px; color:var(--text-sub);">âš ï¸ è¼‰å…¥å¤±æ•—ï¼Œè«‹é‡è©¦</div>';
            }
        }
    }

    // è³‡æ–™ç¯©é¸èˆ‡æ¸²æŸ“ (åŒ…å«åœ–è¡¨ + æœªç™»éŒ„é‚è¼¯)
    function filterData() {
        const selectedMonth = document.getElementById('monthSelector').value;
        const listContainer = document.getElementById('listContainer');
        const chartContainer = document.getElementById('chartContainer');

        if (allTemplates.length === 0) {
            listContainer.innerHTML = '<div style="text-align:center; padding:40px; color:#999;">å°šæœªè¨­å®šéŠ€è¡Œï¼Œè«‹é»é¸å³ä¸Šè§’è¨­å®š</div>';
            updateTotalDisplay(0, 0);
            chartContainer.style.display = 'none';
            return;
        }

        // 1. æ’åºæ¨¡æ¿
        const sortedTemplates = [...allTemplates].sort((a, b) => {
            return (parseInt(getCleanValue(a, TEMPLATE_KEYS.BILL_DATE)) || 0) - (parseInt(getCleanValue(b, TEMPLATE_KEYS.BILL_DATE)) || 0);
        });

        const currentMonthData = allData.filter(item => String(item.month).trim() === selectedMonth);
        
        let totalAmount = 0;
        let loggedCount = 0;
        let html = '';
        let chartLabels = [];
        let chartData = [];
        let chartColors = [];

        // 2. è¿­ä»£æ¨¡æ¿
        sortedTemplates.forEach(template => {
            const bankName = getCleanValue(template, TEMPLATE_KEYS.BANK);
            const billDate = getCleanValue(template, TEMPLATE_KEYS.BILL_DATE);
            const paymentDate = getCleanValue(template, TEMPLATE_KEYS.PAYMENT_DATE);
            
            const matchingRecord = currentMonthData.find(r => r.bank === bankName);
            const firstChar = bankName.charAt(0);

            let rightContent = '';
            let itemClass = 'transaction-item';
            let clickAction = '';

            if (matchingRecord) {
                // å·²ç™»éŒ„
                const amount = Number(matchingRecord.amount);
                totalAmount += amount;
                loggedCount++;
                
                rightContent = `
                    <div class="t-amount-box">
                        <div class="t-amount">$${amount.toLocaleString()}</div>
                    </div>
                    <button class="btn-del-sm" onclick="event.stopPropagation(); deleteRecord(${matchingRecord.rowIndex})">Ã—</button>
                `;
                
                chartLabels.push(bankName);
                chartData.push(amount);
                chartColors.push(stringToColor(bankName));
                
                // é»æ“Šå¯å¸¶å…¥è³‡æ–™
                clickAction = `fillInput('${bankName}', '${amount}', '${matchingRecord.note || ''}')`;

            } else {
                // æœªç™»éŒ„
                itemClass += ' unlogged-item';
                rightContent = `
                    <div class="t-amount-box">
                        <span class="status-badge-unlogged">âš ï¸ å°šæœªç™»éŒ„</span>
                    </div>
                `;
                // é»æ“Šè‡ªå‹•é¸å–éŠ€è¡Œ
                clickAction = `fillInput('${bankName}', '', '')`;
            }

            html += `
                <div class="${itemClass}" onclick="${clickAction}" title="é»æ“Šå¯å¿«é€Ÿè¨˜å¸³">
                    <div class="t-icon">${firstChar}</div>
                    <div class="t-content">
                        <div class="t-title">${bankName}</div>
                        <div class="t-meta">
                            <span class="badge bill">çµ ${billDate}</span>
                            <span class="badge pay">æ‰£ ${paymentDate}</span>
                        </div>
                        ${matchingRecord && matchingRecord.note ? `<div class="t-note">â€œ${matchingRecord.note}â€</div>` : ''}
                    </div>
                    ${rightContent}
                </div>
            `;
        });

        listContainer.innerHTML = html;
        updateTotalDisplay(totalAmount, loggedCount);
        checkOverdue(selectedMonth);

        // æ¸²æŸ“åœ–è¡¨
        if (totalAmount > 0) {
            chartContainer.style.display = 'block';
            renderChart(chartLabels, chartData, chartColors);
        } else {
            chartContainer.style.display = 'none';
        }
    }

    // é»æ“Šåˆ—è¡¨å¡«å…¥è¼¸å…¥æ¡†
    function fillInput(bank, amount, note) {
        const bankSelect = document.getElementById('bankSelector');
        const amountInput = document.getElementById('amount');
        const noteInput = document.getElementById('note');
        
        bankSelect.value = bank;
        amountInput.value = amount;
        noteInput.value = note;
        
        // æ»‘å‹•åˆ°è¼¸å…¥å€
        document.querySelector('.input-section').scrollIntoView({ behavior: 'smooth' });
        // è‹¥ç„¡é‡‘é¡å‰‡èšç„¦
        if(!amount) amountInput.focus();
    }

    // æ¸²æŸ“ Chart.js
    function renderChart(labels, data, colors) {
        const ctx = document.getElementById('expenseChart').getContext('2d');
        if (expenseChart) expenseChart.destroy();

        expenseChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: labels,
                datasets: [{
                    data: data,
                    backgroundColor: colors,
                    borderWidth: 0,
                    hoverOffset: 10
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                cutout: '70%',
                plugins: {
                    legend: { display: false },
                    tooltip: { callbacks: { label: (ctx) => ' $' + ctx.parsed.toLocaleString() } }
                }
            }
        });
    }

    // é€å‡ºè³‡æ–™
    function submitData() {
        const bank = document.getElementById('bankSelector').value;
        const amount = document.getElementById('amount').value;
        const note = document.getElementById('note').value;
        const targetMonth = document.getElementById('billMonthInput').value;

        if(!bank || !amount) { showCustomAlert('è«‹é¸æ“‡éŠ€è¡Œä¸¦è¼¸å…¥é‡‘é¡', 'ç¼ºå°‘è³‡æ–™'); return; }
        
        // æª¢æŸ¥é‡è¤‡
        const isUpdate = allData.some(r => r.bank === bank && String(r.month).trim() === targetMonth);
        // è‹¥æ˜¯è¦†è“‹æ¨¡å¼(å› ç‚ºé»æ“Šäº†åˆ—è¡¨)ï¼Œé€™è£¡å¯ä»¥æ”¾å¯¬æª¢æŸ¥ï¼Œæˆ–æç¤ºè¦†è“‹ã€‚
        // é€™é‚Šç°¡åŒ–é‚è¼¯ï¼šå¦‚æœæ˜¯é‡è¤‡ï¼Œé¡¯ç¤ºæç¤ºï¼Œä½†å¦‚æœæ˜¯é€é fillInput ä¿®æ”¹ï¼Œå»ºè­°åˆªé™¤èˆŠçš„å†æ–°å¢è¼ƒç‚ºå®‰å…¨(å›  Google Sheet row index å•é¡Œ)ã€‚
        // ç‚ºäº†å®‰å…¨èµ·è¦‹ï¼Œé€™è£¡ç¶­æŒé‡è¤‡æª¢æŸ¥ã€‚è‹¥è¦ä¿®æ”¹ï¼Œè«‹å…ˆé»æ“Šåˆªé™¤èˆŠç´€éŒ„ã€‚
        if (isUpdate) {
            // å¦‚æœæ˜¯ä¿®æ”¹ï¼Œå…ˆä¸æ“‹ï¼Œäº¤ç”±å¾Œç«¯è™•ç†æˆ–æç¤ºä½¿ç”¨è€…åˆªé™¤ã€‚
            // ç‚ºäº†é«”é©—ï¼Œé€™è£¡åªæ˜¯ä¸€å€‹ç°¡å–®æç¤ºã€‚
            const proceed = confirm('æ­¤éŠ€è¡Œæœ¬æœˆå·²æœ‰ç´€éŒ„ï¼Œç¢ºå®šè¦æ–°å¢ä¸€ç­†(å¯èƒ½é€ æˆé‡è¤‡)å—ï¼Ÿ\nè‹¥è¦ä¿®æ”¹é‡‘é¡ï¼Œå»ºè­°å…ˆåˆªé™¤èˆŠç´€éŒ„ã€‚');
            if(!proceed) return;
        }

        const template = allTemplates.find(t => getCleanValue(t, TEMPLATE_KEYS.BANK) === bank);
        const paymentDate = template ? getCleanValue(template, TEMPLATE_KEYS.PAYMENT_DATE) : '-';

        const btn = document.getElementById('submitBtn');
        const originalText = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = 'ğŸš€ è™•ç†ä¸­...';

        const payload = { password: USER_PASSWORD, action: 'post', bank, amount: Number(amount), note, paymentDate, month: targetMonth };

        fetch(API_URL, {
            method: 'POST', mode: 'no-cors',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        }).then(() => {
            setTimeout(() => {
                showToast('âœ… è¨˜å¸³æˆåŠŸ');
                document.getElementById('monthSelector').value = targetMonth; 
                loadData();
                btn.disabled = false;
                btn.innerHTML = originalText;
                document.getElementById('amount').value = '';
                document.getElementById('note').value = '';
            }, 800);
        }).catch(() => {
            showCustomAlert('é€£ç·šç•°å¸¸ï¼Œè«‹æª¢æŸ¥ç¶²è·¯', 'éŒ¯èª¤');
            btn.disabled = false;
            btn.innerHTML = originalText;
        });
    }

    // åˆªé™¤è³‡æ–™
    function deleteRecord(rowIndex) {
        showCustomConfirmation('ç¢ºå®šåˆªé™¤é€™ç­†ç´€éŒ„å—ï¼Ÿ', 'åˆªé™¤ç¢ºèª', () => {
            showToast('ğŸ—‘ï¸ æ­£åœ¨åˆªé™¤...');
            fetch(API_URL, {
                method: 'POST', mode: 'no-cors',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ password: USER_PASSWORD, action: 'delete', rowIndex })
            }).then(() => {
                setTimeout(loadData, 800);
            });
        });
    }

    // --- è¼”åŠ©åŠŸèƒ½ ---
    
    function updateTotalDisplay(total, count) {
        const el = document.getElementById('totalAmount');
        el.textContent = `$${total.toLocaleString()}`;
        document.getElementById('countLabel').textContent = `å·²ç™»éŒ„ ${count} ç­†`;
        
        const status = document.getElementById('spendingStatus');
        if(total > 20000) status.innerText = 'ğŸ’¸';
        else if(total > 10000) status.innerText = 'ğŸ˜±';
        else if(total > 5000) status.innerText = 'ğŸ¤”';
        else status.innerText = 'ğŸ˜Š';
    }

    function checkOverdue(yearMonth) {
        const today = new Date();
        const y = parseInt(yearMonth.substring(0, 4));
        const m = parseInt(yearMonth.substring(4, 6));
        let overdue = [];

        allTemplates.forEach(t => {
            const billDay = parseInt(getCleanValue(t, TEMPLATE_KEYS.BILL_DATE));
            if(!billDay) return;
            
            const cutoff = new Date(y, m - 1, billDay + 1);
            const bankName = getCleanValue(t, TEMPLATE_KEYS.BANK);
            const isLogged = allData.some(r => r.bank === bankName && String(r.month).trim() === yearMonth);

            if (today >= cutoff && !isLogged) overdue.push(bankName);
        });

        const container = document.getElementById('alertContainer');
        if(overdue.length > 0) {
            container.innerHTML = `
                <div class="alert-box">
                    <span style="font-size:20px">âš ï¸</span>
                    <div>
                        <strong>é€¾æœŸæé†’</strong><br>
                        ${overdue.join('ã€')} å°šæœªç™»éŒ„å¸³å–®ï¼Œè«‹ç›¡å¿«ç¢ºèªã€‚
                    </div>
                </div>`;
        } else {
            container.innerHTML = '';
        }
    }

    // è¨­å®šç›¸é—œ
    function updateTemplateSelector() {
        const select = document.getElementById('bankSelector');
        select.innerHTML = '<option value="" disabled selected>è«‹é¸æ“‡éŠ€è¡Œ</option>';
        
        if (allTemplates.length === 0) return;
        
        const sorted = [...allTemplates].sort((a,b) => 
             (parseInt(getCleanValue(a, TEMPLATE_KEYS.BILL_DATE))||0) - (parseInt(getCleanValue(b, TEMPLATE_KEYS.BILL_DATE))||0)
        );
        
        sorted.forEach(t => {
            const name = getCleanValue(t, TEMPLATE_KEYS.BANK);
            const opt = document.createElement('option');
            opt.value = name; opt.text = name;
            select.appendChild(opt);
        });
    }

    function addTemplate() {
        const bank = document.getElementById('newTemplateBank').value.trim();
        const bill = document.getElementById('newTemplateBillDate').value;
        const pay = document.getElementById('newTemplatePaymentDate').value;
        if(!bank || !bill || !pay) return showCustomAlert('è«‹å¡«å¯«å®Œæ•´', 'éŒ¯èª¤');
        
        simplePost({ action: 'template_create', BankName: bank, BillDate: bill, PaymentDate: pay }, 'æ–°å¢');
    }

    function saveTemplateEdit() {
        const idx = document.getElementById('editTemplateIndex').value;
        const bank = document.getElementById('editTemplateBank').value;
        const bill = document.getElementById('editTemplateBillDate').value;
        const pay = document.getElementById('editTemplatePaymentDate').value;
        
        simplePost({ action: 'template_update', templateIndex: idx, BankName: bank, BillDate: bill, PaymentDate: pay }, 'ä¿®æ”¹');
        closeEditModal();
    }
    
    function deleteTemplate(idx) {
        showCustomConfirmation('åˆªé™¤æ­¤éŠ€è¡Œæ¨¡æ¿ï¼Ÿ', 'ç¢ºèª', () => {
            simplePost({ action: 'template_delete', templateIndex: idx }, 'åˆªé™¤');
        });
    }

    function simplePost(data, actionName) {
        const fullData = { password: USER_PASSWORD, ...data };
        showToast(`â³ ${actionName}ä¸­...`);
        fetch(API_URL, {
            method: 'POST', mode: 'no-cors', headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(fullData)
        }).then(() => {
            setTimeout(() => {
                loadData();
                document.getElementById('newTemplateBank').value = '';
                document.getElementById('newTemplateBillDate').value = '';
                document.getElementById('newTemplatePaymentDate').value = '';
                showToast(`âœ… ${actionName}å®Œæˆ`);
            }, 1000);
        });
    }
    
    // æ¸²æŸ“è¨­å®šåˆ—è¡¨
    function renderTemplateList() {
        const div = document.getElementById('templateList');
        div.innerHTML = '';
        allTemplates.forEach(t => {
            const bank = getCleanValue(t, TEMPLATE_KEYS.BANK);
            const row = document.createElement('div');
            row.className = 'setup-item';
            row.innerHTML = `
                <div>
                    <div style="font-weight:600">${bank}</div>
                    <div class="setup-info">çµå¸³ ${getCleanValue(t, TEMPLATE_KEYS.BILL_DATE)} / æ‰£æ¬¾ ${getCleanValue(t, TEMPLATE_KEYS.PAYMENT_DATE)}</div>
                </div>
                <div style="display:flex; gap:10px;">
                    <button class="btn-icon" onclick="openEditModal(${t.templateIndex}, '${bank}', '${getCleanValue(t, TEMPLATE_KEYS.BILL_DATE)}', '${getCleanValue(t, TEMPLATE_KEYS.PAYMENT_DATE)}')">âœ</button>
                    <button class="btn-icon" style="color:#EF4444" onclick="deleteTemplate(${t.templateIndex})">Ã—</button>
                </div>
            `;
            div.appendChild(row);
        });
    }

    // æ¨¡æ…‹è¦–çª—æ§åˆ¶
    function openSettingsModal() { document.getElementById('settingsModal').classList.add('show'); renderTemplateList(); }
    function closeSettingsModal() { document.getElementById('settingsModal').classList.remove('show'); }
    function openEditModal(idx, bank, bill, pay) {
        document.getElementById('editTemplateIndex').value = idx;
        document.getElementById('editTemplateBank').value = bank;
        document.getElementById('editTemplateBillDate').value = bill;
        document.getElementById('editTemplatePaymentDate').value = pay;
        document.getElementById('editTemplateModal').classList.add('show');
    }
    function closeEditModal() { document.getElementById('editTemplateModal').classList.remove('show'); }

    // Utils
    function verifyLogin(isAuto=false) {
        USER_PASSWORD = document.getElementById('passwordInput').value;
        const btn = document.getElementById('loginBtn');
        if(!USER_PASSWORD) return;
        btn.disabled = true; btn.innerText = 'é©—è­‰ä¸­...';
        loadData(true);
    }
    function logout() {
        showCustomConfirmation('ç¢ºå®šè¦ç™»å‡ºå—ï¼Ÿ', 'ç™»å‡º', () => {
            localStorage.removeItem('myBillAppPassword');
            location.reload();
        });
    }
    function normalizeKeys(arr) {
        if (!Array.isArray(arr)) return [];
        return arr.map(obj => {
            const n = {};
            for (let k in obj) n[k.trim()] = obj[k];
            return n;
        });
    }
    function getCleanValue(t, k) {
        if (!t) return '-';
        if (t[k] != null) return t[k];
        const map = { [TEMPLATE_KEYS.BANK]: 'BankName', [TEMPLATE_KEYS.BILL_DATE]: 'BillDate', [TEMPLATE_KEYS.PAYMENT_DATE]: 'PaymentDate' };
        return t[map[k]] || '-';
    }
    
    function stringToColor(str) {
        let hash = 0;
        for (let i = 0; i < str.length; i++) hash = str.charCodeAt(i) + ((hash << 5) - hash);
        const c = (hash & 0x00FFFFFF).toString(16).toUpperCase();
        return '#' + "00000".substring(0, 6 - c.length) + c;
    }

    function setDefaultInputMonth() {
        const d = new Date();
        const v = `${d.getFullYear()}${String(d.getMonth()+1).padStart(2,'0')}`;
        document.getElementById('billMonthInput').value = v;
        document.getElementById('monthSelector').value = v;
    }
    function initMonthDropdown(id) {
        const s = document.getElementById(id);
        const d = new Date();
        d.setMonth(d.getMonth()+1);
        for(let i=0; i<24; i++) {
            const v = `${d.getFullYear()}${String(d.getMonth()+1).padStart(2,'0')}`;
            const opt = document.createElement('option');
            opt.value = v; opt.text = `${d.getFullYear()} / ${String(d.getMonth()+1).padStart(2,'0')}`;
            s.appendChild(opt);
            d.setMonth(d.getMonth()-1);
        }
    }

    function showCustomAlert(msg, title) {
        document.getElementById('modalTitle').innerText = title;
        document.getElementById('modalMessage').innerText = msg;
        document.getElementById('modalActions').innerHTML = `<button class="m-btn primary" onclick="document.getElementById('customModal').classList.remove('show')">ç¢ºå®š</button>`;
        document.getElementById('customModal').classList.add('show');
    }
    function showCustomConfirmation(msg, title, callback) {
        document.getElementById('modalTitle').innerText = title;
        document.getElementById('modalMessage').innerText = msg;
        const actions = document.getElementById('modalActions');
        actions.innerHTML = '';
        const cancel = document.createElement('button'); cancel.className = 'm-btn secondary'; cancel.innerText = 'å–æ¶ˆ';
        cancel.onclick = () => document.getElementById('customModal').classList.remove('show');
        const ok = document.createElement('button'); ok.className = 'm-btn primary'; ok.innerText = 'ç¢ºå®š';
        ok.onclick = () => { document.getElementById('customModal').classList.remove('show'); callback(); };
        actions.append(cancel, ok);
        document.getElementById('customModal').classList.add('show');
    }
</script>
</body>
</html>
